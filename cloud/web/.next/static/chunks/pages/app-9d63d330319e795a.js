(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[366],{9301:function(e,s,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/app",function(){return t(3193)}])},3193:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return h}});var n=t(5893),a=t(7294),l=t(9008),c=t.n(l),r=t(1163);function i(e){let{onCredentialsLoaded:s}=e,[t,l]=(0,a.useState)(!1),[c,r]=(0,a.useState)(""),[i,o]=(0,a.useState)(""),d=(0,a.useCallback)(e=>{var s;let t=null===(s=e.target.files)||void 0===s?void 0:s[0];if(!t)return;let n=new FileReader;n.onload=e=>{var s;u(null===(s=e.target)||void 0===s?void 0:s.result)},n.readAsText(t)},[]),m=(0,a.useCallback)(()=>{u(c)},[c]),u=e=>{if(!e.includes("-----BEGIN NATS USER JWT-----")){o("Invalid credentials file. Please upload a valid NATS .creds file.");return}localStorage.setItem("homix_creds",e),s(e)};return(0,n.jsx)("div",{className:"max-w-md mx-auto",children:(0,n.jsxs)("div",{className:"bg-white rounded-lg shadow-lg p-6",children:[(0,n.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"Connect to Synadia Cloud"}),(0,n.jsx)("p",{className:"text-gray-600 text-sm mb-6",children:"Upload your NATS credentials file to connect to your homes."}),i&&(0,n.jsx)("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4",children:i}),(0,n.jsxs)("div",{className:"space-y-4",children:[(0,n.jsx)("div",{children:(0,n.jsxs)("label",{className:"block",children:[(0,n.jsx)("span",{className:"sr-only",children:"Choose credentials file"}),(0,n.jsx)("input",{type:"file",accept:".creds",onChange:d,className:"block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"})]})}),(0,n.jsxs)("div",{className:"relative",children:[(0,n.jsx)("div",{className:"absolute inset-0 flex items-center",children:(0,n.jsx)("div",{className:"w-full border-t border-gray-300"})}),(0,n.jsx)("div",{className:"relative flex justify-center text-sm",children:(0,n.jsx)("span",{className:"px-2 bg-white text-gray-500",children:"or"})})]}),t?(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)("textarea",{value:c,onChange:e=>r(e.target.value),placeholder:"Paste your credentials here...",className:"w-full h-32 px-3 py-2 border border-gray-300 rounded-md text-sm font-mono"}),(0,n.jsx)("button",{onClick:m,disabled:!c,className:"w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",children:"Connect"})]}):(0,n.jsx)("button",{onClick:()=>l(!0),className:"w-full text-blue-600 hover:text-blue-700 text-sm",children:"Paste credentials manually"})]}),(0,n.jsxs)("div",{className:"mt-6 text-xs text-gray-500",children:[(0,n.jsx)("p",{children:"Don't have credentials yet?"}),(0,n.jsx)("a",{href:"https://app.ngs.global",target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:underline",children:"Sign up for Synadia Cloud â†’"})]})]})})}var o=t(6181);class d{async connect(e){try{let s=(0,o.Kj)(new TextEncoder().encode(e.credentials));this.nc=await (0,o.$j)({servers:e.wsUrl,authenticator:s,reconnect:!0,maxReconnectAttempts:-1,reconnectTimeWait:2e3,waitOnFirstConnect:!0}),console.log("Connected to NATS via WebSocket"),(async()=>{for await(let e of this.nc.status())console.log("NATS connection status: ".concat(e.type))})()}catch(e){throw console.error("Failed to connect to NATS:",e),e}}async disconnect(){for(let e of this.subscriptions.values())e.unsubscribe();this.subscriptions.clear(),this.nc&&(await this.nc.close(),this.nc=null)}isConnected(){return null!==this.nc&&!this.nc.isClosed()}async subscribeToHomes(e){if(!this.nc)throw Error("Not connected");let s=this.nc.subscribe("home.edge.announce");this.subscriptions.set("homes",s),(async()=>{for await(let t of s)try{let s=JSON.parse(this.sc.decode(t.data)),n={id:s.id||"default",name:s.name||"Unknown Home",location:s.location,connected:!0,lastSeen:new Date};e(n)}catch(e){console.error("Error processing home announcement:",e)}})()}async subscribeToDevices(e,s){if(!this.nc)throw Error("Not connected");let t=this.nc.subscribe("home.devices.*.state");this.subscriptions.set("devices-".concat(e),t),(async()=>{for await(let n of t)try{let t=JSON.parse(this.sc.decode(n.data)),a=n.subject.split(".")[2],l={id:a,name:t.name||a,type:t.type||"unknown",state:t.state||t,homeId:e,lastUpdate:new Date};s(l)}catch(e){console.error("Error processing device update:",e)}})()}async sendCommand(e,s,t){if(!this.nc)throw Error("Not connected");let n=this.sc.encode(JSON.stringify(t));await this.nc.publish("home.devices.".concat(s,".command"),n)}async getDeviceState(e,s){if(!this.nc)throw Error("Not connected");let t=this.sc.encode(JSON.stringify({action:"get_state"}));try{let e=await this.nc.request("home.devices.".concat(s,".get"),t,{timeout:5e3});return JSON.parse(this.sc.decode(e.data))}catch(e){throw console.error("Failed to get device state:",e),e}}constructor(){this.nc=null,this.sc=(0,o.cZ)(),this.subscriptions=new Map}}let m=null;function u(){return m||(m=new d),m}function h(){(0,r.useRouter)();let[e,s]=(0,a.useState)(!1),[t,l]=(0,a.useState)(!0),[o,d]=(0,a.useState)(new Map),[m,h]=(0,a.useState)(null),[x,b]=(0,a.useState)(new Map);(0,a.useEffect)(()=>{let e=localStorage.getItem("homix_creds");e?p(e):l(!1)},[]);let p=(0,a.useCallback)(async e=>{try{l(!0);let t=u();await t.connect({wsUrl:"wss://connect.ngs.global:443",credentials:e}),s(!0),await t.subscribeToHomes(e=>{d(s=>new Map(s).set(e.id,e))}),l(!1)}catch(e){console.error("Failed to connect:",e),l(!1),s(!1),localStorage.removeItem("homix_creds")}},[]),g=(0,a.useCallback)(async e=>{h(e);let s=u();await s.subscribeToDevices(e,e=>{b(s=>new Map(s).set(e.id,e))})},[]),f=(0,a.useCallback)(async(e,s)=>{if(!m)return;let t=u();await t.sendCommand(m,e,s)},[m]),N=(0,a.useCallback)(async()=>{let e=u();await e.disconnect(),localStorage.removeItem("homix_creds"),s(!1),d(new Map),b(new Map),h(null)},[]);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(c(),{children:(0,n.jsx)("title",{children:"Homix Cloud"})}),(0,n.jsxs)("div",{className:"min-h-screen bg-gray-50",children:[(0,n.jsx)("header",{className:"bg-white shadow-sm",children:(0,n.jsx)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:(0,n.jsxs)("div",{className:"flex justify-between items-center h-16",children:[(0,n.jsxs)("div",{className:"flex items-center",children:[(0,n.jsx)("span",{className:"text-2xl mr-2",children:"\uD83C\uDFE0"}),(0,n.jsx)("h1",{className:"text-xl font-semibold",children:"Homix Cloud"})]}),(0,n.jsx)("div",{className:"flex items-center space-x-4",children:e&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("span",{className:"text-sm text-green-600 flex items-center",children:[(0,n.jsx)("span",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),"Connected"]}),(0,n.jsx)("button",{onClick:N,className:"text-sm text-gray-500 hover:text-gray-700",children:"Disconnect"})]})})]})})}),(0,n.jsx)("main",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:t?(0,n.jsxs)("div",{className:"text-center py-12",children:[(0,n.jsx)("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),(0,n.jsx)("p",{className:"mt-2 text-gray-600",children:"Connecting to NATS..."})]}):e?(0,n.jsxs)("div",{children:[o.size>0&&(0,n.jsxs)("div",{className:"mb-6",children:[(0,n.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Select Home"}),(0,n.jsxs)("select",{value:m||"",onChange:e=>g(e.target.value),className:"block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",children:[(0,n.jsx)("option",{value:"",children:"Choose a home..."}),Array.from(o.values()).map(e=>(0,n.jsxs)("option",{value:e.id,children:[e.name," (",e.id,")"]},e.id))]})]}),0===o.size&&(0,n.jsxs)("div",{className:"text-center py-12 bg-white rounded-lg shadow",children:[(0,n.jsx)("div",{className:"inline-block p-4 bg-gray-100 rounded-full mb-4",children:(0,n.jsx)("span",{className:"text-4xl",children:"\uD83C\uDFE0"})}),(0,n.jsx)("h2",{className:"text-xl font-semibold mb-2",children:"Waiting for homes..."}),(0,n.jsx)("p",{className:"text-gray-600 mb-4",children:"Make sure your Homix Edge server is running and connected."}),(0,n.jsxs)("div",{className:"text-sm text-gray-500",children:["Listening for announcements on ",(0,n.jsx)("code",{className:"bg-gray-100 px-2 py-1 rounded",children:"home.edge.announce"})]})]}),m&&(0,n.jsxs)("div",{children:[(0,n.jsx)("h2",{className:"text-lg font-semibold mb-4",children:"Devices"}),0===x.size?(0,n.jsxs)("div",{className:"text-center py-8 bg-white rounded-lg shadow",children:[(0,n.jsx)("p",{className:"text-gray-600",children:"No devices found in this home."}),(0,n.jsx)("p",{className:"text-sm text-gray-500 mt-2",children:"Devices will appear here when they connect."})]}):(0,n.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:Array.from(x.values()).map(e=>(0,n.jsxs)("div",{className:"bg-white rounded-lg shadow p-4",children:[(0,n.jsxs)("div",{className:"flex justify-between items-start mb-2",children:[(0,n.jsx)("h3",{className:"font-semibold",children:e.name}),(0,n.jsx)("span",{className:"text-xs text-gray-500",children:e.type})]}),"switch"===e.type&&(0,n.jsx)("div",{className:"mt-4",children:(0,n.jsx)("button",{onClick:()=>f(e.id,{action:"toggle"}),className:"w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700",children:"Toggle"})}),(0,n.jsx)("div",{className:"mt-2 text-xs text-gray-600",children:(0,n.jsx)("pre",{className:"bg-gray-50 p-2 rounded overflow-x-auto",children:JSON.stringify(e.state,null,2)})})]},e.id))})]})]}):(0,n.jsx)(i,{onCredentialsLoaded:p})})]})]})}},9008:function(e,s,t){e.exports=t(4764)},1163:function(e,s,t){e.exports=t(2937)}},function(e){e.O(0,[574,774,888,179],function(){return e(e.s=9301)}),_N_E=e.O()}]);