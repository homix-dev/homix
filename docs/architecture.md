# NATS Home Automation Architecture

NATS Home Automation uses a cloud-first architecture that combines the reliability of local execution with the convenience of cloud management.

## Overview

```
┌─────────────────────────────────┐
│       Synadia Cloud             │
│                                 │
│  • Web UI (React/Next.js)       │
│  • User Authentication          │
│  • Device Registry (KV)         │
│  • Automation Store (KV)        │
│  • Multi-Home Management        │
│  • API Gateway                  │
└────────────┬────────────────────┘
             │ NATS Leaf Node
             │ (TLS + JWT Auth)
┌────────────▼────────────────────┐
│       Your Home                 │
│                                 │
│  Edge Server (Single Container) │
│  • NATS Server (Leaf Mode)      │
│  • Automation Engine            │
│  • Device Gateway               │
│  • Protocol Bridges             │
│  • Local State Cache            │
└────────────┬────────────────────┘
             │
     ┌───────┴────────┐
     │    Devices     │
     │                │
     │ • ESP32/ESP8266│
     │ • Zigbee       │
     │ • Z-Wave       │
     │ • MQTT         │
     │ • HTTP/REST    │
     └────────────────┘
```

## Core Principles

### 1. Cloud Management, Local Execution
- **Configuration** happens in the cloud (UI, device setup, automation design)
- **Execution** happens locally (automations run on edge server)
- **No internet? No problem!** Everything continues working

### 2. Security First
- **Per-device JWT credentials** - Each device has unique, revocable credentials
- **Principle of least privilege** - Devices only access their own subjects
- **No shared secrets** - No more "home:changeme" passwords
- **Automatic rotation** - Credentials can be rotated without touching devices

### 3. Simplicity
- **One container** - Single edge server replaces 5+ containers
- **Zero configuration** - Automatic discovery and setup
- **5-minute install** - From zero to running in minutes
- **No database required** - Uses NATS JetStream/KV for all storage

## Components

### Cloud Components (Synadia Cloud)

#### Web UI
- Modern React/Next.js application
- Real-time updates via NATS WebSocket
- Visual automation designer
- Device management dashboard
- Energy monitoring

#### API Gateway
- RESTful API for third-party integrations
- GraphQL endpoint for complex queries
- WebSocket for real-time updates
- OAuth2/JWT authentication

#### Storage (NATS KV)
- `users` - User accounts and permissions
- `homes` - Home configurations
- `devices` - Device registry
- `automations` - Automation definitions
- `dashboards` - Custom dashboards

### Edge Components (Your Home)

#### Edge Server
Single Go binary that includes:
- NATS server configured as leaf node
- Automation engine for local execution
- Device gateway with protocol bridges
- Local cache for offline operation

#### Protocol Support
- **Native NATS** - Preferred for new devices
- **MQTT Bridge** - For existing MQTT devices
- **HTTP/REST** - For cloud services
- **Zigbee/Z-Wave** - Via USB adapters

## Message Flow

### Device State Updates
```
Device → Edge Server → Cloud (via Leaf) → UI
        ↓
        Local Cache → Automation Engine
```

### Device Commands
```
UI → Cloud → Edge Server (via Leaf) → Device
```

### Automation Execution
```
Device Event → Edge Server → Automation Engine → Device Command
                           ↓
                           Cloud (Status Update)
```

## Subject Hierarchy

### Cloud Subjects
```
cloud.homes.{home-id}.devices.{device-id}.state
cloud.homes.{home-id}.devices.{device-id}.command
cloud.homes.{home-id}.automations.{auto-id}.status
cloud.homes.{home-id}.events
cloud.users.{user-id}.notifications
```

### Local Subjects
```
home.devices.{device-id}.state
home.devices.{device-id}.command
home.devices.{device-id}.announce
home.automations.{auto-id}.trigger
home.events.{type}
```

## Security Model

### Authentication
1. **Users** authenticate with Synadia Cloud (OAuth2/SAML)
2. **Edge Servers** use JWT credentials to connect as leaf nodes
3. **Devices** use per-device JWT credentials generated by provisioning service

### Authorization
```
Device "kitchen-light" can:
- Publish to: home.devices.kitchen-light.state
- Subscribe to: home.devices.kitchen-light.command

Edge Server can:
- Publish to: cloud.homes.{home-id}.*
- Subscribe to: cloud.homes.{home-id}.*
```

### Credential Flow
1. User creates device in UI
2. Cloud generates unique JWT for device
3. JWT delivered to device via QR code/PIN
4. Device connects with JWT credentials
5. Automatic renewal before expiration

## Scalability

### Horizontal Scaling
- Multiple edge servers per home (primary/backup)
- Load balancing across edge servers
- Automatic failover on failure

### Multi-Home Support
- Each home has unique ID
- Users can manage multiple homes
- Shared devices between homes
- Cross-home automations

## Offline Operation

When internet is unavailable:
1. Edge server continues running automations
2. Local device control still works
3. State changes are cached locally
4. Sync with cloud when connection restored

## Performance

### Latency
- Local device control: <1ms
- Cloud UI updates: <100ms
- Automation execution: <10ms

### Throughput
- 10,000+ messages/second per edge server
- 100+ concurrent devices
- Unlimited automations

## Deployment Options

### Standard (Docker)
```bash
docker run -d --network host \
  -v ~/nats.creds:/creds/cloud.creds:ro \
  ghcr.io/calmera/nats-home-edge:latest
```

### Kubernetes
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nats-home-edge
spec:
  replicas: 2  # HA setup
  template:
    spec:
      containers:
      - name: edge
        image: ghcr.io/calmera/nats-home-edge:latest
```

### Bare Metal
```bash
wget https://github.com/calmera/nats-home/releases/latest/edge
chmod +x edge
./edge --config edge.yaml
```

## Future Enhancements

### Planned Features
- Voice assistant integration (Alexa, Google, Siri)
- Machine learning for automation suggestions
- Energy optimization algorithms
- Presence detection using BLE/WiFi
- Video streaming support

### Community Requests
- Home Assistant migration tool
- Backup/restore functionality
- Custom device drivers
- Plugin system for extensions