"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[574],{6181:function(e,t,r){let s,i;r.d(t,{$j:function(){return r4},Kj:function(){return t6},cZ:function(){return R}});let n=new Uint8Array(0),o=new TextEncoder,a=new TextDecoder;function h(...e){let t=[];for(let r=0;r<e.length;r++)t.push(o.encode(e[r]));return 0===t.length?n:1===t.length?t[0]:function(...e){let t=0;for(let r=0;r<e.length;r++)t+=e[r].length;let r=new Uint8Array(t),s=0;for(let t=0;t<e.length;t++)r.set(e[t],s),s+=e[t].length;return r}(...t)}function c(e){return e&&0!==e.length?a.decode(e):""}let l="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";class u{buf;seq;inc;inited;constructor(){this.buf=new Uint8Array(22),this.inited=!1}init(){this.inited=!0,this.setPre(),this.initSeqAndInc(),this.fillSeq()}initSeqAndInc(){this.seq=Math.floor(0xcfd41b9100000*Math.random()),this.inc=Math.floor(300*Math.random()+33)}setPre(){let e=new Uint8Array(12);globalThis?.crypto?.getRandomValues?globalThis.crypto.getRandomValues(e):function(e){for(let t=0;t<e.length;t++)e[t]=Math.floor(255*Math.random())}(e);for(let t=0;t<12;t++){let r=e[t]%36;this.buf[t]=l.charCodeAt(r)}}fillSeq(){let e=this.seq;for(let t=21;t>=12;t--)this.buf[t]=l.charCodeAt(e%36),e=Math.floor(e/36)}next(){return this.inited||this.init(),this.seq+=this.inc,this.seq>0xcfd41b9100000&&(this.setPre(),this.initSeqAndInc()),this.fillSeq(),String.fromCharCode.apply(String,this.buf)}reset(){this.init()}}let d=new u;(eu=eG||(eG={})).Disconnect="disconnect",eu.Reconnect="reconnect",eu.Update="update",eu.LDM="ldm",eu.Error="error",(ed=eV||(eV={})).Reconnecting="reconnecting",ed.PingTimer="pingTimer",ed.StaleConnection="staleConnection",ed.ClientInitiatedReconnect="client initiated reconnect",(ef=eW||(eW={})).ApiError="BAD API",ef.BadAuthentication="BAD_AUTHENTICATION",ef.BadCreds="BAD_CREDS",ef.BadHeader="BAD_HEADER",ef.BadJson="BAD_JSON",ef.BadPayload="BAD_PAYLOAD",ef.BadSubject="BAD_SUBJECT",ef.Cancelled="CANCELLED",ef.ConnectionClosed="CONNECTION_CLOSED",ef.ConnectionDraining="CONNECTION_DRAINING",ef.ConnectionRefused="CONNECTION_REFUSED",ef.ConnectionTimeout="CONNECTION_TIMEOUT",ef.Disconnect="DISCONNECT",ef.InvalidOption="INVALID_OPTION",ef.InvalidPayload="INVALID_PAYLOAD",ef.MaxPayloadExceeded="MAX_PAYLOAD_EXCEEDED",ef.NoResponders="503",ef.NotFunction="NOT_FUNC",ef.RequestError="REQUEST_ERROR",ef.ServerOptionNotAvailable="SERVER_OPT_NA",ef.SubClosed="SUB_CLOSED",ef.SubDraining="SUB_DRAINING",ef.Timeout="TIMEOUT",ef.Tls="TLS",ef.Unknown="UNKNOWN_ERROR",ef.WssRequired="WSS_REQUIRED",ef.JetStreamInvalidAck="JESTREAM_INVALID_ACK",ef.JetStream404NoMessages="404",ef.JetStream408RequestTimeout="408",ef.JetStream409MaxAckPendingExceeded="409",ef.JetStream409="409",ef.JetStreamNotEnabled="503",ef.JetStreamIdleHeartBeat="IDLE_HEARTBEAT",ef.AuthorizationViolation="AUTHORIZATION_VIOLATION",ef.AuthenticationExpired="AUTHENTICATION_EXPIRED",ef.ProtocolError="NATS_PROTOCOL_ERR",ef.PermissionsViolation="PERMISSIONS_VIOLATION",ef.AuthenticationTimeout="AUTHENTICATION_TIMEOUT",ef.AccountExpired="ACCOUNT_EXPIRED";class f{messages;constructor(){this.messages=new Map,this.messages.set(eW.InvalidPayload,"Invalid payload type - payloads can be 'binary', 'string', or 'json'"),this.messages.set(eW.BadJson,"Bad JSON"),this.messages.set(eW.WssRequired,"TLS is required, therefore a secure websocket connection is also required")}static getMessage(e){return p.getMessage(e)}getMessage(e){return this.messages.get(e)||e}}let p=new f;class m extends Error{name;message;code;permissionContext;chainedError;api_error;constructor(e,t,r){super(e),this.name="NatsError",this.message=e,this.code=t,this.chainedError=r}static errorForCode(e,t){return new m(f.getMessage(e),e,t)}isAuthError(){return this.code===eW.AuthenticationExpired||this.code===eW.AuthorizationViolation||this.code===eW.AccountExpired}isAuthTimeout(){return this.code===eW.AuthenticationTimeout}isPermissionError(){return this.code===eW.PermissionsViolation}isProtocolError(){return this.code===eW.ProtocolError}isJetStreamError(){return void 0!==this.api_error}jsError(){return this.api_error?this.api_error:null}}(ep=eY||(eY={}))[ep.Exact=0]="Exact",ep[ep.CanonicalMIME=1]="CanonicalMIME",ep[ep.IgnoreCase=2]="IgnoreCase",(em=eX||(eX={})).Timer="timer",em.Count="count",em.JitterTimer="jitterTimer",em.SentinelMsg="sentinelMsg",(eg=eZ||(eZ={})).STATS="io.nats.micro.v1.stats_response",eg.INFO="io.nats.micro.v1.info_response",eg.PING="io.nats.micro.v1.ping_response";let g="Nats-Service-Error",b="Nats-Service-Error-Code";class _ extends Error{code;constructor(e,t){super(t),this.code=e}static isServiceError(e){return null!==_.toServiceError(e)}static toServiceError(e){let t=e?.headers?.get(b)||"";if(""!==t){let r=parseInt(t)||400,s=e?.headers?.get(g)||"";return new _(r,s.length?s:t)}return null}}function y(e=""){if("string"!=typeof(e=e||"_INBOX"))throw Error("prefix must be a string");return e.split(".").forEach(t=>{if("*"===t||">"===t)throw Error(`inbox prefixes cannot have wildcards '${e}'`)}),`${e}.${d.next()}`}let w="127.0.0.1";function S(e,...t){for(let r=0;r<t.length;r++){let s=t[r];Object.keys(s).forEach(function(t){e[t]=s[t]})}return e}function v(e){return a.decode(e).replace(/\n/g,"␊").replace(/\r/g,"␍")}function E(e,t=!0){let r,s;let i=t?m.errorForCode(eW.Timeout):null;return Object.assign(new Promise((t,n)=>{r={cancel:()=>{s&&clearTimeout(s)}},s=setTimeout(()=>{null===i?n(m.errorForCode(eW.Timeout)):n(i)},e)}),r)}function x(e=0){let t;return Object.assign(new Promise(r=>{let s=setTimeout(()=>{r()},e);t={cancel:()=>{s&&clearTimeout(s)}}}),t)}function P(){let e={};return Object.assign(new Promise((t,r)=>{e={resolve:t,reject:r}}),e)}function A(e){for(let t=e.length-1;t>0;t--){let r=Math.floor(Math.random()*(t+1));[e[t],e[r]]=[e[r],e[t]]}return e}function k(e=[0,250,250,500,500,3e3,5e3]){Array.isArray(e)||(e=[0,250,250,500,500,3e3,5e3]);let t=e.length-1;return{backoff:r=>{var s;return 0===(s=r>t?e[t]:e[r])?0:Math.floor(s/2+Math.random()*s)}}}function O(e){return 1e6*e}function C(e){return Math.floor(e/1e6)}function j(e){let t=!0,r=Array(e.length);for(let s=0;s<e.length;s++){let i=e.charCodeAt(s);if(58===i||i<33||i>126)throw new m(`'${e[s]}' is not a valid character for a header key`,eW.BadHeader);t&&97<=i&&i<=122?i-=32:!t&&65<=i&&i<=90&&(i+=32),r[s]=i,t=45==i}return String.fromCharCode(...r)}function I(e=0,t=""){if(0===e&&""!==t||e>0&&""===t)throw Error("setting status requires both code and description");return new M(e,t)}(eb=eQ||(eQ={})).PING="PING",eb.STATS="STATS",eb.INFO="INFO";let N="NATS/1.0";class M{_code;headers;_description;constructor(e=0,t=""){this._code=e,this._description=t,this.headers=new Map}[Symbol.iterator](){return this.headers.entries()}size(){return this.headers.size}equals(e){if(e&&this.headers.size===e.headers.size&&this._code===e._code){for(let[t,r]of this.headers){let s=e.values(t);if(r.length!==s.length)return!1;let i=[...r].sort(),n=[...s].sort();for(let e=0;e<i.length;e++)if(i[e]!==n[e])return!1}return!0}return!1}static decode(e){let t=new M,r=a.decode(e).split("\r\n"),s=r[0];if(s!==N){let e=s.replace(N,"").trim();if(e.length>0){t._code=parseInt(e,10),isNaN(t._code)&&(t._code=0);let r=t._code.toString();e=e.replace(r,""),t._description=e.trim()}}return r.length>=1&&r.slice(1).map(e=>{if(e){let r=e.indexOf(":");if(r>-1){let s=e.slice(0,r),i=e.slice(r+1).trim();t.append(s,i)}}}),t}toString(){if(0===this.headers.size&&0===this._code)return"";let e=N;for(let[t,r]of(this._code>0&&""!==this._description&&(e+=` ${this._code} ${this._description}`),this.headers))for(let s=0;s<r.length;s++)e=`${e}\r
${t}: ${r[s]}`;return`${e}\r
\r
`}encode(){return o.encode(this.toString())}static validHeaderValue(e){if(/[\r\n]/.test(e))throw new m("invalid header value - \\r and \\n are not allowed.",eW.BadHeader);return e.trim()}keys(){let e=[];for(let t of this.headers.keys())e.push(t);return e}findKeys(e,t=eY.Exact){let r=this.keys();switch(t){case eY.Exact:return r.filter(t=>t===e);case eY.CanonicalMIME:return e=j(e),r.filter(t=>t===e);default:{let t=e.toLowerCase();return r.filter(e=>t===e.toLowerCase())}}}get(e,t=eY.Exact){let r=this.findKeys(e,t);if(r.length){let e=this.headers.get(r[0]);if(e)return Array.isArray(e)?e[0]:e}return""}last(e,t=eY.Exact){let r=this.findKeys(e,t);if(r.length){let e=this.headers.get(r[0]);if(e)return Array.isArray(e)?e[e.length-1]:e}return""}has(e,t=eY.Exact){return this.findKeys(e,t).length>0}set(e,t,r=eY.Exact){this.delete(e,r),this.append(e,t,r)}append(e,t,r=eY.Exact){let s=j(e);r===eY.CanonicalMIME&&(e=s);let i=this.findKeys(e,r);e=i.length>0?i[0]:e;let n=M.validHeaderValue(t),o=this.headers.get(e);o||(o=[],this.headers.set(e,o)),o.push(n)}values(e,t=eY.Exact){let r=[];return this.findKeys(e,t).forEach(e=>{let t=this.headers.get(e);t&&r.push(...t)}),r}delete(e,t=eY.Exact){this.findKeys(e,t).forEach(e=>{this.headers.delete(e)})}get hasError(){return this._code>=300}get status(){return`${this._code} ${this._description}`.trim()}toRecord(){let e={};return this.keys().forEach(t=>{e[t]=this.values(t)}),e}get code(){return this._code}get description(){return this._description}static fromRecord(e){let t=new M;for(let r in e)t.headers.set(r,e[r]);return t}}function R(){return{encode:e=>o.encode(e),decode:e=>a.decode(e)}}function T(e){return{encode(e){try{return void 0===e&&(e=null),o.encode(JSON.stringify(e))}catch(e){throw m.errorForCode(eW.BadJson,e)}},decode(t){try{return JSON.parse(a.decode(t),e)}catch(e){throw m.errorForCode(eW.BadJson,e)}}}}function $(e){return e&&0===e.data.length&&e.headers?.code===503?m.errorForCode(eW.NoResponders):null}class U{_headers;_msg;_rdata;_reply;_subject;publisher;static jc;constructor(e,t,r){this._msg=e,this._rdata=t,this.publisher=r}get subject(){return this._subject||(this._subject=a.decode(this._msg.subject)),this._subject}get reply(){return this._reply||(this._reply=a.decode(this._msg.reply)),this._reply}get sid(){return this._msg.sid}get headers(){if(this._msg.hdr>-1&&!this._headers){let e=this._rdata.subarray(0,this._msg.hdr);this._headers=M.decode(e)}return this._headers}get data(){return this._rdata?this._msg.hdr>-1?this._rdata.subarray(this._msg.hdr):this._rdata:new Uint8Array(0)}respond(e=n,t){return!!this.reply&&(this.publisher.publish(this.reply,e,t),!0)}size(){return this._msg.subject.length+(this._msg.reply?.length||0)+(-1===this._msg.size?0:this._msg.size)}json(e){return T(e).decode(this.data)}string(){return a.decode(this.data)}requestInfo(){let e=this.headers?.get("Nats-Request-Info");return e?JSON.parse(e,function(e,t){return("start"===e||"stop"===e)&&""!==t?new Date(Date.parse(t)):t}):null}}function q(e){return L("durable",e)}function F(e){return L("stream",e)}function L(e,t=""){if(""===t)throw Error(`${e} name required`);return[".","*",">","/","\\"," ","	","\n","\r"].forEach(r=>{if(-1!==t.indexOf(r)){switch(r){case"\n":r="\\n";break;case"\r":r="\\r";break;case"	":r="\\t"}throw Error(`invalid ${e} name - ${e} name cannot contain '${r}'`)}}),""}function B(e,t=""){if(""===t)throw Error(`${e} name required`);let r=function(e=""){if(""===e)throw Error("name required");let t=/^[-\w]+$/g;if(null===e.match(t)){for(let r of e.split(""))if(null===r.match(t))return`cannot contain '${r}'`}return""}(t);if(r.length)throw Error(`invalid ${e} name - ${e} name ${r}`)}function D(e){if(e.data.length>0)return!1;let t=e.headers;return!!t&&t.code>=100&&t.code<200}function H(e){return D(e)&&e.headers?.description==="Idle Heartbeat"}function J(e){if(0!==e.data.length)return null;let t=e.headers;return t?K(t.code,t.description):null}function K(e,t=""){if(e<300)return null;switch(t=t.toLowerCase(),e){case 404:return new m(t,eW.JetStream404NoMessages);case 408:return new m(t,eW.JetStream408RequestTimeout);case 409:{let e=t.startsWith(e0.IdleHeartbeatMissed)?eW.JetStreamIdleHeartBeat:eW.JetStream409;return new m(t,e)}case 503:return m.errorForCode(eW.JetStreamNotEnabled,Error(t));default:return""===t&&(t=eW.Unknown),new m(t,`${e}`)}}(e_=e0||(e0={})).MaxBatchExceeded="exceeded maxrequestbatch of",e_.MaxExpiresExceeded="exceeded maxrequestexpires of",e_.MaxBytesExceeded="exceeded maxrequestmaxbytes of",e_.MaxMessageSizeExceeded="message size exceeds maxbytes",e_.PushConsumer="consumer is push based",e_.MaxWaitingExceeded="exceeded maxwaiting",e_.IdleHeartbeatMissed="idle heartbeats missed",e_.ConsumerDeleted="consumer deleted";class z{inflight;processed;received;noIterator;iterClosed;done;signal;yields;filtered;pendingFiltered;ingestionFilterFn;protocolFilterFn;dispatchedFn;ctx;_data;err;time;yielding;constructor(){this.inflight=0,this.filtered=0,this.pendingFiltered=0,this.processed=0,this.received=0,this.noIterator=!1,this.done=!1,this.signal=P(),this.yields=[],this.iterClosed=P(),this.time=0,this.yielding=!1}[Symbol.asyncIterator](){return this.iterate()}push(e){if(this.done)return;if("function"==typeof e){this.yields.push(e),this.signal.resolve();return}let{ingest:t,protocol:r}=this.ingestionFilterFn?this.ingestionFilterFn(e,this.ctx||this):{ingest:!0,protocol:!1};t&&(r&&(this.filtered++,this.pendingFiltered++),this.yields.push(e),this.signal.resolve())}async *iterate(){if(this.noIterator)throw new m("unsupported iterator",eW.ApiError);if(this.yielding)throw new m("already yielding",eW.ApiError);this.yielding=!0;try{for(;;){if(0===this.yields.length&&await this.signal,this.err)throw this.err;let e=this.yields;this.inflight=e.length,this.yields=[];for(let t=0;t<e.length;t++){if("function"==typeof e[t]){let r=e[t];try{r()}catch(e){throw e}if(this.err)throw this.err;continue}if(!this.protocolFilterFn||this.protocolFilterFn(e[t])){this.processed++;let r=Date.now();yield e[t],this.time=Date.now()-r,this.dispatchedFn&&e[t]&&this.dispatchedFn(e[t])}else this.pendingFiltered--;this.inflight--}if(this.done)break;0===this.yields.length&&(e.length=0,this.yields=e,this.signal=P())}}finally{this.stop()}}stop(e){this.done||(this.err=e,this.done=!0,this.signal.resolve(),this.iterClosed.resolve(e))}getProcessed(){return this.noIterator?this.received:this.processed}getPending(){return this.yields.length+this.inflight-this.pendingFiltered}getReceived(){return this.received-this.filtered}}class G{interval;maxOut;cancelAfter;timer;autoCancelTimer;last;missed;count;callback;constructor(e,t,r={maxOut:2}){this.interval=e,this.maxOut=r?.maxOut||2,this.cancelAfter=r?.cancelAfter||0,this.last=Date.now(),this.missed=0,this.count=0,this.callback=t,this._schedule()}cancel(){this.autoCancelTimer&&clearTimeout(this.autoCancelTimer),this.timer&&clearInterval(this.timer),this.timer=0,this.autoCancelTimer=0,this.missed=0}work(){this.last=Date.now(),this.missed=0}_change(e,t=0,r=2){this.interval=e,this.maxOut=r,this.cancelAfter=t,this.restart()}restart(){this.cancel(),this._schedule()}_schedule(){this.cancelAfter>0&&(this.autoCancelTimer=setTimeout(()=>{this.cancel()},this.cancelAfter)),this.timer=setInterval(()=>{if(this.count++,Date.now()-this.last>this.interval&&this.missed++,this.missed>=this.maxOut)try{!0===this.callback(this.missed)&&this.cancel()}catch(e){console.log(e)}},this.interval)}}(ey=e1||(e1={})).Limits="limits",ey.Interest="interest",ey.Workqueue="workqueue",(ew=e2||(e2={})).Old="old",ew.New="new",(eS=e3||(e3={})).File="file",eS.Memory="memory",(ev=e5||(e5={})).All="all",ev.Last="last",ev.New="new",ev.StartSequence="by_start_sequence",ev.StartTime="by_start_time",ev.LastPerSubject="last_per_subject",(eE=e4||(e4={})).None="none",eE.All="all",eE.Explicit="explicit",eE.NotSet="",(ex=e6||(e6={})).Instant="instant",ex.Original="original",(eP=e8||(e8={})).None="none",eP.S2="s2",(eA=e7||(e7={})).CreateOrUpdate="",eA.Update="update",eA.Create="create",(ek=e9||(e9={})).API="api_audit",ek.StreamAction="stream_action",ek.ConsumerAction="consumer_action",ek.SnapshotCreate="snapshot_create",ek.SnapshotComplete="snapshot_complete",ek.RestoreCreate="restore_create",ek.RestoreComplete="restore_complete",ek.MaxDeliver="max_deliver",ek.Terminated="terminated",ek.Ack="consumer_ack",ek.StreamLeaderElected="stream_leader_elected",ek.StreamQuorumLost="stream_quorum_lost",ek.ConsumerLeaderElected="consumer_leader_elected",ek.ConsumerQuorumLost="consumer_quorum_lost",(eO=te||(te={})).StreamSourceHdr="Nats-Stream-Source",eO.LastConsumerSeqHdr="Nats-Last-Consumer",eO.LastStreamSeqHdr="Nats-Last-Stream",eO.ConsumerStalledHdr="Nats-Consumer-Stalled",eO.MessageSizeHdr="Nats-Msg-Size",eO.RollupHdr="Nats-Rollup",eO.RollupValueSubject="sub",eO.RollupValueAll="all",eO.PendingMessagesHdr="Nats-Pending-Messages",eO.PendingBytesHdr="Nats-Pending-Bytes",(eC=tt||(tt={})).LastValue="",eC.AllHistory="history",eC.UpdatesOnly="updates",(ej=tr||(tr={})).Stream="Nats-Stream",ej.Sequence="Nats-Sequence",ej.TimeStamp="Nats-Time-Stamp",ej.Subject="Nats-Subject",(eI=ts||(ts={})).Stream="Nats-Stream",eI.Subject="Nats-Subject",eI.Sequence="Nats-Sequence",eI.LastSequence="Nats-Last-Sequence",eI.Size="Nats-Msg-Size";class V{config;ordered;mack;stream;callbackFn;max;qname;isBind;filters;constructor(e){this.stream="",this.mack=!1,this.ordered=!1,this.config=function(e,t={}){return Object.assign({name:"",deliver_policy:e5.All,ack_policy:e4.Explicit,ack_wait:O(3e4),replay_policy:e6.Instant},t)}(0,e||{})}getOpts(){let e={};if(e.config=Object.assign({},this.config),e.config.filter_subject&&(this.filterSubject(e.config.filter_subject),e.config.filter_subject=void 0),e.config.filter_subjects&&(e.config.filter_subjects?.forEach(e=>{this.filterSubject(e)}),e.config.filter_subjects=void 0),e.mack=this.mack,e.stream=this.stream,e.callbackFn=this.callbackFn,e.max=this.max,e.queue=this.qname,e.ordered=this.ordered,e.config.ack_policy=e.ordered?e4.None:e.config.ack_policy,e.isBind=e.isBind||!1,this.filters)switch(this.filters.length){case 0:break;case 1:e.config.filter_subject=this.filters[0];break;default:e.config.filter_subjects=this.filters}return e}description(e){return this.config.description=e,this}deliverTo(e){return this.config.deliver_subject=e,this}durable(e){return q(e),this.config.durable_name=e,this}startSequence(e){if(e<=0)throw Error("sequence must be greater than 0");return this.config.deliver_policy=e5.StartSequence,this.config.opt_start_seq=e,this}startTime(e){return this.config.deliver_policy=e5.StartTime,this.config.opt_start_time=e.toISOString(),this}deliverAll(){return this.config.deliver_policy=e5.All,this}deliverLastPerSubject(){return this.config.deliver_policy=e5.LastPerSubject,this}deliverLast(){return this.config.deliver_policy=e5.Last,this}deliverNew(){return this.config.deliver_policy=e5.New,this}startAtTimeDelta(e){return this.startTime(new Date(Date.now()-e)),this}headersOnly(){return this.config.headers_only=!0,this}ackNone(){return this.config.ack_policy=e4.None,this}ackAll(){return this.config.ack_policy=e4.All,this}ackExplicit(){return this.config.ack_policy=e4.Explicit,this}ackWait(e){return this.config.ack_wait=O(e),this}maxDeliver(e){return this.config.max_deliver=e,this}filterSubject(e){return this.filters=this.filters||[],this.filters.push(e),this}replayInstantly(){return this.config.replay_policy=e6.Instant,this}replayOriginal(){return this.config.replay_policy=e6.Original,this}sample(e){if((e=Math.trunc(e))<0||e>100)throw Error("value must be between 0-100");return this.config.sample_freq=`${e}%`,this}limit(e){return this.config.rate_limit_bps=e,this}maxWaiting(e){return this.config.max_waiting=e,this}maxAckPending(e){return this.config.max_ack_pending=e,this}idleHeartbeat(e){return this.config.idle_heartbeat=O(e),this}flowControl(){return this.config.flow_control=!0,this}deliverGroup(e){return this.queue(e),this}manualAck(){return this.mack=!0,this}maxMessages(e){return this.max=e,this}callback(e){return this.callbackFn=e,this}queue(e){return this.qname=e,this.config.deliver_group=e,this}orderedConsumer(){return this.ordered=!0,this}bind(e,t){return this.stream=e,this.config.durable_name=t,this.isBind=!0,this}bindStream(e){return this.stream=e,this}inactiveEphemeralThreshold(e){return this.config.inactive_threshold=O(e),this}maxPullBatch(e){return this.config.max_batch=e,this}maxPullRequestExpires(e){return this.config.max_expires=O(e),this}memory(){return this.config.mem_storage=!0,this}numReplicas(e){return this.config.num_replicas=e,this}consumerName(e){return this.config.name=e,this}}function W(e){return new V(e)}function Y(e){return"function"==typeof e.getOpts}class X{static encode(e){return"string"==typeof e?btoa(e):btoa(String.fromCharCode(...Array.from(e)))}static decode(e,t=!1){let r=atob(e);return t?Uint8Array.from(r,e=>e.charCodeAt(0)):r}}class Z{static encode(e){return Z.toB64URLEncoding(X.encode(e))}static decode(e,t=!1){return Z.decode(Z.fromB64URLEncoding(e),t)}static toB64URLEncoding(e){return e.replace(/\+/g,"-").replace(/\//g,"_")}static fromB64URLEncoding(e){return e.replace(/_/g,"/").replace(/-/g,"+")}}class Q{buffers;byteLength;constructor(){this.buffers=[],this.byteLength=0}static concat(...e){let t=0;for(let r=0;r<e.length;r++)t+=e[r].length;let r=new Uint8Array(t),s=0;for(let t=0;t<e.length;t++)r.set(e[t],s),s+=e[t].length;return r}static fromAscii(e){return e||(e=""),o.encode(e)}static toAscii(e){return a.decode(e)}reset(){this.buffers.length=0,this.byteLength=0}pack(){if(this.buffers.length>1){let e=new Uint8Array(this.byteLength),t=0;for(let r=0;r<this.buffers.length;r++)e.set(this.buffers[r],t),t+=this.buffers[r].length;this.buffers.length=0,this.buffers.push(e)}}shift(){if(this.buffers.length){let e=this.buffers.shift();if(e)return this.byteLength-=e.length,e}return new Uint8Array(0)}drain(e){if(this.buffers.length){this.pack();let t=this.buffers.pop();if(t){let r=this.byteLength;(void 0===e||e>r)&&(e=r);let s=t.subarray(0,e);return r>e&&this.buffers.push(t.subarray(e)),this.byteLength=r-e,s}}return new Uint8Array(0)}fill(e,...t){e&&(this.buffers.push(e),this.byteLength+=e.length);for(let e=0;e<t.length;e++)t[e]&&t[e].length&&(this.buffers.push(t[e]),this.byteLength+=t[e].length)}peek(){return this.buffers.length?(this.pack(),this.buffers[0]):new Uint8Array(0)}size(){return this.byteLength}length(){return this.buffers.length}}var ee,et,er,es,ei,en,eo,ea,eh,ec,el,eu,ed,ef,ep,em,eg,eb,e_,ey,ew,eS,ev,eE,ex,eP,eA,ek,eO,eC,ej,eI,eN,eM,eR,eT,e$,eU,eq,eF,eL,eB,eD="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};function eH(){throw Error("setTimeout has not been defined")}function eJ(){throw Error("clearTimeout has not been defined")}var eK=eH,ez=eJ;"function"==typeof eD.setTimeout&&(eK=setTimeout),"function"==typeof eD.clearTimeout&&(ez=clearTimeout);var eG,eV,eW,eY,eX,eZ,eQ,e0,e1,e2,e3,e5,e4,e6,e8,e7,e9,te,tt,tr,ts,ti,tn=[],to=!1,ta=-1;function th(){to&&ti&&(to=!1,ti.length?tn=ti.concat(tn):ta=-1,tn.length&&function(){if(!to){var e=function(e){if(eK===setTimeout)return setTimeout(e,0);if((eK===eH||!eK)&&setTimeout)return eK=setTimeout,setTimeout(e,0);try{return eK(e,0)}catch(t){try{return eK.call(null,e,0)}catch(t){return eK.call(this,e,0)}}}(th);to=!0;for(var t=tn.length;t;){for(ti=tn,tn=[];++ta<t;)ti&&ti[ta].run();ta=-1,t=tn.length}ti=null,to=!1,function(e){if(ez===clearTimeout)return clearTimeout(e);if((ez===eJ||!ez)&&clearTimeout)return ez=clearTimeout,clearTimeout(e);try{ez(e)}catch(t){try{return ez.call(null,e)}catch(t){return ez.call(this,e)}}}(e)}}())}(function(e,t){this.fun=e,this.array=t}).prototype.run=function(){this.fun.apply(null,this.array)};var tc=eD.performance||{},tl=(tc.now||tc.mozNow||tc.msNow||tc.oNow||tc.webkitNow,{versions:{}}),tu="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},td={exports:{}},tf={},tp=function(e){if(e.__esModule)return e;var t=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(e).forEach(function(r){var s=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,s.get?s:{enumerable:!0,get:function(){return e[r]}})}),t}((ee={__proto__:null,default:tf},[tf].forEach(function(e){e&&"string"!=typeof e&&!Array.isArray(e)&&Object.keys(e).forEach(function(t){if("default"!==t&&!(t in ee)){var r=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(ee,t,r.get?r:{enumerable:!0,get:function(){return e[t]}})}})}),Object.freeze(ee)));!function(){var e="input is invalid type",t="object"==typeof window,r=t?window:{};r.JS_SHA256_NO_WINDOW&&(t=!1);var s=!t&&"object"==typeof self,i=!r.JS_SHA256_NO_NODE_JS&&tl.versions&&tl.versions.node;i?r=tu:s&&(r=self);var n=!r.JS_SHA256_NO_COMMON_JS&&td.exports,o=!r.JS_SHA256_NO_ARRAY_BUFFER&&"undefined"!=typeof ArrayBuffer,a="0123456789abcdef".split(""),h=[-2147483648,8388608,32768,128],c=[24,16,8,0],l=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],u=["hex","array","digest","arrayBuffer"],d=[];!r.JS_SHA256_NO_NODE_JS&&Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)}),o&&(r.JS_SHA256_NO_ARRAY_BUFFER_IS_VIEW||!ArrayBuffer.isView)&&(ArrayBuffer.isView=function(e){return"object"==typeof e&&e.buffer&&e.buffer.constructor===ArrayBuffer});var f=function(e,t){return function(r){return new _(t,!0).update(r)[e]()}},p=function(e){var t=f("hex",e);i&&(t=m(t,e)),t.create=function(){return new _(e)},t.update=function(e){return t.create().update(e)};for(var r=0;r<u.length;++r){var s=u[r];t[s]=f(s,e)}return t},m=function(t,s){var i,n=tp.Buffer,o=s?"sha224":"sha256";return i=n.from&&!r.JS_SHA256_NO_BUFFER_FROM?n.from:function(e){return new n(e)},function(r){if("string"==typeof r)return tp.createHash(o).update(r,"utf8").digest("hex");if(null==r)throw Error(e);return r.constructor===ArrayBuffer&&(r=new Uint8Array(r)),Array.isArray(r)||ArrayBuffer.isView(r)||r.constructor===n?tp.createHash(o).update(i(r)).digest("hex"):t(r)}},g=function(e,t){return function(r,s){return new y(r,t,!0).update(s)[e]()}},b=function(e){var t=g("hex",e);t.create=function(t){return new y(t,e)},t.update=function(e,r){return t.create(e).update(r)};for(var r=0;r<u.length;++r){var s=u[r];t[s]=g(s,e)}return t};function _(e,t){t?(d[0]=d[16]=d[1]=d[2]=d[3]=d[4]=d[5]=d[6]=d[7]=d[8]=d[9]=d[10]=d[11]=d[12]=d[13]=d[14]=d[15]=0,this.blocks=d):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e?(this.h0=3238371032,this.h1=914150663,this.h2=812702999,this.h3=4144912697,this.h4=4290775857,this.h5=1750603025,this.h6=1694076839,this.h7=3204075428):(this.h0=1779033703,this.h1=3144134277,this.h2=1013904242,this.h3=2773480762,this.h4=1359893119,this.h5=2600822924,this.h6=528734635,this.h7=1541459225),this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0,this.is224=e}function y(t,r,s){var i,n=typeof t;if("string"===n){var a,h=[],c=t.length,l=0;for(i=0;i<c;++i)(a=t.charCodeAt(i))<128?h[l++]=a:(a<2048?h[l++]=192|a>>>6:(a<55296||a>=57344?h[l++]=224|a>>>12:(a=65536+((1023&a)<<10|1023&t.charCodeAt(++i)),h[l++]=240|a>>>18,h[l++]=128|a>>>12&63),h[l++]=128|a>>>6&63),h[l++]=128|63&a);t=h}else{if("object"!==n||null===t)throw Error(e);if(o&&t.constructor===ArrayBuffer)t=new Uint8Array(t);else if(!(Array.isArray(t)||o&&ArrayBuffer.isView(t)))throw Error(e)}t.length>64&&(t=new _(r,!0).update(t).array());var u=[],d=[];for(i=0;i<64;++i){var f=t[i]||0;u[i]=92^f,d[i]=54^f}_.call(this,r,s),this.update(d),this.oKeyPad=u,this.inner=!0,this.sharedMemory=s}_.prototype.update=function(t){if(!this.finalized){var r,s=typeof t;if("string"!==s){if("object"!==s||null===t)throw Error(e);if(o&&t.constructor===ArrayBuffer)t=new Uint8Array(t);else if(!(Array.isArray(t)||o&&ArrayBuffer.isView(t)))throw Error(e);r=!0}for(var i,n,a=0,h=t.length,l=this.blocks;a<h;){if(this.hashed&&(this.hashed=!1,l[0]=this.block,this.block=l[16]=l[1]=l[2]=l[3]=l[4]=l[5]=l[6]=l[7]=l[8]=l[9]=l[10]=l[11]=l[12]=l[13]=l[14]=l[15]=0),r)for(n=this.start;a<h&&n<64;++a)l[n>>>2]|=t[a]<<c[3&n++];else for(n=this.start;a<h&&n<64;++a)(i=t.charCodeAt(a))<128?l[n>>>2]|=i<<c[3&n++]:(i<2048?l[n>>>2]|=(192|i>>>6)<<c[3&n++]:(i<55296||i>=57344?l[n>>>2]|=(224|i>>>12)<<c[3&n++]:(i=65536+((1023&i)<<10|1023&t.charCodeAt(++a)),l[n>>>2]|=(240|i>>>18)<<c[3&n++],l[n>>>2]|=(128|i>>>12&63)<<c[3&n++]),l[n>>>2]|=(128|i>>>6&63)<<c[3&n++]),l[n>>>2]|=(128|63&i)<<c[3&n++]);this.lastByteIndex=n,this.bytes+=n-this.start,n>=64?(this.block=l[16],this.start=n-64,this.hash(),this.hashed=!0):this.start=n}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296|0,this.bytes=this.bytes%4294967296),this}},_.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>>2]|=h[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},_.prototype.hash=function(){var e,t,r,s,i,n,o,a,h,c=this.h0,u=this.h1,d=this.h2,f=this.h3,p=this.h4,m=this.h5,g=this.h6,b=this.h7,_=this.blocks;for(e=16;e<64;++e)t=((i=_[e-15])>>>7|i<<25)^(i>>>18|i<<14)^i>>>3,r=((i=_[e-2])>>>17|i<<15)^(i>>>19|i<<13)^i>>>10,_[e]=_[e-16]+t+_[e-7]+r|0;for(h=u&d,e=0;e<64;e+=4)this.first?(this.is224?(n=300032,b=(i=_[0]-1413257819)-150054599|0,f=i+24177077|0):(n=704751109,b=(i=_[0]-210244248)-1521486534|0,f=i+143694565|0),this.first=!1):(t=(c>>>2|c<<30)^(c>>>13|c<<19)^(c>>>22|c<<10),s=(n=c&u)^c&d^h,b=f+(i=b+(r=(p>>>6|p<<26)^(p>>>11|p<<21)^(p>>>25|p<<7))+(p&m^~p&g)+l[e]+_[e])|0,f=i+(t+s)|0),t=(f>>>2|f<<30)^(f>>>13|f<<19)^(f>>>22|f<<10),s=(o=f&c)^f&u^n,g=d+(i=g+(r=(b>>>6|b<<26)^(b>>>11|b<<21)^(b>>>25|b<<7))+(b&p^~b&m)+l[e+1]+_[e+1])|0,t=((d=i+(t+s)|0)>>>2|d<<30)^(d>>>13|d<<19)^(d>>>22|d<<10),s=(a=d&f)^d&c^o,m=u+(i=m+(r=(g>>>6|g<<26)^(g>>>11|g<<21)^(g>>>25|g<<7))+(g&b^~g&p)+l[e+2]+_[e+2])|0,t=((u=i+(t+s)|0)>>>2|u<<30)^(u>>>13|u<<19)^(u>>>22|u<<10),s=(h=u&d)^u&f^a,p=c+(i=p+(r=(m>>>6|m<<26)^(m>>>11|m<<21)^(m>>>25|m<<7))+(m&g^~m&b)+l[e+3]+_[e+3])|0,c=i+(t+s)|0,this.chromeBugWorkAround=!0;this.h0=this.h0+c|0,this.h1=this.h1+u|0,this.h2=this.h2+d|0,this.h3=this.h3+f|0,this.h4=this.h4+p|0,this.h5=this.h5+m|0,this.h6=this.h6+g|0,this.h7=this.h7+b|0},_.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,s=this.h3,i=this.h4,n=this.h5,o=this.h6,h=this.h7,c=a[e>>>28&15]+a[e>>>24&15]+a[e>>>20&15]+a[e>>>16&15]+a[e>>>12&15]+a[e>>>8&15]+a[e>>>4&15]+a[15&e]+a[t>>>28&15]+a[t>>>24&15]+a[t>>>20&15]+a[t>>>16&15]+a[t>>>12&15]+a[t>>>8&15]+a[t>>>4&15]+a[15&t]+a[r>>>28&15]+a[r>>>24&15]+a[r>>>20&15]+a[r>>>16&15]+a[r>>>12&15]+a[r>>>8&15]+a[r>>>4&15]+a[15&r]+a[s>>>28&15]+a[s>>>24&15]+a[s>>>20&15]+a[s>>>16&15]+a[s>>>12&15]+a[s>>>8&15]+a[s>>>4&15]+a[15&s]+a[i>>>28&15]+a[i>>>24&15]+a[i>>>20&15]+a[i>>>16&15]+a[i>>>12&15]+a[i>>>8&15]+a[i>>>4&15]+a[15&i]+a[n>>>28&15]+a[n>>>24&15]+a[n>>>20&15]+a[n>>>16&15]+a[n>>>12&15]+a[n>>>8&15]+a[n>>>4&15]+a[15&n]+a[o>>>28&15]+a[o>>>24&15]+a[o>>>20&15]+a[o>>>16&15]+a[o>>>12&15]+a[o>>>8&15]+a[o>>>4&15]+a[15&o];return this.is224||(c+=a[h>>>28&15]+a[h>>>24&15]+a[h>>>20&15]+a[h>>>16&15]+a[h>>>12&15]+a[h>>>8&15]+a[h>>>4&15]+a[15&h]),c},_.prototype.toString=_.prototype.hex,_.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,s=this.h3,i=this.h4,n=this.h5,o=this.h6,a=this.h7,h=[e>>>24&255,e>>>16&255,e>>>8&255,255&e,t>>>24&255,t>>>16&255,t>>>8&255,255&t,r>>>24&255,r>>>16&255,r>>>8&255,255&r,s>>>24&255,s>>>16&255,s>>>8&255,255&s,i>>>24&255,i>>>16&255,i>>>8&255,255&i,n>>>24&255,n>>>16&255,n>>>8&255,255&n,o>>>24&255,o>>>16&255,o>>>8&255,255&o];return this.is224||h.push(a>>>24&255,a>>>16&255,a>>>8&255,255&a),h},_.prototype.array=_.prototype.digest,_.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(this.is224?28:32),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),t.setUint32(20,this.h5),t.setUint32(24,this.h6),this.is224||t.setUint32(28,this.h7),e},y.prototype=new _,y.prototype.finalize=function(){if(_.prototype.finalize.call(this),this.inner){this.inner=!1;var e=this.array();_.call(this,this.is224,this.sharedMemory),this.update(this.oKeyPad),this.update(e),_.prototype.finalize.call(this)}};var w=p();w.sha256=w,w.sha224=p(!0),w.sha256.hmac=b(),w.sha224.hmac=b(!0),n?td.exports=w:(r.sha256=w.sha256,r.sha224=w.sha224)}(),td.exports,td.exports.sha224;var tm=td.exports.sha256;function tg(e){var t;switch(!function(e){if(!/^[0-9A-Fa-f]+$/.test(e))return!1;let t=/^[0-9A-F]+$/.test(e),r=/^[0-9a-f]+$/.test(e);return(!!t||!!r)&&e.length%2==0}(t=e)?/^[A-Za-z0-9\-_]*(={0,2})?$/.test(t)||/^[A-Za-z0-9+/]*(={0,2})?$/.test(t)?"b64":"":"hex"){case"hex":return function(e){if(e.length%2!=0)throw Error("hex string must have an even length");let t=new Uint8Array(e.length/2);for(let r=0;r<e.length;r+=2)t[r/2]=parseInt(e.substring(r,r+2),16);return t}(e);case"b64":return function(e){let t=atob(e=(e=e.replace(/-/g,"+")).replace(/_/g,"/"));return Uint8Array.from(t,e=>e.charCodeAt(0))}(e)}return null}class tb{token;received;ctx;requestSubject;mux;constructor(e,t,r=!0){this.mux=e,this.requestSubject=t,this.received=0,this.token=d.next(),r&&(this.ctx=Error())}}class t_ extends tb{callback;done;timer;max;opts;constructor(e,t,r={maxWait:1e3}){if(super(e,t),this.opts=r,"function"!=typeof this.opts.callback)throw Error("callback is required");this.callback=this.opts.callback,this.max="number"==typeof r.maxMessages&&r.maxMessages>0?r.maxMessages:-1,this.done=P(),this.done.then(()=>{this.callback(null,null)}),this.timer=setTimeout(()=>{this.cancel()},r.maxWait)}cancel(e){e&&this.callback(e,null),clearTimeout(this.timer),this.mux.cancel(this),this.done.resolve()}resolver(e,t){e?(this.ctx&&(e.stack+=`

${this.ctx.stack}`),this.cancel(e)):(this.callback(null,t),this.opts.strategy===eX.Count&&(this.max--,0===this.max&&this.cancel()),this.opts.strategy===eX.JitterTimer&&(clearTimeout(this.timer),this.timer=setTimeout(()=>{this.cancel()},this.opts.jitter||300)),this.opts.strategy===eX.SentinelMsg&&t&&0===t.data.length&&this.cancel())}}class ty extends tb{deferred;timer;constructor(e,t,r={timeout:1e3},s=!0){super(e,t,s),this.deferred=P(),this.timer=E(r.timeout,s)}resolver(e,t){this.timer&&this.timer.cancel(),e?(this.ctx&&(e.stack+=`

${this.ctx.stack}`),this.deferred.reject(e)):this.deferred.resolve(t),this.cancel()}cancel(e){this.timer&&this.timer.cancel(),this.mux.cancel(this),this.deferred.reject(e||m.errorForCode(eW.Cancelled))}}class tw{nc;opts;prefix;timeout;jc;constructor(e,t){var r;this.nc=e,this.opts=((r=(r=t)||{}).domain&&(r.apiPrefix=`$JS.${r.domain}.API`,delete r.domain),S({apiPrefix:"$JS.API",timeout:5e3},r)),this._parseOpts(),this.prefix=this.opts.apiPrefix,this.timeout=this.opts.timeout,this.jc=T()}getOptions(){return Object.assign({},this.opts)}_parseOpts(){let e=this.opts.apiPrefix;if(!e||0===e.length)throw Error("invalid empty prefix");"."===e[e.length-1]&&(e=e.substr(0,e.length-1)),this.opts.apiPrefix=e}async _request(e,t=null,r){(r=r||{}).timeout=this.timeout;let s=n;t&&(s=this.jc.encode(t));let{retries:i}=r;i=-1===(i=i||1)?Number.MAX_SAFE_INTEGER:i;let o=k();for(let t=0;t<i;t++)try{let t=await this.nc.request(e,s,r);return this.parseJsResponse(t)}catch(e){if(("503"===e.code||e.code===eW.Timeout)&&t+1<i)await x(o.backoff(t));else throw e}}async findStream(e){let t=await this._request(`${this.prefix}.STREAM.NAMES`,{subject:e});if(!t.streams||1!==t.streams.length)throw Error("no stream matches subject");return t.streams[0]}getConnection(){return this.nc}parseJsResponse(e){let t=this.jc.decode(e.data);if(t.error){let e=K(t.error.code,t.error.description);if(null!==e)throw e.api_error=t.error,e}return t}}class tS{err;offset;pageInfo;subject;jsm;filter;payload;constructor(e,t,r,s){if(!e)throw Error("subject is required");this.subject=e,this.jsm=r,this.offset=0,this.pageInfo={},this.filter=t,this.payload=s||{}}async next(){if(this.err||this.pageInfo&&this.offset>=this.pageInfo.total)return[];let e={offset:this.offset};this.payload&&Object.assign(e,this.payload);try{let t=await this.jsm._request(this.subject,e,{timeout:this.jsm.timeout});this.pageInfo=t;let r=this.countResponse(t);if(0===r)return[];return this.offset+=r,this.filter(t)}catch(e){throw this.err=e,e}}countResponse(e){switch(e?.type){case"io.nats.jetstream.api.v1.stream_names_response":case"io.nats.jetstream.api.v1.stream_list_response":return e.streams?.length||0;case"io.nats.jetstream.api.v1.consumer_list_response":return e.consumers?.length||0;default:return console.error(`jslister.ts: unknown API response for paged output: ${e?.type}`),e.streams?.length||0}return 0}async *[Symbol.asyncIterator](){let e=await this.next();for(;e.length>0;){for(let t of e)yield t;e=await this.next()}}}function tv(e=""){let t=e.match(/(\d+).(\d+).(\d+)/);if(t)return{major:parseInt(t[1]),minor:parseInt(t[2]),micro:parseInt(t[3])};throw Error(`'${e}' is not a semver value`)}function tE(e,t){return e.major<t.major?-1:e.major>t.major?1:e.minor<t.minor?-1:e.minor>t.minor?1:e.micro<t.micro?-1:e.micro>t.micro?1:0}(et=eN||(eN={})).JS_KV="js_kv",et.JS_OBJECTSTORE="js_objectstore",et.JS_PULL_MAX_BYTES="js_pull_max_bytes",et.JS_NEW_CONSUMER_CREATE_API="js_new_consumer_create",et.JS_ALLOW_DIRECT="js_allow_direct",et.JS_MULTIPLE_CONSUMER_FILTER="js_multiple_consumer_filter",et.JS_SIMPLIFICATION="js_simplification",et.JS_STREAM_CONSUMER_METADATA="js_stream_consumer_metadata",et.JS_CONSUMER_FILTER_SUBJECTS="js_consumer_filter_subjects",et.JS_STREAM_FIRST_SEQ="js_stream_first_seq",et.JS_STREAM_SUBJECT_TRANSFORM="js_stream_subject_transform",et.JS_STREAM_SOURCE_SUBJECT_TRANSFORM="js_stream_source_subject_transform",et.JS_STREAM_COMPRESSION="js_stream_compression",et.JS_DEFAULT_CONSUMER_LIMITS="js_default_consumer_limits",et.JS_BATCH_DIRECT_GET="js_batch_direct_get";class tx{server;features;disabled;constructor(e){this.features=new Map,this.disabled=[],this.update(e)}resetDisabled(){this.disabled.length=0,this.update(this.server)}disable(e){this.disabled.push(e),this.update(this.server)}isDisabled(e){return -1!==this.disabled.indexOf(e)}update(e){"string"==typeof e&&(e=tv(e)),this.server=e,this.set(eN.JS_KV,"2.6.2"),this.set(eN.JS_OBJECTSTORE,"2.6.3"),this.set(eN.JS_PULL_MAX_BYTES,"2.8.3"),this.set(eN.JS_NEW_CONSUMER_CREATE_API,"2.9.0"),this.set(eN.JS_ALLOW_DIRECT,"2.9.0"),this.set(eN.JS_MULTIPLE_CONSUMER_FILTER,"2.10.0"),this.set(eN.JS_SIMPLIFICATION,"2.9.4"),this.set(eN.JS_STREAM_CONSUMER_METADATA,"2.10.0"),this.set(eN.JS_CONSUMER_FILTER_SUBJECTS,"2.10.0"),this.set(eN.JS_STREAM_FIRST_SEQ,"2.10.0"),this.set(eN.JS_STREAM_SUBJECT_TRANSFORM,"2.10.0"),this.set(eN.JS_STREAM_SOURCE_SUBJECT_TRANSFORM,"2.10.0"),this.set(eN.JS_STREAM_COMPRESSION,"2.10.0"),this.set(eN.JS_DEFAULT_CONSUMER_LIMITS,"2.10.0"),this.set(eN.JS_BATCH_DIRECT_GET,"2.11.0"),this.disabled.forEach(e=>{this.features.delete(e)})}set(e,t){this.features.set(e,{min:t,ok:tE(this.server,tv(t))>=0})}get(e){return this.features.get(e)||{min:"unknown",ok:!1}}supports(e){return this.get(e)?.ok||!1}require(e){return"string"==typeof e&&(e=tv(e)),tE(this.server,e)>=0}}class tP extends tw{constructor(e,t){super(e,t)}async add(e,t,r=e7.Create){let s;if(F(e),t.deliver_group&&t.flow_control)throw Error("jetstream flow control is not supported with queue groups");if(t.deliver_group&&t.idle_heartbeat)throw Error("jetstream idle heartbeat is not supported with queue groups");let i={};i.config=t,i.stream_name=e,i.action=r,i.config.durable_name&&q(i.config.durable_name);let n=this.nc,{min:o,ok:a}=n.features.get(eN.JS_NEW_CONSUMER_CREATE_API),h=""===t.name?void 0:t.name;if(h&&!a)throw Error(`consumer 'name' requires server ${o}`);if(h)try{L("name",h)}catch(r){let e=r.message,t=e.indexOf("cannot contain");if(-1!==t)throw Error(`consumer 'name' ${e.substring(t)}`);throw r}let c="";if(Array.isArray(t.filter_subjects)){let{min:e,ok:t}=n.features.get(eN.JS_MULTIPLE_CONSUMER_FILTER);if(!t)throw Error(`consumer 'filter_subjects' requires server ${e}`);a=!1}if(t.metadata){let{min:e,ok:t}=n.features.get(eN.JS_STREAM_CONSUMER_METADATA);if(!t)throw Error(`consumer 'metadata' requires server ${e}`)}if(a&&(c=t.name??t.durable_name??""),""!==c){let r=t.filter_subject??void 0;">"===r&&(r=void 0),s=void 0!==r?`${this.prefix}.CONSUMER.CREATE.${e}.${c}.${r}`:`${this.prefix}.CONSUMER.CREATE.${e}.${c}`}else s=t.durable_name?`${this.prefix}.CONSUMER.DURABLE.CREATE.${e}.${t.durable_name}`:`${this.prefix}.CONSUMER.CREATE.${e}`;return await this._request(s,i)}async update(e,t,r){let s=await this.info(e,t);return this.add(e,Object.assign(s.config,r),e7.Update)}async info(e,t){return F(e),q(t),await this._request(`${this.prefix}.CONSUMER.INFO.${e}.${t}`)}async delete(e,t){return F(e),q(t),(await this._request(`${this.prefix}.CONSUMER.DELETE.${e}.${t}`)).success}list(e){return F(e),new tS(`${this.prefix}.CONSUMER.LIST.${e}`,e=>e.consumers,this)}pause(e,t,r){let s=`${this.prefix}.CONSUMER.PAUSE.${e}.${t}`,i={pause_until:r.toISOString()};return this._request(s,i)}resume(e,t){return this.pause(e,t,new Date(0))}}function tA(e,t,r=!1){if(!0===r&&!e||e&&"function"!=typeof e)throw m.errorForCode(eW.ApiError,Error(`${t} is not a function`))}class tk extends z{sub;adapter;subIterDone;constructor(e,t,r){super(),tA(r.adapter,"adapter",!0),this.adapter=r.adapter,r.callback&&tA(r.callback,"callback"),this.noIterator="function"==typeof r.callback,r.ingestionFilterFn&&(tA(r.ingestionFilterFn,"ingestionFilterFn"),this.ingestionFilterFn=r.ingestionFilterFn),r.protocolFilterFn&&(tA(r.protocolFilterFn,"protocolFilterFn"),this.protocolFilterFn=r.protocolFilterFn),r.dispatchedFn&&(tA(r.dispatchedFn,"dispatchedFn"),this.dispatchedFn=r.dispatchedFn),r.cleanupFn&&tA(r.cleanupFn,"cleanupFn");let s=(e,t)=>{this.callback(e,t)};if(r.callback){let e=r.callback;s=(t,r)=>{let[s,i]=this.adapter(t,r);if(s){e(s,null);return}let{ingest:n}=this.ingestionFilterFn?this.ingestionFilterFn(i,this):{ingest:!0};n&&(!this.protocolFilterFn||this.protocolFilterFn(i))&&(e(s,i),this.dispatchedFn&&i&&this.dispatchedFn(i))}}let{max:i,queue:n,timeout:o}=r,a={queue:n,timeout:o,callback:s};i&&i>0&&(a.max=i),this.sub=e.subscribe(t,a),r.cleanupFn&&(this.sub.cleanupFn=r.cleanupFn),this.noIterator||this.iterClosed.then(()=>{this.unsubscribe()}),this.subIterDone=P(),Promise.all([this.sub.closed,this.iterClosed]).then(()=>{this.subIterDone.resolve()}).catch(()=>{this.subIterDone.resolve()}),(async e=>{await e.closed,this.stop()})(this.sub).then().catch()}unsubscribe(e){this.sub.unsubscribe(e)}drain(){return this.sub.drain()}isDraining(){return this.sub.isDraining()}isClosed(){return this.sub.isClosed()}callback(e,t){this.sub.cancelTimeout();let[r,s]=this.adapter(e,t);r&&this.stop(r),s&&this.push(s)}getSubject(){return this.sub.getSubject()}getReceived(){return this.sub.getReceived()}getProcessed(){return this.sub.getProcessed()}getPending(){return this.sub.getPending()}getID(){return this.sub.getID()}getMax(){return this.sub.getMax()}get closed(){return this.sub.closed}}function tO(){return void 0!==s&&void 0!==s.defaultPort?s.defaultPort:4222}function tC(){return void 0!==s&&s.urlParseFn?s.urlParseFn:void 0}function tj(){return void 0!==s&&s.dnsResolveFn?s.dnsResolveFn:void 0}let tI=Q.fromAscii("\r\n"),tN=new Uint8Array(tI)[0],tM=new Uint8Array(tI)[1];function tR(e){return void 0!==function(e){for(let t=0;t<e.length;t++)switch(e[t]){case".":return tT(e);case":":return function(e){let t=new Uint8Array(16),r=-1;if(e.length>=2&&":"===e[0]&&":"===e[1]&&(r=0,0===(e=e.substring(2)).length))return t;let s=0;for(;s<16;){let{n:i,c:n,ok:o}=function(e){let t=0,r=0;for(r=0;r<e.length;r++){if(48<=e.charCodeAt(r)&&57>=e.charCodeAt(r))t*=16,t+=e.charCodeAt(r)-48;else if(97<=e.charCodeAt(r)&&102>=e.charCodeAt(r))t*=16,t+=e.charCodeAt(r)-97+10;else if(65<=e.charCodeAt(r)&&70>=e.charCodeAt(r))t*=16,t+=e.charCodeAt(r)-65+10;else break;if(t>=16777215)return{n:0,c:r,ok:!1}}return 0===r?{n:0,c:r,ok:!1}:{n:t,c:r,ok:!0}}(e);if(!o||i>65535)return;if(n<e.length&&"."===e[n]){if(r<0&&12!=s||s+4>16)return;let i=tT(e);if(void 0===i)return;t[s]=i[12],t[s+1]=i[13],t[s+2]=i[14],t[s+3]=i[15],e="",s+=4;break}if(t[s]=i>>8,t[s+1]=i,s+=2,0===(e=e.substring(n)).length)break;if(":"!==e[0]||1==e.length)return;if(":"===(e=e.substring(1))[0]){if(r>=0)return;if(r=s,0===(e=e.substring(1)).length)break}}if(0===e.length){if(s<16){if(r<0)return;let e=16-s;for(let i=s-1;i>=r;i--)t[i+e]=t[i];for(let s=r+e-1;s>=r;s--)t[s]=0}else if(r>=0)return;return t}}(e)}}(e)}function tT(e){let t=new Uint8Array(4);for(let r=0;r<4;r++){if(0===e.length)return;if(r>0){if("."!==e[0])return;e=e.substring(1)}let{n:s,c:i,ok:n}=function(e){let t=0,r=0;for(t=0;t<e.length&&48<=e.charCodeAt(t)&&57>=e.charCodeAt(t);t++)if((r=10*r+(e.charCodeAt(t)-48))>=16777215)return{n:16777215,c:t,ok:!1};return 0===t?{n:0,c:0,ok:!1}:{n:r,c:t,ok:!0}}(e);if(!n||s>255)return;e=e.substring(i),t[r]=s}return function(e,t,r,s){let i=new Uint8Array(16);return[0,0,0,0,0,0,0,0,0,0,255,255].forEach((e,t)=>{i[t]=e}),i[12]=e,i[13]=t,i[14]=r,i[15]=s,i}(t[0],t[1],t[2],t[3])}function t$(e){return!(-1===e.indexOf("[")&&-1===e.indexOf("::")&&(-1!==e.indexOf(".")||e.split(":").length<=2))}class tU{src;listen;hostname;port;didConnect;reconnects;lastConnect;gossiped;tlsName;resolves;constructor(e,t=!1){this.src=e,this.tlsName="";let r=function(e){(e=e.trim()).match(/^(.*:\/\/)(.*)/m)&&(e=e.replace(/^(.*:\/\/)(.*)/gm,"$2")),t$(e=function(e){let t="::FFFF:",r=e.toUpperCase().indexOf(t);if(-1!==r&&-1!==e.indexOf(".")){let s=e.substring(r+t.length);return(s=s.replace("[","")).replace("]","")}return e}(e))&&-1===e.indexOf("[")&&(e=`[${e}]`);let t=t$(e)?e.match(/(]:)(\d+)/):e.match(/(:)(\d+)/),r=t&&3===t.length&&t[1]&&t[2]?parseInt(t[2]):4222,s=new URL(`${80===r?"https":"http"}://${e}`);s.port=`${r}`;let i=s.hostname;return"["===i.charAt(0)&&(i=i.substring(1,i.length-1)),{listen:s.host,hostname:i,port:r}}(e);this.listen=r.listen,this.hostname=r.hostname,this.port=r.port,this.didConnect=!1,this.reconnects=0,this.lastConnect=0,this.gossiped=t}toString(){return this.listen}async resolve(e){if(!e.fn||!1===e.resolve)return[this];let t=[];if(tR(this.hostname))return[this];{let r=await e.fn(this.hostname);for(let s of(e.debug&&console.log(`resolve ${this.hostname} = ${r.join(",")}`),r)){let e=80===this.port?"https":"http",r=new URL(`${e}://${t$(s)?"["+s+"]":s}`);r.port=`${this.port}`;let i=new tU(r.host,!1);i.tlsName=this.hostname,t.push(i)}}return e.randomize&&A(t),this.resolves=t,t}}class tq{firstSelect;servers;currentServer;tlsName;randomize;constructor(e=[],t={}){this.firstSelect=!0,this.servers=[],this.tlsName="",this.randomize=t.randomize||!1;let r=tC();e&&(e.forEach(e=>{e=r?r(e):e,this.servers.push(new tU(e))}),this.randomize&&(this.servers=A(this.servers))),0===this.servers.length&&this.addServer(`${w}:${tO()}`,!1),this.currentServer=this.servers[0]}clear(){this.servers.length=0}updateTLSName(){let e=this.getCurrentServer();tR(e.hostname)||(this.tlsName=e.hostname,this.servers.forEach(e=>{e.gossiped&&(e.tlsName=this.tlsName)}))}getCurrentServer(){return this.currentServer}addServer(e,t=!1){let r=tC(),s=new tU(e=r?r(e):e,t);tR(s.hostname)&&(s.tlsName=this.tlsName),this.servers.push(s)}selectServer(){if(this.firstSelect)return this.firstSelect=!1,this.currentServer;let e=this.servers.shift();return e&&(this.servers.push(e),this.currentServer=e),e}removeCurrentServer(){this.removeServer(this.currentServer)}removeServer(e){if(e){let t=this.servers.indexOf(e);this.servers.splice(t,1)}}length(){return this.servers.length}next(){return this.servers.length?this.servers[0]:void 0}getServers(){return this.servers}update(e,t){let r=[],s=[],i=tC(),n=new Map;e.connect_urls&&e.connect_urls.length>0&&e.connect_urls.forEach(e=>{let r=new tU(e=i?i(e,t):e,!0);n.set(e,r)});let o=[];return this.servers.forEach((e,t)=>{let r=e.listen;e.gossiped&&this.currentServer.listen!==r&&void 0===n.get(r)&&o.push(t),n.delete(r)}),o.reverse(),o.forEach(e=>{let t=this.servers.splice(e,1);s=s.concat(t[0].listen)}),n.forEach((e,t)=>{this.servers.push(e),r.push(t)}),{added:r,deleted:s}}}class tF{baseInbox;reqs;constructor(){this.reqs=new Map}size(){return this.reqs.size}init(e){return this.baseInbox=`${y(e)}.`,this.baseInbox}add(e){isNaN(e.received)||(e.received=0),this.reqs.set(e.token,e)}get(e){return this.reqs.get(e)}cancel(e){this.reqs.delete(e.token)}getToken(e){let t=e.subject||"";return 0===t.indexOf(this.baseInbox)?t.substring(this.baseInbox.length):null}all(){return Array.from(this.reqs.values())}handleError(e,t){if(t&&t.permissionContext){if(e)return this.all().forEach(e=>{e.resolver(t,{})}),!0;let r=t.permissionContext;if("publish"===r.operation){let e=this.all().find(e=>e.requestSubject===r.subject);if(e)return e.resolver(t,{}),!0}}return!1}dispatcher(){return(e,t)=>{let r=this.getToken(t);if(r){let s=this.get(r);s&&(null===e&&t.headers&&(e=$(t)),s.resolver(e,t))}}}close(){let e=m.errorForCode(eW.Timeout);this.reqs.forEach(t=>{t.resolver(e,{})})}}class tL{ph;interval;maxOut;timer;pendings;constructor(e,t,r){this.ph=e,this.interval=t,this.maxOut=r,this.pendings=[]}start(){this.cancel(),this._schedule()}cancel(e){this.timer&&(clearTimeout(this.timer),this.timer=void 0),this._reset(),e&&this.ph.disconnect()}_schedule(){this.timer=setTimeout(()=>{if(this.ph.dispatchStatus({type:eV.PingTimer,data:`${this.pendings.length+1}`}),this.pendings.length===this.maxOut){this.cancel(!0);return}let e=P();this.ph.flush(e).then(()=>{this._reset()}).catch(()=>{this.cancel()}),this.pendings.push(e),this._schedule()},this.interval)}_reset(){this.pendings=this.pendings.filter(e=>(e.resolve(),!1))}}class tB extends Error{constructor(e){super(e),this.name="AssertionError"}}let tD=4294967296-2;function tH(e,t,r=0){let s=t.byteLength-r;return e.byteLength>s&&(e=e.subarray(0,s)),t.set(e,r),e.byteLength}class tJ{_buf;_off;constructor(e){if(this._off=0,null==e){this._buf=new Uint8Array(0);return}this._buf=new Uint8Array(e)}bytes(e={copy:!0}){return!1===e.copy?this._buf.subarray(this._off):this._buf.slice(this._off)}empty(){return this._buf.byteLength<=this._off}get length(){return this._buf.byteLength-this._off}get capacity(){return this._buf.buffer.byteLength}truncate(e){if(0===e){this.reset();return}if(e<0||e>this.length)throw Error("bytes.Buffer: truncation out of range");this._reslice(this._off+e)}reset(){this._reslice(0),this._off=0}_tryGrowByReslice(e){let t=this._buf.byteLength;return e<=this.capacity-t?(this._reslice(t+e),t):-1}_reslice(e){!function(e,t="Assertion failed."){if(!e)throw new tB(t)}(e<=this._buf.buffer.byteLength),this._buf=new Uint8Array(this._buf.buffer,0,e)}readByte(){let e=new Uint8Array(1);return this.read(e)?e[0]:null}read(e){if(this.empty())return(this.reset(),0===e.byteLength)?0:null;let t=tH(this._buf.subarray(this._off),e);return this._off+=t,t}writeByte(e){return this.write(Uint8Array.of(e))}writeString(e){return this.write(o.encode(e))}write(e){let t=this._grow(e.byteLength);return tH(e,this._buf,t)}_grow(e){let t=this.length;0===t&&0!==this._off&&this.reset();let r=this._tryGrowByReslice(e);if(r>=0)return r;let s=this.capacity;if(e<=Math.floor(s/2)-t)tH(this._buf.subarray(this._off),this._buf);else if(s+e>tD)throw Error("The buffer cannot be grown beyond the maximum size.");else{let t=new Uint8Array(Math.min(2*s+e,tD));tH(this._buf.subarray(this._off),t),this._buf=t}return this._off=0,this._reslice(Math.min(t+e,tD)),t}grow(e){if(e<0)throw Error("Buffer._grow: negative count");let t=this._grow(e);this._reslice(t)}readFrom(e){let t=0,r=new Uint8Array(32768);for(;;){let s=this.capacity-this.length<32768,i=s?r:new Uint8Array(this._buf.buffer,this.length),n=e.read(i);if(null===n)return t;s?this.write(i.subarray(0,n)):this._reslice(this.length+n),t+=n}}}function tK(){let e={};return e.sid=-1,e.hdr=-1,e.size=-1,e}(er=eM||(eM={}))[er.OK=0]="OK",er[er.ERR=1]="ERR",er[er.MSG=2]="MSG",er[er.INFO=3]="INFO",er[er.PING=4]="PING",er[er.PONG=5]="PONG";class tz{dispatcher;state;as;drop;hdr;ma;argBuf;msgBuf;constructor(e){this.dispatcher=e,this.state=eR.OP_START,this.as=0,this.drop=0,this.hdr=0}parse(e){let t;for(t=0;t<e.length;t++){let r=e[t];switch(this.state){case eR.OP_START:switch(r){case eT.M:case eT.m:this.state=eR.OP_M,this.hdr=-1,this.ma=tK();break;case eT.H:case eT.h:this.state=eR.OP_H,this.hdr=0,this.ma=tK();break;case eT.P:case eT.p:this.state=eR.OP_P;break;case eT.PLUS:this.state=eR.OP_PLUS;break;case eT.MINUS:this.state=eR.OP_MINUS;break;case eT.I:case eT.i:this.state=eR.OP_I;break;default:throw this.fail(e.subarray(t))}break;case eR.OP_H:switch(r){case eT.M:case eT.m:this.state=eR.OP_M;break;default:throw this.fail(e.subarray(t))}break;case eR.OP_M:switch(r){case eT.S:case eT.s:this.state=eR.OP_MS;break;default:throw this.fail(e.subarray(t))}break;case eR.OP_MS:switch(r){case eT.G:case eT.g:this.state=eR.OP_MSG;break;default:throw this.fail(e.subarray(t))}break;case eR.OP_MSG:switch(r){case eT.SPACE:case eT.TAB:this.state=eR.OP_MSG_SPC;break;default:throw this.fail(e.subarray(t))}break;case eR.OP_MSG_SPC:switch(r){case eT.SPACE:case eT.TAB:continue;default:this.state=eR.MSG_ARG,this.as=t}break;case eR.MSG_ARG:switch(r){case eT.CR:this.drop=1;break;case eT.NL:{let r=this.argBuf?this.argBuf.bytes():e.subarray(this.as,t-this.drop);this.processMsgArgs(r),this.drop=0,this.as=t+1,this.state=eR.MSG_PAYLOAD,t=this.as+this.ma.size-1;break}default:this.argBuf&&this.argBuf.writeByte(r)}break;case eR.MSG_PAYLOAD:if(this.msgBuf){if(this.msgBuf.length>=this.ma.size){let e=this.msgBuf.bytes({copy:!1});this.dispatcher.push({kind:eM.MSG,msg:this.ma,data:e}),this.argBuf=void 0,this.msgBuf=void 0,this.state=eR.MSG_END}else{let s=this.ma.size-this.msgBuf.length,i=e.length-t;i<s&&(s=i),s>0?(this.msgBuf.write(e.subarray(t,t+s)),t=t+s-1):this.msgBuf.writeByte(r)}}else t-this.as>=this.ma.size&&(this.dispatcher.push({kind:eM.MSG,msg:this.ma,data:e.subarray(this.as,t)}),this.argBuf=void 0,this.msgBuf=void 0,this.state=eR.MSG_END);break;case eR.MSG_END:if(r!==eT.NL)continue;this.drop=0,this.as=t+1,this.state=eR.OP_START;break;case eR.OP_PLUS:switch(r){case eT.O:case eT.o:this.state=eR.OP_PLUS_O;break;default:throw this.fail(e.subarray(t))}break;case eR.OP_PLUS_O:switch(r){case eT.K:case eT.k:this.state=eR.OP_PLUS_OK;break;default:throw this.fail(e.subarray(t))}break;case eR.OP_PLUS_OK:r===eT.NL&&(this.dispatcher.push({kind:eM.OK}),this.drop=0,this.state=eR.OP_START);break;case eR.OP_MINUS:switch(r){case eT.E:case eT.e:this.state=eR.OP_MINUS_E;break;default:throw this.fail(e.subarray(t))}break;case eR.OP_MINUS_E:switch(r){case eT.R:case eT.r:this.state=eR.OP_MINUS_ER;break;default:throw this.fail(e.subarray(t))}break;case eR.OP_MINUS_ER:switch(r){case eT.R:case eT.r:this.state=eR.OP_MINUS_ERR;break;default:throw this.fail(e.subarray(t))}break;case eR.OP_MINUS_ERR:switch(r){case eT.SPACE:case eT.TAB:this.state=eR.OP_MINUS_ERR_SPC;break;default:throw this.fail(e.subarray(t))}break;case eR.OP_MINUS_ERR_SPC:switch(r){case eT.SPACE:case eT.TAB:continue;default:this.state=eR.MINUS_ERR_ARG,this.as=t}break;case eR.MINUS_ERR_ARG:switch(r){case eT.CR:this.drop=1;break;case eT.NL:{let r;this.argBuf?(r=this.argBuf.bytes(),this.argBuf=void 0):r=e.subarray(this.as,t-this.drop),this.dispatcher.push({kind:eM.ERR,data:r}),this.drop=0,this.as=t+1,this.state=eR.OP_START;break}default:this.argBuf&&this.argBuf.write(Uint8Array.of(r))}break;case eR.OP_P:switch(r){case eT.I:case eT.i:this.state=eR.OP_PI;break;case eT.O:case eT.o:this.state=eR.OP_PO;break;default:throw this.fail(e.subarray(t))}break;case eR.OP_PO:switch(r){case eT.N:case eT.n:this.state=eR.OP_PON;break;default:throw this.fail(e.subarray(t))}break;case eR.OP_PON:switch(r){case eT.G:case eT.g:this.state=eR.OP_PONG;break;default:throw this.fail(e.subarray(t))}break;case eR.OP_PONG:r===eT.NL&&(this.dispatcher.push({kind:eM.PONG}),this.drop=0,this.state=eR.OP_START);break;case eR.OP_PI:switch(r){case eT.N:case eT.n:this.state=eR.OP_PIN;break;default:throw this.fail(e.subarray(t))}break;case eR.OP_PIN:switch(r){case eT.G:case eT.g:this.state=eR.OP_PING;break;default:throw this.fail(e.subarray(t))}break;case eR.OP_PING:r===eT.NL&&(this.dispatcher.push({kind:eM.PING}),this.drop=0,this.state=eR.OP_START);break;case eR.OP_I:switch(r){case eT.N:case eT.n:this.state=eR.OP_IN;break;default:throw this.fail(e.subarray(t))}break;case eR.OP_IN:switch(r){case eT.F:case eT.f:this.state=eR.OP_INF;break;default:throw this.fail(e.subarray(t))}break;case eR.OP_INF:switch(r){case eT.O:case eT.o:this.state=eR.OP_INFO;break;default:throw this.fail(e.subarray(t))}break;case eR.OP_INFO:switch(r){case eT.SPACE:case eT.TAB:this.state=eR.OP_INFO_SPC;break;default:throw this.fail(e.subarray(t))}break;case eR.OP_INFO_SPC:switch(r){case eT.SPACE:case eT.TAB:continue;default:this.state=eR.INFO_ARG,this.as=t}break;case eR.INFO_ARG:switch(r){case eT.CR:this.drop=1;break;case eT.NL:{let r;this.argBuf?(r=this.argBuf.bytes(),this.argBuf=void 0):r=e.subarray(this.as,t-this.drop),this.dispatcher.push({kind:eM.INFO,data:r}),this.drop=0,this.as=t+1,this.state=eR.OP_START;break}default:this.argBuf&&this.argBuf.writeByte(r)}break;default:throw this.fail(e.subarray(t))}}this.state!==eR.MSG_ARG&&this.state!==eR.MINUS_ERR_ARG&&this.state!==eR.INFO_ARG||this.argBuf||(this.argBuf=new tJ(e.subarray(this.as,t-this.drop))),this.state!==eR.MSG_PAYLOAD||this.msgBuf||(this.argBuf||this.cloneMsgArg(),this.msgBuf=new tJ(e.subarray(this.as)))}cloneMsgArg(){let e=this.ma.subject.length,t=this.ma.reply?this.ma.reply.length:0,r=new Uint8Array(e+t);r.set(this.ma.subject),this.ma.reply&&r.set(this.ma.reply,e),this.argBuf=new tJ(r),this.ma.subject=r.subarray(0,e),this.ma.reply&&(this.ma.reply=r.subarray(e))}processMsgArgs(e){if(this.hdr>=0)return this.processHeaderMsgArgs(e);let t=[],r=-1;for(let s=0;s<e.length;s++)switch(e[s]){case eT.SPACE:case eT.TAB:case eT.CR:case eT.NL:r>=0&&(t.push(e.subarray(r,s)),r=-1);break;default:r<0&&(r=s)}switch(r>=0&&t.push(e.subarray(r)),t.length){case 3:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=void 0,this.ma.size=this.protoParseInt(t[2]);break;case 4:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=t[2],this.ma.size=this.protoParseInt(t[3]);break;default:throw this.fail(e,"processMsgArgs Parse Error")}if(this.ma.sid<0)throw this.fail(e,"processMsgArgs Bad or Missing Sid Error");if(this.ma.size<0)throw this.fail(e,"processMsgArgs Bad or Missing Size Error")}fail(e,t=""){return t=t?`${t} [${this.state}]`:`parse error [${this.state}]`,Error(`${t}: ${a.decode(e)}`)}processHeaderMsgArgs(e){let t=[],r=-1;for(let s=0;s<e.length;s++)switch(e[s]){case eT.SPACE:case eT.TAB:case eT.CR:case eT.NL:r>=0&&(t.push(e.subarray(r,s)),r=-1);break;default:r<0&&(r=s)}switch(r>=0&&t.push(e.subarray(r)),t.length){case 4:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=void 0,this.ma.hdr=this.protoParseInt(t[2]),this.ma.size=this.protoParseInt(t[3]);break;case 5:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=t[2],this.ma.hdr=this.protoParseInt(t[3]),this.ma.size=this.protoParseInt(t[4]);break;default:throw this.fail(e,"processHeaderMsgArgs Parse Error")}if(this.ma.sid<0)throw this.fail(e,"processHeaderMsgArgs Bad or Missing Sid Error");if(this.ma.hdr<0||this.ma.hdr>this.ma.size)throw this.fail(e,"processHeaderMsgArgs Bad or Missing Header Size Error");if(this.ma.size<0)throw this.fail(e,"processHeaderMsgArgs Bad or Missing Size Error")}protoParseInt(e){if(0===e.length)return -1;let t=0;for(let r=0;r<e.length;r++){if(e[r]<48||e[r]>57)return -1;t=10*t+(e[r]-48)}return t}}(es=eR||(eR={}))[es.OP_START=0]="OP_START",es[es.OP_PLUS=1]="OP_PLUS",es[es.OP_PLUS_O=2]="OP_PLUS_O",es[es.OP_PLUS_OK=3]="OP_PLUS_OK",es[es.OP_MINUS=4]="OP_MINUS",es[es.OP_MINUS_E=5]="OP_MINUS_E",es[es.OP_MINUS_ER=6]="OP_MINUS_ER",es[es.OP_MINUS_ERR=7]="OP_MINUS_ERR",es[es.OP_MINUS_ERR_SPC=8]="OP_MINUS_ERR_SPC",es[es.MINUS_ERR_ARG=9]="MINUS_ERR_ARG",es[es.OP_M=10]="OP_M",es[es.OP_MS=11]="OP_MS",es[es.OP_MSG=12]="OP_MSG",es[es.OP_MSG_SPC=13]="OP_MSG_SPC",es[es.MSG_ARG=14]="MSG_ARG",es[es.MSG_PAYLOAD=15]="MSG_PAYLOAD",es[es.MSG_END=16]="MSG_END",es[es.OP_H=17]="OP_H",es[es.OP_P=18]="OP_P",es[es.OP_PI=19]="OP_PI",es[es.OP_PIN=20]="OP_PIN",es[es.OP_PING=21]="OP_PING",es[es.OP_PO=22]="OP_PO",es[es.OP_PON=23]="OP_PON",es[es.OP_PONG=24]="OP_PONG",es[es.OP_I=25]="OP_I",es[es.OP_IN=26]="OP_IN",es[es.OP_INF=27]="OP_INF",es[es.OP_INFO=28]="OP_INFO",es[es.OP_INFO_SPC=29]="OP_INFO_SPC",es[es.INFO_ARG=30]="INFO_ARG",(ei=eT||(eT={}))[ei.CR="\r".charCodeAt(0)]="CR",ei[ei.E="E".charCodeAt(0)]="E",ei[ei.e="e".charCodeAt(0)]="e",ei[ei.F="F".charCodeAt(0)]="F",ei[ei.f="f".charCodeAt(0)]="f",ei[ei.G="G".charCodeAt(0)]="G",ei[ei.g="g".charCodeAt(0)]="g",ei[ei.H="H".charCodeAt(0)]="H",ei[ei.h="h".charCodeAt(0)]="h",ei[ei.I="I".charCodeAt(0)]="I",ei[ei.i="i".charCodeAt(0)]="i",ei[ei.K="K".charCodeAt(0)]="K",ei[ei.k="k".charCodeAt(0)]="k",ei[ei.M="M".charCodeAt(0)]="M",ei[ei.m="m".charCodeAt(0)]="m",ei[ei.MINUS="-".charCodeAt(0)]="MINUS",ei[ei.N="N".charCodeAt(0)]="N",ei[ei.n="n".charCodeAt(0)]="n",ei[ei.NL="\n".charCodeAt(0)]="NL",ei[ei.O="O".charCodeAt(0)]="O",ei[ei.o="o".charCodeAt(0)]="o",ei[ei.P="P".charCodeAt(0)]="P",ei[ei.p="p".charCodeAt(0)]="p",ei[ei.PLUS="+".charCodeAt(0)]="PLUS",ei[ei.R="R".charCodeAt(0)]="R",ei[ei.r="r".charCodeAt(0)]="r",ei[ei.S="S".charCodeAt(0)]="S",ei[ei.s="s".charCodeAt(0)]="s",ei[ei.SPACE=" ".charCodeAt(0)]="SPACE",ei[ei.TAB="	".charCodeAt(0)]="TAB",function(e){var t,r=function(e,t){this.hi=0|e,this.lo=0|t},s=function(e){var t,r=new Float64Array(16);if(e)for(t=0;t<e.length;t++)r[t]=e[t];return r},i=function(){throw Error("no PRNG")},n=new Uint8Array(16),o=new Uint8Array(32);o[0]=9;var a=s(),h=s([1]),c=s([56129,1]),l=s([30883,4953,19914,30187,55467,16705,2637,112,59544,30585,16505,36039,65139,11119,27886,20995]),u=s([61785,9906,39828,60374,45398,33411,5274,224,53552,61171,33010,6542,64743,22239,55772,9222]),d=s([54554,36645,11616,51542,42930,38181,51040,26924,56412,64982,57905,49316,21502,52590,14035,8553]),f=s([26200,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214]),p=s([41136,18958,6951,50414,58488,44335,6150,12099,55207,15867,153,11085,57099,20417,9344,11139]);function m(e,t){return e<<t|e>>>32-t}function g(e,t){var r=255&e[t+3];return(r=(r=r<<8|255&e[t+2])<<8|255&e[t+1])<<8|255&e[t+0]}function b(e,t){return new r(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3],e[t+4]<<24|e[t+5]<<16|e[t+6]<<8|e[t+7])}function _(e,t,r){var s;for(s=0;s<4;s++)e[t+s]=255&r,r>>>=8}function y(e,t,r){e[t]=r.hi>>24&255,e[t+1]=r.hi>>16&255,e[t+2]=r.hi>>8&255,e[t+3]=255&r.hi,e[t+4]=r.lo>>24&255,e[t+5]=r.lo>>16&255,e[t+6]=r.lo>>8&255,e[t+7]=255&r.lo}function w(e,t,r,s,i){var n,o=0;for(n=0;n<i;n++)o|=e[t+n]^r[s+n];return(1&o-1>>>8)-1}function S(e,t,r,s){return w(e,t,r,s,16)}function v(e,t,r,s){return w(e,t,r,s,32)}function E(e,t,r,s,i){var n,o,a,h=new Uint32Array(16),c=new Uint32Array(16),l=new Uint32Array(16),u=new Uint32Array(4);for(n=0;n<4;n++)c[5*n]=g(s,4*n),c[1+n]=g(r,4*n),c[6+n]=g(t,4*n),c[11+n]=g(r,16+4*n);for(n=0;n<16;n++)l[n]=c[n];for(n=0;n<20;n++){for(o=0;o<4;o++){for(a=0;a<4;a++)u[a]=c[(5*o+4*a)%16];for(u[1]^=m(u[0]+u[3]|0,7),u[2]^=m(u[1]+u[0]|0,9),u[3]^=m(u[2]+u[1]|0,13),u[0]^=m(u[3]+u[2]|0,18),a=0;a<4;a++)h[4*o+(o+a)%4]=u[a]}for(a=0;a<16;a++)c[a]=h[a]}if(i){for(n=0;n<16;n++)c[n]=c[n]+l[n]|0;for(n=0;n<4;n++)c[5*n]=c[5*n]-g(s,4*n)|0,c[6+n]=c[6+n]-g(t,4*n)|0;for(n=0;n<4;n++)_(e,4*n,c[5*n]),_(e,16+4*n,c[6+n])}else for(n=0;n<16;n++)_(e,4*n,c[n]+l[n]|0)}function x(e,t,r,s){return E(e,t,r,s,!0),0}var P=new Uint8Array([101,120,112,97,110,100,32,51,50,45,98,121,116,101,32,107]);function A(e,t,r,s,i,n,o){var a,h,c=new Uint8Array(16),l=new Uint8Array(64);if(!i)return 0;for(h=0;h<16;h++)c[h]=0;for(h=0;h<8;h++)c[h]=n[h];for(;i>=64;){for(E(l,c,o,P,!1),h=0;h<64;h++)e[t+h]=(r?r[s+h]:0)^l[h];for(h=8,a=1;h<16;h++)a=a+(255&c[h])|0,c[h]=255&a,a>>>=8;i-=64,t+=64,r&&(s+=64)}if(i>0)for(E(l,c,o,P,!1),h=0;h<i;h++)e[t+h]=(r?r[s+h]:0)^l[h];return 0}function k(e,t,r,s,i){return A(e,t,null,0,r,s,i)}function O(e,t,r,s,i){var n=new Uint8Array(32);return x(n,s,i,P),k(e,t,r,s.subarray(16),n)}function C(e,t,r,s,i,n,o){var a=new Uint8Array(32);return x(a,n,o,P),A(e,t,r,s,i,n.subarray(16),a)}function j(e,t){var r,s=0;for(r=0;r<17;r++)s=s+(e[r]+t[r]|0)|0,e[r]=255&s,s>>>=8}var I=new Uint32Array([5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,252]);function N(e,t,r,s,i,n){var o,a,h,c,l=new Uint32Array(17),u=new Uint32Array(17),d=new Uint32Array(17),f=new Uint32Array(17),p=new Uint32Array(17);for(h=0;h<17;h++)u[h]=d[h]=0;for(h=0;h<16;h++)u[h]=n[h];for(u[3]&=15,u[4]&=252,u[7]&=15,u[8]&=252,u[11]&=15,u[12]&=252,u[15]&=15;i>0;){for(h=0;h<17;h++)f[h]=0;for(h=0;h<16&&h<i;++h)f[h]=r[s+h];for(f[h]=1,s+=h,i-=h,j(d,f),a=0;a<17;a++)for(h=0,l[a]=0;h<17;h++)l[a]=l[a]+d[h]*(h<=a?u[a-h]:320*u[a+17-h]|0)|0;for(a=0;a<17;a++)d[a]=l[a];for(h=0,c=0;h<16;h++)c=c+d[h]|0,d[h]=255&c,c>>>=8;for(h=0,c=c+d[16]|0,d[16]=3&c,c=5*(c>>>2)|0;h<16;h++)c=c+d[h]|0,d[h]=255&c,c>>>=8;c=c+d[16]|0,d[16]=c}for(h=0;h<17;h++)p[h]=d[h];for(j(d,I),o=0|-(d[16]>>>7),h=0;h<17;h++)d[h]^=o&(p[h]^d[h]);for(h=0;h<16;h++)f[h]=n[h+16];for(f[16]=0,j(d,f),h=0;h<16;h++)e[t+h]=d[h];return 0}function M(e,t,r,s,i,n){var o=new Uint8Array(16);return N(o,0,r,s,i,n),S(e,t,o,0)}function R(e,t,r,s,i){var n;if(r<32)return -1;for(C(e,0,t,0,r,s,i),N(e,16,e,32,r-32,e),n=0;n<16;n++)e[n]=0;return 0}function T(e,t,r,s,i){var n,o=new Uint8Array(32);if(r<32||(O(o,0,32,s,i),0!==M(t,16,t,32,r-32,o)))return -1;for(C(e,0,t,0,r,s,i),n=0;n<32;n++)e[n]=0;return 0}function $(e,t){var r;for(r=0;r<16;r++)e[r]=0|t[r]}function U(e){var t,r;for(r=0;r<16;r++)e[r]+=65536,t=Math.floor(e[r]/65536),e[(r+1)*(r<15?1:0)]+=t-1+37*(t-1)*(15===r?1:0),e[r]-=65536*t}function q(e,t,r){for(var s,i=~(r-1),n=0;n<16;n++)s=i&(e[n]^t[n]),e[n]^=s,t[n]^=s}function F(e,t){var r,i,n,o=s(),a=s();for(r=0;r<16;r++)a[r]=t[r];for(U(a),U(a),U(a),i=0;i<2;i++){for(r=1,o[0]=a[0]-65517;r<15;r++)o[r]=a[r]-65535-(o[r-1]>>16&1),o[r-1]&=65535;o[15]=a[15]-32767-(o[14]>>16&1),n=o[15]>>16&1,o[14]&=65535,q(a,o,1-n)}for(r=0;r<16;r++)e[2*r]=255&a[r],e[2*r+1]=a[r]>>8}function L(e,t){var r=new Uint8Array(32),s=new Uint8Array(32);return F(r,e),F(s,t),v(r,0,s,0)}function B(e){var t=new Uint8Array(32);return F(t,e),1&t[0]}function D(e,t){var r;for(r=0;r<16;r++)e[r]=t[2*r]+(t[2*r+1]<<8);e[15]&=32767}function H(e,t,r){var s;for(s=0;s<16;s++)e[s]=t[s]+r[s]|0}function J(e,t,r){var s;for(s=0;s<16;s++)e[s]=t[s]-r[s]|0}function K(e,t,r){var s,i,n=new Float64Array(31);for(s=0;s<31;s++)n[s]=0;for(s=0;s<16;s++)for(i=0;i<16;i++)n[s+i]+=t[s]*r[i];for(s=0;s<15;s++)n[s]+=38*n[s+16];for(s=0;s<16;s++)e[s]=n[s];U(e),U(e)}function z(e,t){K(e,t,t)}function G(e,t){var r,i=s();for(r=0;r<16;r++)i[r]=t[r];for(r=253;r>=0;r--)z(i,i),2!==r&&4!==r&&K(i,i,t);for(r=0;r<16;r++)e[r]=i[r]}function V(e,t){var r,i=s();for(r=0;r<16;r++)i[r]=t[r];for(r=250;r>=0;r--)z(i,i),1!==r&&K(i,i,t);for(r=0;r<16;r++)e[r]=i[r]}function W(e,t,r){var i,n,o=new Uint8Array(32),a=new Float64Array(80),h=s(),l=s(),u=s(),d=s(),f=s(),p=s();for(n=0;n<31;n++)o[n]=t[n];for(o[31]=127&t[31]|64,o[0]&=248,D(a,r),n=0;n<16;n++)l[n]=a[n],d[n]=h[n]=u[n]=0;for(n=254,h[0]=d[0]=1;n>=0;--n)q(h,l,i=o[n>>>3]>>>(7&n)&1),q(u,d,i),H(f,h,u),J(h,h,u),H(u,l,d),J(l,l,d),z(d,f),z(p,h),K(h,u,h),K(u,l,f),H(f,h,u),J(h,h,u),z(l,h),J(u,d,p),K(h,u,c),H(h,h,d),K(u,u,h),K(h,d,p),K(d,l,a),z(l,f),q(h,l,i),q(u,d,i);for(n=0;n<16;n++)a[n+16]=h[n],a[n+32]=u[n],a[n+48]=l[n],a[n+64]=d[n];var m=a.subarray(32),g=a.subarray(16);return G(m,m),K(g,g,m),F(e,g),0}function Y(e,t){return W(e,t,o)}function X(e,t){return i(t,32),Y(e,t)}function Z(e,t,r){var s=new Uint8Array(32);return W(s,r,t),x(e,n,s,P)}function Q(){var e,t,s,i=0,n=0,o=0,a=0;for(s=0;s<arguments.length;s++)e=arguments[s].lo,t=arguments[s].hi,i+=65535&e,n+=e>>>16,o+=65535&t,a+=t>>>16;return n+=i>>>16,o+=n>>>16,a+=o>>>16,new r(65535&o|a<<16,65535&i|n<<16)}function ee(e,t){return new r(e.hi>>>t,e.lo>>>t|e.hi<<32-t)}function et(){var e,t=0,s=0;for(e=0;e<arguments.length;e++)t^=arguments[e].lo,s^=arguments[e].hi;return new r(s,t)}function er(e,t){var s,i,n=32-t;return t<32?(s=e.hi>>>t|e.lo<<n,i=e.lo>>>t|e.hi<<n):t<64&&(s=e.lo>>>t|e.hi<<n,i=e.hi>>>t|e.lo<<n),new r(s,i)}var es=[new r(1116352408,3609767458),new r(1899447441,602891725),new r(3049323471,3964484399),new r(3921009573,2173295548),new r(961987163,4081628472),new r(1508970993,3053834265),new r(2453635748,2937671579),new r(2870763221,3664609560),new r(3624381080,2734883394),new r(310598401,1164996542),new r(607225278,1323610764),new r(1426881987,3590304994),new r(1925078388,4068182383),new r(2162078206,991336113),new r(2614888103,633803317),new r(3248222580,3479774868),new r(3835390401,2666613458),new r(4022224774,944711139),new r(264347078,2341262773),new r(604807628,2007800933),new r(770255983,1495990901),new r(1249150122,1856431235),new r(1555081692,3175218132),new r(1996064986,2198950837),new r(2554220882,3999719339),new r(2821834349,766784016),new r(2952996808,2566594879),new r(3210313671,3203337956),new r(3336571891,1034457026),new r(3584528711,2466948901),new r(113926993,3758326383),new r(338241895,168717936),new r(666307205,1188179964),new r(773529912,1546045734),new r(1294757372,1522805485),new r(1396182291,2643833823),new r(1695183700,2343527390),new r(1986661051,1014477480),new r(2177026350,1206759142),new r(2456956037,344077627),new r(2730485921,1290863460),new r(2820302411,3158454273),new r(3259730800,3505952657),new r(3345764771,106217008),new r(3516065817,3606008344),new r(3600352804,1432725776),new r(4094571909,1467031594),new r(275423344,851169720),new r(430227734,3100823752),new r(506948616,1363258195),new r(659060556,3750685593),new r(883997877,3785050280),new r(958139571,3318307427),new r(1322822218,3812723403),new r(1537002063,2003034995),new r(1747873779,3602036899),new r(1955562222,1575990012),new r(2024104815,1125592928),new r(2227730452,2716904306),new r(2361852424,442776044),new r(2428436474,593698344),new r(2756734187,3733110249),new r(3204031479,2999351573),new r(3329325298,3815920427),new r(3391569614,3928383900),new r(3515267271,566280711),new r(3940187606,3454069534),new r(4118630271,4000239992),new r(116418474,1914138554),new r(174292421,2731055270),new r(289380356,3203993006),new r(460393269,320620315),new r(685471733,587496836),new r(852142971,1086792851),new r(1017036298,365543100),new r(1126000580,2618297676),new r(1288033470,3409855158),new r(1501505948,4234509866),new r(1607167915,987167468),new r(1816402316,1246189591)];function ei(e,t,s){var i,n,o,a,h,c,l,u,d,f,p,m,g,_=[],w=[],S=[],v=[];for(m=0;m<8;m++)_[m]=S[m]=b(e,8*m);for(var E=0;s>=128;){for(m=0;m<16;m++)v[m]=b(t,8*m+E);for(m=0;m<80;m++){for(g=0;g<8;g++)w[g]=S[g];for(g=0,p=Q(S[7],et(er(i=S[4],14),er(i,18),er(i,41)),(n=S[4],o=S[5],a=S[6],new r(n.hi&o.hi^~n.hi&a.hi,n.lo&o.lo^~n.lo&a.lo)),es[m],v[m%16]),w[7]=Q(p,et(er(h=S[0],28),er(h,34),er(h,39)),(c=S[0],l=S[1],u=S[2],new r(c.hi&l.hi^c.hi&u.hi^l.hi&u.hi,c.lo&l.lo^c.lo&u.lo^l.lo&u.lo))),w[3]=Q(w[3],p);g<8;g++)S[(g+1)%8]=w[g];if(m%16==15)for(g=0;g<16;g++)v[g]=Q(v[g],v[(g+9)%16],et(er(d=v[(g+1)%16],1),er(d,8),ee(d,7)),et(er(f=v[(g+14)%16],19),er(f,61),ee(f,6)))}for(m=0;m<8;m++)S[m]=Q(S[m],_[m]),_[m]=S[m];E+=128,s-=128}for(m=0;m<8;m++)y(e,8*m,_[m]);return s}var en=new Uint8Array([106,9,230,103,243,188,201,8,187,103,174,133,132,202,167,59,60,110,243,114,254,148,248,43,165,79,245,58,95,29,54,241,81,14,82,127,173,230,130,209,155,5,104,140,43,62,108,31,31,131,217,171,251,65,189,107,91,224,205,25,19,126,33,121]);function eo(e,t,s){var i,n=new Uint8Array(64),o=new Uint8Array(256),a=s;for(i=0;i<64;i++)n[i]=en[i];for(ei(n,t,s),s%=128,i=0;i<256;i++)o[i]=0;for(i=0;i<s;i++)o[i]=t[a-s+i];for(o[s]=128,o[(s=256-128*(s<112?1:0))-9]=0,y(o,s-8,new r(a/536870912|0,a<<3)),ei(n,o,s),i=0;i<64;i++)e[i]=n[i];return 0}function ea(e,t){var r=s(),i=s(),n=s(),o=s(),a=s(),h=s(),c=s(),l=s(),d=s();J(r,e[1],e[0]),J(d,t[1],t[0]),K(r,r,d),H(i,e[0],e[1]),H(d,t[0],t[1]),K(i,i,d),K(n,e[3],t[3]),K(n,n,u),K(o,e[2],t[2]),H(o,o,o),J(a,i,r),J(h,o,n),H(c,o,n),H(l,i,r),K(e[0],a,h),K(e[1],l,c),K(e[2],c,h),K(e[3],a,l)}function eh(e,t,r){var s;for(s=0;s<4;s++)q(e[s],t[s],r)}function ec(e,t){var r=s(),i=s(),n=s();G(n,t[2]),K(r,t[0],n),K(i,t[1],n),F(e,i),e[31]^=B(r)<<7}function el(e,t,r){var s,i;for($(e[0],a),$(e[1],h),$(e[2],h),$(e[3],a),i=255;i>=0;--i)eh(e,t,s=r[i/8|0]>>(7&i)&1),ea(t,e),ea(e,e),eh(e,t,s)}function eu(e,t){var r=[s(),s(),s(),s()];$(r[0],d),$(r[1],f),$(r[2],h),K(r[3],d,f),el(e,r,t)}function ed(e,t,r){var n,o=new Uint8Array(64),a=[s(),s(),s(),s()];for(r||i(t,32),eo(o,t,32),o[0]&=248,o[31]&=127,o[31]|=64,eu(a,o),ec(e,a),n=0;n<32;n++)t[n+32]=e[n];return 0}var ef=new Float64Array([237,211,245,92,26,99,18,88,214,156,247,162,222,249,222,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16]);function ep(e,t){var r,s,i,n;for(s=63;s>=32;--s){for(r=0,i=s-32,n=s-12;i<n;++i)t[i]+=r-16*t[s]*ef[i-(s-32)],r=Math.floor((t[i]+128)/256),t[i]-=256*r;t[i]+=r,t[s]=0}for(i=0,r=0;i<32;i++)t[i]+=r-(t[31]>>4)*ef[i],r=t[i]>>8,t[i]&=255;for(i=0;i<32;i++)t[i]-=r*ef[i];for(s=0;s<32;s++)t[s+1]+=t[s]>>8,e[s]=255&t[s]}function em(e){var t,r=new Float64Array(64);for(t=0;t<64;t++)r[t]=e[t];for(t=0;t<64;t++)e[t]=0;ep(e,r)}function eg(e,t,r,i){var n,o,a=new Uint8Array(64),h=new Uint8Array(64),c=new Uint8Array(64),l=new Float64Array(64),u=[s(),s(),s(),s()];for(eo(a,i,32),a[0]&=248,a[31]&=127,a[31]|=64,n=0;n<r;n++)e[64+n]=t[n];for(n=0;n<32;n++)e[32+n]=a[32+n];for(eo(c,e.subarray(32),r+32),em(c),eu(u,c),ec(e,u),n=32;n<64;n++)e[n]=i[n];for(eo(h,e,r+64),em(h),n=0;n<64;n++)l[n]=0;for(n=0;n<32;n++)l[n]=c[n];for(n=0;n<32;n++)for(o=0;o<32;o++)l[n+o]+=h[n]*a[o];return ep(e.subarray(32),l),r+64}function eb(e,t,r,i){var n,o,c,u,d,f,m,g,b=new Uint8Array(32),_=new Uint8Array(64),y=[s(),s(),s(),s()],w=[s(),s(),s(),s()];if(r<64||(n=s(),o=s(),c=s(),u=s(),d=s(),f=s(),m=s(),($(w[2],h),D(w[1],i),z(c,w[1]),K(u,c,l),J(c,c,w[2]),H(u,w[2],u),z(d,u),z(f,d),K(m,f,d),K(n,m,c),K(n,n,u),V(n,n),K(n,n,c),K(n,n,u),K(n,n,u),K(w[0],n,u),z(o,w[0]),K(o,o,u),L(o,c)&&K(w[0],w[0],p),z(o,w[0]),K(o,o,u),L(o,c))?-1:(B(w[0])===i[31]>>7&&J(w[0],a,w[0]),K(w[3],w[0],w[1]),0)))return -1;for(g=0;g<r;g++)e[g]=t[g];for(g=0;g<32;g++)e[g+32]=i[g];if(eo(_,e,r),em(_),el(y,w,_),eu(w,t.subarray(32)),ea(y,w),ec(b,y),r-=64,v(t,0,b,0)){for(g=0;g<r;g++)e[g]=0;return -1}for(g=0;g<r;g++)e[g]=t[g+64];return r}function e_(e,t){if(32!==e.length)throw Error("bad key size");if(24!==t.length)throw Error("bad nonce size")}function ey(){for(var e=0;e<arguments.length;e++)if(!(arguments[e]instanceof Uint8Array))throw TypeError("unexpected type, use Uint8Array")}function ew(e){for(var t=0;t<e.length;t++)e[t]=0}e.lowlevel={crypto_core_hsalsa20:x,crypto_stream_xor:C,crypto_stream:O,crypto_stream_salsa20_xor:A,crypto_stream_salsa20:k,crypto_onetimeauth:N,crypto_onetimeauth_verify:M,crypto_verify_16:S,crypto_verify_32:v,crypto_secretbox:R,crypto_secretbox_open:T,crypto_scalarmult:W,crypto_scalarmult_base:Y,crypto_box_beforenm:Z,crypto_box_afternm:R,crypto_box:function(e,t,r,s,i,n){var o=new Uint8Array(32);return Z(o,i,n),R(e,t,r,s,o)},crypto_box_open:function(e,t,r,s,i,n){var o=new Uint8Array(32);return Z(o,i,n),T(e,t,r,s,o)},crypto_box_keypair:X,crypto_hash:eo,crypto_sign:eg,crypto_sign_keypair:ed,crypto_sign_open:eb,crypto_secretbox_KEYBYTES:32,crypto_secretbox_NONCEBYTES:24,crypto_secretbox_ZEROBYTES:32,crypto_secretbox_BOXZEROBYTES:16,crypto_scalarmult_BYTES:32,crypto_scalarmult_SCALARBYTES:32,crypto_box_PUBLICKEYBYTES:32,crypto_box_SECRETKEYBYTES:32,crypto_box_BEFORENMBYTES:32,crypto_box_NONCEBYTES:24,crypto_box_ZEROBYTES:32,crypto_box_BOXZEROBYTES:16,crypto_sign_BYTES:64,crypto_sign_PUBLICKEYBYTES:32,crypto_sign_SECRETKEYBYTES:64,crypto_sign_SEEDBYTES:32,crypto_hash_BYTES:64,gf:s,D:l,L:ef,pack25519:F,unpack25519:D,M:K,A:H,S:z,Z:J,pow2523:V,add:ea,set25519:$,modL:ep,scalarmult:el,scalarbase:eu},e.randomBytes=function(e){var t=new Uint8Array(e);return i(t,e),t},e.secretbox=function(e,t,r){ey(e,t,r),e_(r,t);for(var s=new Uint8Array(32+e.length),i=new Uint8Array(s.length),n=0;n<e.length;n++)s[n+32]=e[n];return R(i,s,s.length,t,r),i.subarray(16)},e.secretbox.open=function(e,t,r){ey(e,t,r),e_(r,t);for(var s=new Uint8Array(16+e.length),i=new Uint8Array(s.length),n=0;n<e.length;n++)s[n+16]=e[n];return s.length<32||0!==T(i,s,s.length,t,r)?null:i.subarray(32)},e.secretbox.keyLength=32,e.secretbox.nonceLength=24,e.secretbox.overheadLength=16,e.scalarMult=function(e,t){if(ey(e,t),32!==e.length)throw Error("bad n size");if(32!==t.length)throw Error("bad p size");var r=new Uint8Array(32);return W(r,e,t),r},e.scalarMult.base=function(e){if(ey(e),32!==e.length)throw Error("bad n size");var t=new Uint8Array(32);return Y(t,e),t},e.scalarMult.scalarLength=32,e.scalarMult.groupElementLength=32,e.box=function(t,r,s,i){var n=e.box.before(s,i);return e.secretbox(t,r,n)},e.box.before=function(e,t){ey(e,t),function(e,t){if(32!==e.length)throw Error("bad public key size");if(32!==t.length)throw Error("bad secret key size")}(e,t);var r=new Uint8Array(32);return Z(r,e,t),r},e.box.after=e.secretbox,e.box.open=function(t,r,s,i){var n=e.box.before(s,i);return e.secretbox.open(t,r,n)},e.box.open.after=e.secretbox.open,e.box.keyPair=function(){var e=new Uint8Array(32),t=new Uint8Array(32);return X(e,t),{publicKey:e,secretKey:t}},e.box.keyPair.fromSecretKey=function(e){if(ey(e),32!==e.length)throw Error("bad secret key size");var t=new Uint8Array(32);return Y(t,e),{publicKey:t,secretKey:new Uint8Array(e)}},e.box.publicKeyLength=32,e.box.secretKeyLength=32,e.box.sharedKeyLength=32,e.box.nonceLength=24,e.box.overheadLength=e.secretbox.overheadLength,e.sign=function(e,t){if(ey(e,t),64!==t.length)throw Error("bad secret key size");var r=new Uint8Array(64+e.length);return eg(r,e,e.length,t),r},e.sign.open=function(e,t){if(ey(e,t),32!==t.length)throw Error("bad public key size");var r=new Uint8Array(e.length),s=eb(r,e,e.length,t);if(s<0)return null;for(var i=new Uint8Array(s),n=0;n<i.length;n++)i[n]=r[n];return i},e.sign.detached=function(t,r){for(var s=e.sign(t,r),i=new Uint8Array(64),n=0;n<i.length;n++)i[n]=s[n];return i},e.sign.detached.verify=function(e,t,r){if(ey(e,t,r),64!==t.length)throw Error("bad signature size");if(32!==r.length)throw Error("bad public key size");var s,i=new Uint8Array(64+e.length),n=new Uint8Array(64+e.length);for(s=0;s<64;s++)i[s]=t[s];for(s=0;s<e.length;s++)i[s+64]=e[s];return eb(n,i,i.length,r)>=0},e.sign.keyPair=function(){var e=new Uint8Array(32),t=new Uint8Array(64);return ed(e,t),{publicKey:e,secretKey:t}},e.sign.keyPair.fromSecretKey=function(e){if(ey(e),64!==e.length)throw Error("bad secret key size");for(var t=new Uint8Array(32),r=0;r<t.length;r++)t[r]=e[32+r];return{publicKey:t,secretKey:new Uint8Array(e)}},e.sign.keyPair.fromSeed=function(e){if(ey(e),32!==e.length)throw Error("bad seed size");for(var t=new Uint8Array(32),r=new Uint8Array(64),s=0;s<32;s++)r[s]=e[s];return ed(t,r,!0),{publicKey:t,secretKey:r}},e.sign.publicKeyLength=32,e.sign.secretKeyLength=64,e.sign.seedLength=32,e.sign.signatureLength=64,e.hash=function(e){ey(e);var t=new Uint8Array(64);return eo(t,e,e.length),t},e.hash.hashLength=64,e.verify=function(e,t){return ey(e,t),0!==e.length&&0!==t.length&&e.length===t.length&&0===w(e,0,t,0,e.length)},e.setPRNG=function(e){i=e},(t="undefined"!=typeof globalThis?globalThis.crypto||globalThis.msCrypto:null)&&t.getRandomValues?e.setPRNG(function(e,r){var s,i=new Uint8Array(r);for(s=0;s<r;s+=65536)t.getRandomValues(i.subarray(s,s+Math.min(r-s,65536)));for(s=0;s<r;s++)e[s]=i[s];ew(i)}):"undefined"!=typeof require&&(t=require("crypto"))&&t.randomBytes&&e.setPRNG(function(e,r){var s,i=t.randomBytes(r);for(s=0;s<r;s++)e[s]=i[s];ew(i)})}("undefined"!=typeof module&&module.exports?module.exports:globalThis.nacl=globalThis.nacl||{});let tG="undefined"!=typeof module&&module.exports?module.exports:globalThis.nacl,tV={fromSeed:tG.sign.keyPair.fromSeed,sign:tG.sign.detached,verify:tG.sign.detached.verify,randomBytes:tG.randomBytes},tW=new Uint16Array([0,4129,8258,12387,16516,20645,24774,28903,33032,37161,41290,45419,49548,53677,57806,61935,4657,528,12915,8786,21173,17044,29431,25302,37689,33560,45947,41818,54205,50076,62463,58334,9314,13379,1056,5121,25830,29895,17572,21637,42346,46411,34088,38153,58862,62927,50604,54669,13907,9842,5649,1584,30423,26358,22165,18100,46939,42874,38681,34616,63455,59390,55197,51132,18628,22757,26758,30887,2112,6241,10242,14371,51660,55789,59790,63919,35144,39273,43274,47403,23285,19156,31415,27286,6769,2640,14899,10770,56317,52188,64447,60318,39801,35672,47931,43802,27814,31879,19684,23749,11298,15363,3168,7233,60846,64911,52716,56781,44330,48395,36200,40265,32407,28342,24277,20212,15891,11826,7761,3696,65439,61374,57309,53244,48923,44858,40793,36728,37256,33193,45514,41451,53516,49453,61774,57711,4224,161,12482,8419,20484,16421,28742,24679,33721,37784,41979,46042,49981,54044,58239,62302,689,4752,8947,13010,16949,21012,25207,29270,46570,42443,38312,34185,62830,58703,54572,50445,13538,9411,5280,1153,29798,25671,21540,17413,42971,47098,34713,38840,59231,63358,50973,55100,9939,14066,1681,5808,26199,30326,17941,22068,55628,51565,63758,59695,39368,35305,47498,43435,22596,18533,30726,26663,6336,2273,14466,10403,52093,56156,60223,64286,35833,39896,43963,48026,19061,23124,27191,31254,2801,6864,10931,14994,64814,60687,56684,52557,48554,44427,40424,36297,31782,27655,23652,19525,15522,11395,7392,3265,61215,65342,53085,57212,44955,49082,36825,40952,28183,32310,20053,24180,11923,16050,3793,7920]);class tY{static checksum(e){let t=0;for(let r=0;r<e.byteLength;r++)t=t<<8&65535^tW[(t>>8^e[r])&255];return t}static validate(e,t){return tY.checksum(e)==t}}let tX="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";class tZ{static encode(e){let t=0,r=0,s=new Uint8Array(e),i=new Uint8Array(2*e.byteLength),n=0;for(let e=0;e<s.byteLength;e++)for(r=r<<8|s[e],t+=8;t>=5;){let e=r>>>t-5&31;i[n++]=tX.charAt(e).charCodeAt(0),t-=5}if(t>0){let e=r<<5-t&31;i[n++]=tX.charAt(e).charCodeAt(0)}return i.slice(0,n)}static decode(e){let t=0,r=0,s=0,i=new Uint8Array(e),n=new Uint8Array(5*i.byteLength/8|0);for(let e=0;e<i.byteLength;e++){let o=String.fromCharCode(i[e]),a=tX.indexOf(o);if(-1===a)throw Error("Illegal Base32 character: "+i[e]);r=r<<5|a,(t+=5)>=8&&(n[s++]=r>>>t-8&255,t-=8)}return n.slice(0,s)}}class tQ extends Error{name;code;chainedError;constructor(e,t){super(e),this.name="NKeysError",this.code=e,this.chainedError=t}}(en=e$||(e$={})).InvalidPrefixByte="nkeys: invalid prefix byte",en.InvalidKey="nkeys: invalid key",en.InvalidPublicKey="nkeys: invalid public key",en.InvalidSeedLen="nkeys: invalid seed length",en.InvalidSeed="nkeys: invalid seed",en.InvalidEncoding="nkeys: invalid encoded key",en.InvalidSignature="nkeys: signature verification failed",en.CannotSign="nkeys: cannot sign, no private key available",en.PublicKeyOnly="nkeys: no seed or private key available",en.InvalidChecksum="nkeys: invalid checksum",en.SerializationError="nkeys: serialization error",en.ApiError="nkeys: api error",en.ClearedPair="nkeys: pair is cleared",(eo=eU||(eU={}))[eo.Seed=144]="Seed",eo[eo.Private=120]="Private",eo[eo.Operator=112]="Operator",eo[eo.Server=104]="Server",eo[eo.Cluster=16]="Cluster",eo[eo.Account=0]="Account",eo[eo.User=160]="User";class t0{static isValidPublicPrefix(e){return e==eU.Server||e==eU.Operator||e==eU.Cluster||e==eU.Account||e==eU.User}static startsWithValidPrefix(e){let t=e[0];return"S"==t||"P"==t||"O"==t||"N"==t||"C"==t||"A"==t||"U"==t}static isValidPrefix(e){return -1!=this.parsePrefix(e)}static parsePrefix(e){switch(e){case eU.Seed:return eU.Seed;case eU.Private:return eU.Private;case eU.Operator:return eU.Operator;case eU.Server:return eU.Server;case eU.Cluster:return eU.Cluster;case eU.Account:return eU.Account;case eU.User:return eU.User;default:return -1}}}class t1{static encode(e,t){if(!t||!(t instanceof Uint8Array))throw new tQ(e$.SerializationError);if(!t0.isValidPrefix(e))throw new tQ(e$.InvalidPrefixByte);return t1._encode(!1,e,t)}static encodeSeed(e,t){if(!t)throw new tQ(e$.ApiError);if(!t0.isValidPublicPrefix(e))throw new tQ(e$.InvalidPrefixByte);if(32!==t.byteLength)throw new tQ(e$.InvalidSeedLen);return t1._encode(!0,e,t)}static decode(e,t){if(!t0.isValidPrefix(e))throw new tQ(e$.InvalidPrefixByte);let r=t1._decode(t);if(r[0]!==e)throw new tQ(e$.InvalidPrefixByte);return r.slice(1)}static decodeSeed(e){let t=t1._decode(e),r=t1._decodePrefix(t);if(r[0]!=eU.Seed)throw new tQ(e$.InvalidSeed);if(!t0.isValidPublicPrefix(r[1]))throw new tQ(e$.InvalidPrefixByte);return{buf:t.slice(2),prefix:r[1]}}static _encode(e,t,r){let s=e?2:1,i=r.byteLength,n=s+i,o=new Uint8Array(s+i+2);if(e){let e=t1._encodePrefix(eU.Seed,t);o.set(e)}else o[0]=t;o.set(r,s);let a=tY.checksum(o.slice(0,n));return new DataView(o.buffer).setUint16(n,a,!0),tZ.encode(o)}static _decode(e){let t;if(e.byteLength<4)throw new tQ(e$.InvalidEncoding);try{t=tZ.decode(e)}catch(e){throw new tQ(e$.InvalidEncoding,e)}let r=t.byteLength-2,s=new DataView(t.buffer).getUint16(r,!0),i=t.slice(0,r);if(!tY.validate(i,s))throw new tQ(e$.InvalidChecksum);return i}static _encodePrefix(e,t){return new Uint8Array([e|t>>5,(31&t)<<3])}static _decodePrefix(e){let t=248&e[0],r=(7&e[0])<<5|(248&e[1])>>3;return new Uint8Array([t,r])}}class t2{seed;constructor(e){this.seed=e}getRawSeed(){if(!this.seed)throw new tQ(e$.ClearedPair);return t1.decodeSeed(this.seed).buf}getSeed(){if(!this.seed)throw new tQ(e$.ClearedPair);return this.seed}getPublicKey(){if(!this.seed)throw new tQ(e$.ClearedPair);let e=t1.decodeSeed(this.seed),t=i.fromSeed(this.getRawSeed()),r=t1.encode(e.prefix,t.publicKey);return new TextDecoder().decode(r)}getPrivateKey(){if(!this.seed)throw new tQ(e$.ClearedPair);let e=i.fromSeed(this.getRawSeed());return t1.encode(eU.Private,e.secretKey)}sign(e){if(!this.seed)throw new tQ(e$.ClearedPair);let t=i.fromSeed(this.getRawSeed());return i.sign(e,t.secretKey)}verify(e,t){if(!this.seed)throw new tQ(e$.ClearedPair);let r=i.fromSeed(this.getRawSeed());return i.verify(e,t,r.publicKey)}clear(){this.seed&&(this.seed.fill(0),this.seed=void 0)}}function t3(e){let t=i.randomBytes(32);return new t2(t1.encodeSeed(e,new Uint8Array(t)))}class t5{publicKey;constructor(e){this.publicKey=e}getPublicKey(){if(!this.publicKey)throw new tQ(e$.ClearedPair);return new TextDecoder().decode(this.publicKey)}getPrivateKey(){if(!this.publicKey)throw new tQ(e$.ClearedPair);throw new tQ(e$.PublicKeyOnly)}getSeed(){if(!this.publicKey)throw new tQ(e$.ClearedPair);throw new tQ(e$.PublicKeyOnly)}sign(e){if(!this.publicKey)throw new tQ(e$.ClearedPair);throw new tQ(e$.CannotSign)}verify(e,t){if(!this.publicKey)throw new tQ(e$.ClearedPair);let r=t1._decode(this.publicKey);return i.verify(e,t,r.slice(1))}clear(){this.publicKey&&(this.publicKey.fill(0),this.publicKey=void 0)}}i=tV;let t4={createAccount:function(){return t3(eU.Account)},createOperator:function(){return t3(eU.Operator)},createPair:t3,createUser:function(){return t3(eU.User)},fromPublic:function(e){let t=new TextEncoder().encode(e),r=t1._decode(t),s=t0.parsePrefix(r[0]);if(t0.isValidPublicPrefix(s))return new t5(t);throw new tQ(e$.InvalidPublicKey)},fromSeed:function(e){return t1.decodeSeed(e),new t2(e)},NKeysError:tQ,NKeysErrorCode:e$,Prefix:eU,decode:function(e){let t=atob(e),r=new Uint8Array(t.length);for(let e=0;e<t.length;e++)r[e]=t.charCodeAt(e);return r},encode:function(e){return btoa(String.fromCharCode(...e))}};function t6(e){var t,r;let s="function"!=typeof e?()=>e:e,i=()=>{let e=/\s*(?:(?:[-]{3,}[^\n]*[-]{3,}\n)(.+)(?:\n\s*[-]{3,}[^\n]*[-]{3,}\n))/ig,t=a.decode(s()),r=e.exec(t);if(!r)throw m.errorForCode(eW.BadCreds);let i=r[1].trim();if(!(r=e.exec(t))||!r)throw m.errorForCode(eW.BadCreds);return{jwt:i,seed:o.encode(r[1].trim())}};return t=()=>{let{jwt:e}=i();return e},r=()=>{let{seed:e}=i();return e},e=>{let s="function"==typeof t?t():t,{nkey:i,sig:n}=(e=>{let t="function"==typeof r?r():r,s=t?t4.fromSeed(t):void 0,i=s?s.getPublicKey():"",n=o.encode(e||""),a=void 0!==s&&e?s.sign(n):void 0;return{nkey:i,sig:a?t4.encode(a):""}})(e);return{jwt:s,nkey:i,sig:n}}}let t8=/^INFO\s+([^\r\n]+)\r\n/i,t7=h("PONG\r\n"),t9=h("PING\r\n");class re{echo;no_responders;protocol;verbose;pedantic;jwt;nkey;sig;user;pass;auth_token;tls_required;name;lang;version;headers;constructor(e,t,r){this.protocol=1,this.version=e.version,this.lang=e.lang,this.echo=!t.noEcho&&void 0,this.verbose=t.verbose,this.pedantic=t.pedantic,this.tls_required=!!t.tls||void 0,this.name=t.name,S(this,(t&&"function"==typeof t.authenticator?t.authenticator(r):{})||{})}}class rt extends z{sid;queue;draining;max;subject;drained;protocol;timer;info;cleanupFn;closed;requestSubject;constructor(e,t,r={}){super(),S(this,r),this.protocol=e,this.subject=t,this.draining=!1,this.noIterator="function"==typeof r.callback,this.closed=P();let s=!e.options?.noAsyncTraces;r.timeout&&(this.timer=E(r.timeout,s),this.timer.then(()=>{this.timer=void 0}).catch(e=>{this.stop(e),this.noIterator&&this.callback(e,{})})),this.noIterator||this.iterClosed.then(()=>{this.closed.resolve(),this.unsubscribe()})}setPrePostHandlers(e){if(this.noIterator){let t=this.callback,r=e.ingestionFilterFn?e.ingestionFilterFn:()=>({ingest:!0,protocol:!1}),s=e.protocolFilterFn?e.protocolFilterFn:()=>!0,i=e.dispatchedFn?e.dispatchedFn:()=>{};this.callback=(e,n)=>{let{ingest:o}=r(n);o&&s(n)&&(t(e,n),i(n))}}else this.protocolFilterFn=e.protocolFilterFn,this.dispatchedFn=e.dispatchedFn}callback(e,t){this.cancelTimeout(),e?this.stop(e):this.push(t)}close(){if(!this.isClosed()){this.cancelTimeout();let e=()=>{if(this.stop(),this.cleanupFn)try{this.cleanupFn(this,this.info)}catch(e){}this.closed.resolve()};this.noIterator?e():this.push(e)}}unsubscribe(e){this.protocol.unsubscribe(this,e)}cancelTimeout(){this.timer&&(this.timer.cancel(),this.timer=void 0)}drain(){return this.protocol.isClosed()?Promise.reject(m.errorForCode(eW.ConnectionClosed)):this.isClosed()?Promise.reject(m.errorForCode(eW.SubClosed)):(this.drained||(this.draining=!0,this.protocol.unsub(this),this.drained=this.protocol.flush(P()).then(()=>{this.protocol.subscriptions.cancel(this)}).catch(()=>{this.protocol.subscriptions.cancel(this)})),this.drained)}isDraining(){return this.draining}isClosed(){return this.done}getSubject(){return this.subject}getMax(){return this.max}getID(){return this.sid}}class rr{mux;subs;sidCounter;constructor(){this.sidCounter=0,this.mux=null,this.subs=new Map}size(){return this.subs.size}add(e){return this.sidCounter++,e.sid=this.sidCounter,this.subs.set(e.sid,e),e}setMux(e){return this.mux=e,e}getMux(){return this.mux}get(e){return this.subs.get(e)}resub(e){return this.sidCounter++,this.subs.delete(e.sid),e.sid=this.sidCounter,this.subs.set(e.sid,e),e}all(){return Array.from(this.subs.values())}cancel(e){e&&(e.close(),this.subs.delete(e.sid))}handleError(e){if(e&&e.permissionContext){let t;let r=e.permissionContext,s=this.all();if("subscription"===r.operation&&(t=s.find(e=>e.subject===r.subject&&e.queue===r.queue)),"publish"===r.operation&&(t=s.find(e=>e.requestSubject===r.subject)),t)return t.callback(e,{}),t.close(),this.subs.delete(t.sid),t!==this.mux}return!1}close(){this.subs.forEach(e=>{e.close()})}}class rs{connected;connectedOnce;infoReceived;info;muxSubscriptions;options;outbound;pongs;subscriptions;transport;noMorePublishing;connectError;publisher;_closed;closed;listeners;heartbeats;parser;outMsgs;inMsgs;outBytes;inBytes;pendingLimit;lastError;abortReconnect;whyClosed;servers;server;features;connectPromise;constructor(e,t){this._closed=!1,this.connected=!1,this.connectedOnce=!1,this.infoReceived=!1,this.noMorePublishing=!1,this.abortReconnect=!1,this.listeners=[],this.pendingLimit=32768,this.outMsgs=0,this.inMsgs=0,this.outBytes=0,this.inBytes=0,this.options=e,this.publisher=t,this.subscriptions=new rr,this.muxSubscriptions=new tF,this.outbound=new Q,this.pongs=[],this.whyClosed="",this.pendingLimit=e.pendingLimit||this.pendingLimit,this.features=new tx({major:0,minor:0,micro:0}),this.connectPromise=null;let r="string"==typeof e.servers?[e.servers]:e.servers;this.servers=new tq(r,{randomize:!e.noRandomize}),this.closed=P(),this.parser=new tz(this),this.heartbeats=new tL(this,this.options.pingInterval||12e4,this.options.maxPingOut||2)}resetOutbound(){this.outbound.reset();let e=this.pongs;this.pongs=[];let t=m.errorForCode(eW.Disconnect);t.stack="",e.forEach(e=>{e.reject(t)}),this.parser=new tz(this),this.infoReceived=!1}dispatchStatus(e){this.listeners.forEach(t=>{t.push(e)})}status(){let e=new z;return this.listeners.push(e),e}prepare(){this.transport&&this.transport.discard(),this.info=void 0,this.resetOutbound();let e=P();return e.catch(()=>{}),this.pongs.unshift(e),this.connectError=t=>{e.reject(t)},this.transport=function(){if(!s||"function"!=typeof s.factory)throw Error("transport fn is not set");return s.factory()}(),this.transport.closed().then(async e=>{if(this.connected=!1,!this.isClosed()){await this.disconnected(this.transport.closeError||this.lastError);return}}),e}disconnect(){this.dispatchStatus({type:eV.StaleConnection,data:""}),this.transport.disconnect()}reconnect(){return this.connected&&(this.dispatchStatus({type:eV.ClientInitiatedReconnect,data:""}),this.transport.disconnect()),Promise.resolve()}async disconnected(e){this.dispatchStatus({type:eG.Disconnect,data:this.servers.getCurrentServer().toString()}),this.options.reconnect?await this.dialLoop().then(()=>{this.dispatchStatus({type:eG.Reconnect,data:this.servers.getCurrentServer().toString()}),this.lastError?.code===eW.AuthenticationExpired&&(this.lastError=void 0)}).catch(e=>{this._close(e)}):await this._close(e)}async dial(e){let t;let r=this.prepare();try{t=E(this.options.timeout||2e4);let r=this.transport.connect(e,this.options);await Promise.race([r,t]),(async()=>{try{for await(let e of this.transport)this.parser.parse(e)}catch(e){console.log("reader closed",e)}})().then()}catch(e){r.reject(e)}try{await Promise.race([t,r]),t&&t.cancel(),this.connected=!0,this.connectError=void 0,this.sendSubscriptions(),this.connectedOnce=!0,this.server.didConnect=!0,this.server.reconnects=0,this.flushPending(),this.heartbeats.start()}catch(e){throw t&&t.cancel(),await this.transport.close(e),e}}async _doDial(e){let{resolve:t}=this.options,r=await e.resolve({fn:tj(),debug:this.options.debug,randomize:!this.options.noRandomize,resolve:t}),s=null;for(let e of r)try{s=null,this.dispatchStatus({type:eV.Reconnecting,data:e.toString()}),await this.dial(e);return}catch(e){s=e}throw s}dialLoop(){return null===this.connectPromise&&(this.connectPromise=this.dodialLoop(),this.connectPromise.then(()=>{}).catch(()=>{}).finally(()=>{this.connectPromise=null})),this.connectPromise}async dodialLoop(){let e;for(;;){this._closed&&this.servers.clear();let t=this.options.reconnectDelayHandler?this.options.reconnectDelayHandler():2e3,r=t,s=this.selectServer();if(!s||this.abortReconnect){if(e)throw e;if(this.lastError)throw this.lastError;throw m.errorForCode(eW.ConnectionRefused)}let i=Date.now();if(0===s.lastConnect||s.lastConnect+t<=i){s.lastConnect=Date.now();try{await this._doDial(s);break}catch(r){if(e=r,!this.connectedOnce){if(this.options.waitOnFirstConnect)continue;this.servers.removeCurrentServer()}s.reconnects++;let t=this.options.maxReconnectAttempts||0;-1!==t&&s.reconnects>=t&&this.servers.removeCurrentServer()}}else r=Math.min(r,s.lastConnect+t-i),await x(r)}}static async connect(e,t){let r=new rs(e,t);return await r.dialLoop(),r}static toError(e){let t=e?e.toLowerCase():"";if(-1!==t.indexOf("permissions violation")){let t=new m(e,eW.PermissionsViolation),r=e.match(/(Publish|Subscription) to "(\S+)"/);if(r){t.permissionContext={operation:r[1].toLowerCase(),subject:r[2],queue:void 0};let s=e.match(/using queue "(\S+)"/);s&&(t.permissionContext.queue=s[1])}return t}return -1!==t.indexOf("authorization violation")?new m(e,eW.AuthorizationViolation):-1!==t.indexOf("user authentication expired")?new m(e,eW.AuthenticationExpired):-1!=t.indexOf("account authentication expired")?new m(e,eW.AccountExpired):-1!==t.indexOf("authentication timeout")?new m(e,eW.AuthenticationTimeout):new m(e,eW.ProtocolError)}processMsg(e,t){if(this.inMsgs++,this.inBytes+=t.length,!this.subscriptions.sidCounter)return;let r=this.subscriptions.get(e.sid);r&&(r.received+=1,r.callback&&r.callback(null,new U(e,t,this)),void 0!==r.max&&r.received>=r.max&&r.unsubscribe())}processError(e){let t=c(e),r=rs.toError(t),s={type:eG.Error,data:r.code};if(r.isPermissionError()){let e=!1;if(r.permissionContext){s.permissionContext=r.permissionContext;let t=this.subscriptions.getMux();e=t?.subject===r.permissionContext.subject}this.subscriptions.handleError(r),this.muxSubscriptions.handleError(e,r),e&&this.subscriptions.setMux(null)}this.dispatchStatus(s),this.handleError(r)}handleError(e){e.isAuthError()?this.handleAuthError(e):e.isProtocolError()?this.lastError=e:e.isAuthTimeout()&&(this.lastError=e),e.isPermissionError()||(this.lastError=e)}handleAuthError(e){this.lastError&&e.code===this.lastError.code&&!1===this.options.ignoreAuthErrorAbort&&(this.abortReconnect=!0),this.connectError?this.connectError(e):this.disconnect()}processPing(){this.transport.send(t7)}processPong(){let e=this.pongs.shift();e&&e.resolve()}processInfo(e){let t=JSON.parse(c(e));this.info=t;let r=this.options&&this.options.ignoreClusterUpdates?void 0:this.servers.update(t,this.transport.isEncrypted());if(!this.infoReceived){this.features.update(tv(t.version)),this.infoReceived=!0,this.transport.isEncrypted()&&this.servers.updateTLSName();let{version:e,lang:r}=this.transport;try{let s=new re({version:e,lang:r},this.options,t.nonce);t.headers&&(s.headers=!0,s.no_responders=!0);let i=JSON.stringify(s);this.transport.send(h(`CONNECT ${i}\r
`)),this.transport.send(t9)}catch(e){this._close(e)}}r&&this.dispatchStatus({type:eG.Update,data:r}),void 0!==t.ldm&&t.ldm&&this.dispatchStatus({type:eG.LDM,data:this.servers.getCurrentServer().toString()})}push(e){switch(e.kind){case eM.MSG:{let{msg:t,data:r}=e;this.processMsg(t,r);break}case eM.OK:break;case eM.ERR:this.processError(e.data);break;case eM.PING:this.processPing();break;case eM.PONG:this.processPong();break;case eM.INFO:this.processInfo(e.data)}}sendCommand(e,...t){let r;let s=this.outbound.length();r="string"==typeof e?h(e):e,this.outbound.fill(r,...t),0===s?queueMicrotask(()=>{this.flushPending()}):this.outbound.size()>=this.pendingLimit&&this.flushPending()}publish(e,t=n,r){let s,i;if(t instanceof Uint8Array)s=t;else if("string"==typeof t)s=o.encode(t);else throw m.errorForCode(eW.BadPayload);let a=s.length;(r=r||{}).reply=r.reply||"";let h=n,c=0;if(r.headers){if(this.info&&!this.info.headers)throw new m("headers",eW.ServerOptionNotAvailable);c=(h=r.headers.encode()).length,a=s.length+c}if(this.info&&a>this.info.max_payload)throw m.errorForCode(eW.MaxPayloadExceeded);this.outBytes+=a,this.outMsgs++,r.headers?(i=r.reply?`HPUB ${e} ${r.reply} ${c} ${a}\r
`:`HPUB ${e} ${c} ${a}\r
`,this.sendCommand(i,h,s,tI)):(i=r.reply?`PUB ${e} ${r.reply} ${a}\r
`:`PUB ${e} ${a}\r
`,this.sendCommand(i,s,tI))}request(e){return this.initMux(),this.muxSubscriptions.add(e),e}subscribe(e){return this.subscriptions.add(e),this._subunsub(e),e}_sub(e){e.queue?this.sendCommand(`SUB ${e.subject} ${e.queue} ${e.sid}\r
`):this.sendCommand(`SUB ${e.subject} ${e.sid}\r
`)}_subunsub(e){return this._sub(e),e.max&&this.unsubscribe(e,e.max),e}unsubscribe(e,t){this.unsub(e,t),(void 0===e.max||e.received>=e.max)&&this.subscriptions.cancel(e)}unsub(e,t){!e||this.isClosed()||(t?this.sendCommand(`UNSUB ${e.sid} ${t}\r
`):this.sendCommand(`UNSUB ${e.sid}\r
`),e.max=t)}resub(e,t){!e||this.isClosed()||(this.unsub(e),e.subject=t,this.subscriptions.resub(e),this._sub(e))}flush(e){return e||(e=P()),this.pongs.push(e),this.outbound.fill(t9),this.flushPending(),e}sendSubscriptions(){let e=[];this.subscriptions.all().forEach(t=>{t.queue?e.push(`SUB ${t.subject} ${t.queue} ${t.sid}\r
`):e.push(`SUB ${t.subject} ${t.sid}\r
`)}),e.length&&this.transport.send(h(e.join("")))}async _close(e){this._closed||(this.whyClosed=Error("close trace").stack||"",this.heartbeats.cancel(),this.connectError&&(this.connectError(e),this.connectError=void 0),this.muxSubscriptions.close(),this.subscriptions.close(),this.listeners.forEach(e=>{e.stop()}),this._closed=!0,await this.transport.close(e),await this.closed.resolve(e))}close(){return this._close()}isClosed(){return this._closed}drain(){let e=this.subscriptions.all(),t=[];return e.forEach(e=>{t.push(e.drain())}),Promise.all(t).then(async()=>(this.noMorePublishing=!0,await this.flush(),this.close())).catch(()=>{})}flushPending(){if(this.infoReceived&&this.connected&&this.outbound.size()){let e=this.outbound.drain();this.transport.send(e)}}initMux(){if(!this.subscriptions.getMux()){let e=this.muxSubscriptions.init(this.options.inboxPrefix),t=new rt(this,`${e}*`);t.callback=this.muxSubscriptions.dispatcher(),this.subscriptions.setMux(t),this.subscribe(t)}}selectServer(){let e=this.servers.selectServer();if(void 0!==e)return this.server=e,this.server}getServer(){return this.server}}class ri{msg;constructor(e){this.msg=e}get data(){return this.msg.data}get sid(){return this.msg.sid}get subject(){return this.msg.subject}get reply(){return this.msg.reply||""}get headers(){return this.msg.headers}respond(e,t){return this.msg.respond(e,t)}respondError(e,t,r,s){return(s=s||{}).headers=s.headers||I(),s.headers?.set(b,`${e}`),s.headers?.set(g,t),this.msg.respond(r,s)}json(e){return this.msg.json(e)}string(){return this.msg.string()}}class rn{subject;queue;srv;constructor(e,t="",r=""){""!==t&&function(e,t){if(-1!==t.indexOf(" "))throw Error(`${e} cannot contain spaces: '${t}'`);t.split(".").forEach(r=>{if(">"===r)throw Error(`${e} name cannot contain internal '>': '${t}'`)})}("service group",t);let s="";if(e instanceof ro)this.srv=e,s="";else if(e instanceof rn)this.srv=e.srv,""===r&&""!==e.queue&&(r=e.queue),s=e.subject;else throw Error("unknown ServiceGroup type");this.subject=this.calcSubject(s,t),this.queue=r}calcSubject(e,t=""){return""===t?e:""!==e?`${e}.${t}`:t}addEndpoint(e="",t){let r="function"==typeof(t=t||{subject:e})?{handler:t,subject:e}:t;B("endpoint",e);let{subject:s,handler:i,metadata:n,queue:o}=r;s=s||e,o=o||this.queue,function(e,t){if(""===t)throw Error(`${e} cannot be empty`);if(-1!==t.indexOf(" "))throw Error(`${e} cannot contain spaces: '${t}'`);let r=t.split(".");r.forEach((s,i)=>{if(">"===s&&i!==r.length-1)throw Error(`${e} cannot have internal '>': '${t}'`)})}("endpoint subject",s);let a={name:e,subject:s=this.calcSubject(this.subject,s),queue:o,handler:i,metadata:n};return this.srv._addEndpoint(a)}addGroup(e="",t=""){return new rn(this,e,t)}}class ro{nc;_id;config;handlers;internal;_stopped;_done;started;static controlSubject(e,t="",r="",s){let i=s??"$SRV";return""===t&&""===r?`${i}.${e}`:(B("control subject name",t),""!==r)?(B("control subject id",r),`${i}.${e}.${t}.${r}`):`${i}.${e}.${t}`}constructor(e,t={name:"",version:""}){this.nc=e,this.config=Object.assign({},t),this.config.queue||(this.config.queue="q"),B("name",this.config.name),B("queue",this.config.queue),tv(this.config.version),this._id=d.next(),this.internal=[],this._done=P(),this._stopped=!1,this.handlers=[],this.started=new Date().toISOString(),this.reset(),this.nc.closed().then(()=>{this.close().catch()}).catch(e=>{this.close(e).catch()})}get subjects(){return this.handlers.filter(e=>!1===e.internal).map(e=>e.subject)}get id(){return this._id}get name(){return this.config.name}get description(){return this.config.description??""}get version(){return this.config.version}get metadata(){return this.config.metadata}errorToHeader(e){let t=I();return e instanceof _?(t.set(g,e.message),t.set(b,`${e.code}`)):(t.set(g,e.message),t.set(b,"500")),t}setupHandler(e,t=!1){let r=t?"":e.queue?e.queue:this.config.queue,{name:s,subject:i,handler:o}=e;e.internal=t,t&&this.internal.push(e),e.stats=new ra(s,i,r),e.queue=r;let a=o?(t,r)=>{if(t){this.close(t);return}let s=Date.now();try{o(t,new ri(r))}catch(t){e.stats.countError(t),r?.respond(n,{headers:this.errorToHeader(t)})}finally{e.stats.countLatency(s)}}:void 0;return e.sub=this.nc.subscribe(i,{callback:a,queue:r}),e.sub.closed.then(()=>{this._stopped||this.close(Error(`required subscription ${e.subject} stopped`)).catch()}).catch(t=>{if(!this._stopped){let r=Error(`required subscription ${e.subject} errored: ${t.message}`);r.stack=t.stack,this.close(r).catch()}}),e}info(){return{type:eZ.INFO,name:this.name,id:this.id,version:this.version,description:this.description,metadata:this.metadata,endpoints:this.endpoints()}}endpoints(){return this.handlers.map(e=>{let{subject:t,metadata:r,name:s,queue:i}=e;return{subject:t,metadata:r,name:s,queue_group:i}})}async stats(){let e=[];for(let t of this.handlers){if("function"==typeof this.config.statsHandler)try{t.stats.data=await this.config.statsHandler(t)}catch(e){t.stats.countError(e)}e.push(t.stats.stats(t.qi))}return{type:eZ.STATS,name:this.name,id:this.id,version:this.version,started:this.started,metadata:this.metadata,endpoints:e}}addInternalHandler(e,t){let r=`${e}`.toUpperCase();this._doAddInternalHandler(`${r}-all`,e,t),this._doAddInternalHandler(`${r}-kind`,e,t,this.name),this._doAddInternalHandler(`${r}`,e,t,this.name,this.id)}_doAddInternalHandler(e,t,r,s="",i=""){let n={};n.name=e,n.subject=ro.controlSubject(t,s,i),n.handler=r,this.setupHandler(n,!0)}start(){let e=T(),t=e.encode(this.ping());return this.addInternalHandler(eQ.PING,(e,r)=>e?(this.close(e).then().catch(),Promise.reject(e)):(r.respond(t),Promise.resolve())),this.addInternalHandler(eQ.STATS,(t,r)=>t?(this.close(t),Promise.reject(t)):this.stats().then(t=>(r?.respond(e.encode(t)),Promise.resolve()))),this.addInternalHandler(eQ.INFO,(t,r)=>t?(this.close(t),Promise.reject(t)):(r?.respond(e.encode(this.info())),Promise.resolve())),this.handlers.forEach(e=>{let{subject:t}=e;"string"==typeof t&&null!==e.handler&&this.setupHandler(e)}),Promise.resolve(this)}close(e){if(this._stopped)return this._done;this._stopped=!0;let t=[];return this.nc.isClosed()||(t=this.handlers.concat(this.internal).map(e=>e.sub.drain())),Promise.allSettled(t).then(()=>{this._done.resolve(e||null)}),this._done}get stopped(){return this._done}get isStopped(){return this._stopped}stop(e){return this.close(e)}ping(){return{type:eZ.PING,name:this.name,id:this.id,version:this.version,metadata:this.metadata}}reset(){if(this.started=new Date().toISOString(),this.handlers)for(let e of this.handlers)e.stats.reset(e.qi)}addGroup(e,t){return new rn(this,e,t)}addEndpoint(e,t){return new rn(this).addEndpoint(e,t)}_addEndpoint(e){let t=new z;t.noIterator="function"==typeof e.handler,t.noIterator||(e.handler=(e,r)=>{e?this.stop(e).catch():t.push(new ri(r))},t.iterClosed.then(()=>{this.close().catch()}));let r=this.setupHandler(e,!1);return r.qi=t,this.handlers.push(r),t}}class ra{name;subject;average_processing_time;num_requests;processing_time;num_errors;last_error;data;metadata;queue;constructor(e,t,r=""){this.name=e,this.subject=t,this.average_processing_time=0,this.num_errors=0,this.num_requests=0,this.processing_time=0,this.queue=r}reset(e){this.num_requests=0,this.processing_time=0,this.average_processing_time=0,this.num_errors=0,this.last_error=void 0,this.data=void 0,e&&(e.time=0,e.processed=0)}countLatency(e){this.num_requests++,this.processing_time+=O(Date.now()-e),this.average_processing_time=Math.round(this.processing_time/this.num_requests)}countError(e){this.num_errors++,this.last_error=e.message}_stats(){let{name:e,subject:t,average_processing_time:r,num_errors:s,num_requests:i,processing_time:n,last_error:o,data:a,queue:h}=this;return{name:e,subject:t,average_processing_time:r,num_errors:s,num_requests:i,processing_time:n,last_error:o,data:a,queue_group:h}}stats(e){return e?.noIterator===!1&&(this.processing_time=O(e.time),this.num_requests=e.processed,this.average_processing_time=this.processing_time>0&&this.num_requests>0?this.processing_time/this.num_requests:0),this._stats()}}class rh{nc;prefix;opts;constructor(e,t={strategy:eX.JitterTimer,maxWait:2e3},r){this.nc=e,this.prefix=r,this.opts=t}ping(e="",t=""){return this.q(eQ.PING,e,t)}stats(e="",t=""){return this.q(eQ.STATS,e,t)}info(e="",t=""){return this.q(eQ.INFO,e,t)}async q(e,t="",r=""){let s=new z,i=T(),o=ro.controlSubject(e,t,r,this.prefix),a=await this.nc.requestMany(o,n,this.opts);return(async()=>{for await(let e of a)try{let t=i.decode(e.data);s.push(t)}catch(e){s.push(()=>{s.stop(e)})}s.push(()=>{s.stop()})})().catch(e=>{s.stop(e)}),s}}function rc(){return{key:{encode:e=>e,decode:e=>e},value:{encode:e=>e,decode:e=>e}}}let rl="KV-Operation",ru=/^[-/=.\w]+$/,rd=/^[-/=.>*\w]+$/,rf=/^[-\w]+$/;function rp(e){if(e.startsWith(".")||e.endsWith(".")||!ru.test(e))throw Error(`invalid key: ${e}`)}function rm(e){if(e.startsWith(".")||e.endsWith(".")||!rd.test(e))throw Error(`invalid key: ${e}`)}function rg(e){if(e.startsWith(".")||e.endsWith("."))throw Error(`invalid key: ${e}`);let t=e.split("."),r=!1;for(let s=0;s<t.length;s++)switch(t[s]){case"*":r=!0;break;case">":if(s!==t.length-1)throw Error(`invalid key: ${e}`);r=!0}return r}function rb(e){if(!rf.test(e))throw Error(`invalid bucket name: ${e}`)}(ea=eq||(eq={})).MsgIdHdr="Nats-Msg-Id",ea.ExpectedStreamHdr="Nats-Expected-Stream",ea.ExpectedLastSeqHdr="Nats-Expected-Last-Sequence",ea.ExpectedLastMsgIdHdr="Nats-Expected-Last-Msg-Id",ea.ExpectedLastSubjectSequenceHdr="Nats-Expected-Last-Subject-Sequence";class r_{js;jsm;stream;bucket;direct;codec;prefix;editPrefix;useJsPrefix;_prefixLen;constructor(e,t,r){rb(e),this.js=t,this.jsm=r,this.bucket=e,this.prefix="$KV",this.editPrefix="",this.useJsPrefix=!1,this._prefixLen=0}static async create(e,t,r={}){rb(t);let s=await e.jetstreamManager(),i=new r_(t,e,s);return await i.init(r),i}static async bind(e,t,r={}){let s=await e.jetstreamManager(),i={config:{allow_direct:r.allow_direct}};rb(t);let n=new r_(t,e,s);return i.config.name=r.streamName??n.bucketName(),Object.assign(n,i),n.stream=i.config.name,n.codec=r.codec||rc(),n.direct=i.config.allow_direct??!1,n.initializePrefixes(i),n}async init(e={}){let t;let r=Object.assign({replicas:1,history:1,timeout:2e3,max_bytes:-1,maxValueSize:-1,codec:rc(),storage:e3.File},e);this.codec=r.codec;let s={};this.stream=s.name=e.streamName??this.bucketName(),s.retention=e1.Limits,s.max_msgs_per_subject=r.history,r.maxBucketSize&&(r.max_bytes=r.maxBucketSize),r.max_bytes&&(s.max_bytes=r.max_bytes),s.max_msg_size=r.maxValueSize,s.storage=r.storage;let i=e.placementCluster??"";if(i&&(e.placement={},e.placement.cluster=i,e.placement.tags=[]),e.placement&&(s.placement=e.placement),e.republish&&(s.republish=e.republish),e.description&&(s.description=e.description),e.mirror){let t=Object.assign({},e.mirror);t.name.startsWith("KV_")||(t.name=`KV_${t.name}`),s.mirror=t,s.mirror_direct=!0}else if(e.sources){let t=e.sources.map(e=>{let t=Object.assign({},e),r=t.name.startsWith("KV_")?t.name.substring(3):t.name;return t.name.startsWith("KV_")||(t.name=`KV_${t.name}`),e.external||r===this.bucket||(t.subject_transforms=[{src:`$KV.${r}.>`,dest:`$KV.${this.bucket}.>`}]),t});s.sources=t,s.subjects=[this.subjectForBucket()]}else s.subjects=[this.subjectForBucket()];e.metadata&&(s.metadata=e.metadata),"boolean"==typeof e.compression&&(s.compression=e.compression?e8.S2:e8.None);let n=this.js.nc,o=n.getServerVersion(),a=!!o&&tE(o,tv("2.7.2"))>=0;s.discard=a?e2.New:e2.Old;let{ok:h,min:c}=n.features.get(eN.JS_ALLOW_DIRECT);if(!h&&!0===e.allow_direct){let e=o?`${o.major}.${o.minor}.${o.micro}`:"unknown";return Promise.reject(Error(`allow_direct is not available on server version ${e} - requires ${c}`))}e.allow_direct="boolean"==typeof e.allow_direct?e.allow_direct:h,s.allow_direct=e.allow_direct,this.direct=s.allow_direct,s.num_replicas=r.replicas,r.ttl&&(s.max_age=O(r.ttl)),s.allow_rollup_hdrs=!0;try{(t=await this.jsm.streams.info(s.name)).config.allow_direct||!0!==this.direct||(this.direct=!1)}catch(e){if("stream not found"===e.message)t=await this.jsm.streams.add(s);else throw e}this.initializePrefixes(t)}initializePrefixes(e){this._prefixLen=0,this.prefix=`$KV.${this.bucket}`,this.useJsPrefix="$JS.API"!==this.js.apiPrefix;let{mirror:t}=e.config;if(t){let e=t.name;if(e.startsWith("KV_")&&(e=e.substring(3)),t.external&&""!==t.external.api){let r=t.name.substring(3);this.useJsPrefix=!1,this.prefix=`$KV.${r}`,this.editPrefix=`${t.external.api}.$KV.${e}`}else this.editPrefix=this.prefix}}bucketName(){return this.stream??`KV_${this.bucket}`}subjectForBucket(){return`${this.prefix}.${this.bucket}.>`}subjectForKey(e,t=!1){let r=[];return t?(this.useJsPrefix&&r.push(this.js.apiPrefix),""!==this.editPrefix?r.push(this.editPrefix):r.push(this.prefix)):this.prefix&&r.push(this.prefix),r.push(e),r.join(".")}fullKeyName(e){return""!==this.prefix?`${this.prefix}.${e}`:`$KV.${this.bucket}.${e}`}get prefixLen(){return 0===this._prefixLen&&(this._prefixLen=this.prefix.length+1),this._prefixLen}encodeKey(e){let t=[];for(let r of e.split("."))switch(r){case">":case"*":t.push(r);break;default:t.push(this.codec.key.encode(r))}return t.join(".")}decodeKey(e){let t=[];for(let r of e.split("."))switch(r){case">":case"*":t.push(r);break;default:t.push(this.codec.key.decode(r))}return t.join(".")}validateKey=rp;validateSearchKey=rm;hasWildcards=rg;close(){return Promise.resolve()}dataLen(e,t){let r=t&&t.get(te.MessageSizeHdr)||"";return""!==r?parseInt(r,10):e.length}smToEntry(e){return new rY(this.bucket,this.prefixLen,e)}jmToEntry(e){let t=this.decodeKey(e.subject.substring(this.prefixLen));return new rX(this.bucket,t,e)}async create(e,t){let r;try{let r=await this.put(e,t,{previousSeq:0});return Promise.resolve(r)}catch(e){if(r=e,e?.api_error?.err_code!==10071)return Promise.reject(e)}let s=0;try{let i=await this.get(e);if(i?.operation==="DEL"||i?.operation==="PURGE")return s=null!==i?i.revision:0,this.update(e,t,s);return Promise.reject(r)}catch(e){return Promise.reject(e)}}update(e,t,r){if(r<=0)throw Error("version must be greater than 0");return this.put(e,t,{previousSeq:r})}async put(e,t,r={}){let s=this.encodeKey(e);this.validateKey(s);let i={};if(void 0!==r.previousSeq){let e=I();i.headers=e,e.set(eq.ExpectedLastSubjectSequenceHdr,`${r.previousSeq}`)}try{return(await this.js.publish(this.subjectForKey(s,!0),t,i)).seq}catch(e){if(e.isJetStreamError())return e.message=e.api_error?.description,e.code=`${e.api_error?.code}`,Promise.reject(e);return Promise.reject(e)}}async get(e,t){let r;let s=this.encodeKey(e);this.validateKey(s);let i={last_by_subj:this.subjectForKey(s)};t&&t.revision>0&&(i={seq:t.revision});try{if(this.direct){let e=this.jsm.direct;r=await e.getMessage(this.bucketName(),i)}else r=await this.jsm.streams.getMessage(this.bucketName(),i);let e=this.smToEntry(r);if(e.key!==s)return null;return e}catch(e){if(e.code===eW.JetStream404NoMessages)return null;throw e}}purge(e,t){return this._deleteOrPurge(e,"PURGE",t)}delete(e,t){return this._deleteOrPurge(e,"DEL",t)}async purgeDeletes(e=18e5){let t=P(),r=[],s=await this.watch({key:">",initializedFn:()=>{t.resolve()}});(async()=>{for await(let e of s)("DEL"===e.operation||"PURGE"===e.operation)&&r.push(e)})().then(),await t,s.stop();let i=Date.now()-e,n=r.map(e=>{let t=this.subjectForKey(e.key);return e.created.getTime()>=i?this.jsm.streams.purge(this.stream,{filter:t,keep:1}):this.jsm.streams.purge(this.stream,{filter:t,keep:0})}),o=await Promise.all(n);return o.unshift({success:!0,purged:0}),o.reduce((e,t)=>(e.purged+=t.purged,e))}async _deleteOrPurge(e,t,r){if(!this.hasWildcards(e))return this._doDeleteOrPurge(e,t,r);let s=await this.keys(e),i=[];for await(let e of s)i.push(this._doDeleteOrPurge(e,t)),100===i.length&&(await Promise.all(i),i.length=0);i.length>0&&await Promise.all(i)}async _doDeleteOrPurge(e,t,r){let s=this.encodeKey(e);this.validateKey(s);let i=I();i.set(rl,t),"PURGE"===t&&i.set(te.RollupHdr,te.RollupValueSubject),r?.previousSeq&&i.set(eq.ExpectedLastSubjectSequenceHdr,`${r.previousSeq}`),await this.js.publish(this.subjectForKey(s,!0),n,{headers:i})}_buildCC(e,t,r={}){let s,i=(Array.isArray(e)?e:[e]).map(e=>{let t=this.encodeKey(e);return this.validateSearchKey(e),this.fullKeyName(t)}),n=e5.LastPerSubject;return t===tt.AllHistory&&(n=e5.All),t===tt.UpdatesOnly&&(n=e5.New),1===i.length&&(s=i[0],i=void 0),Object.assign({deliver_policy:n,ack_policy:e4.None,filter_subjects:i,filter_subject:s,flow_control:!0,idle_heartbeat:O(5e3)},r)}remove(e){return this.purge(e)}async history(e={}){let t;let r=e.key??">",s=new z,i={};i.headers_only=e.headers_only||!1,t=()=>{s.stop()};let n=0,o=this._buildCC(r,tt.AllHistory,i),a=o.filter_subject,h=W(o);h.bindStream(this.stream),h.orderedConsumer(),h.callback((e,r)=>{if(e){s.stop(e);return}if(r){let e=this.jmToEntry(r);s.push(e),s.received++,(t&&n>0&&s.received>=n||0===r.info.pending)&&(s.push(t),t=void 0)}});let c=await this.js.subscribe(a,h);if(t){let{info:{last:e}}=c,r=e.num_pending+e.delivered.consumer_seq;if(0===r||s.received>=r)try{t()}catch(e){s.stop(e)}finally{t=void 0}else n=r}return s._data=c,s.iterClosed.then(()=>{c.unsubscribe()}),c.closed.then(()=>{s.stop()}).catch(e=>{s.stop(e)}),s}canSetWatcherName(){let{ok:e}=this.js.nc.features.get(eN.JS_NEW_CONSUMER_CREATE_API);return e}async watch(e={}){let t=e.key??">",r=new z,s={};s.headers_only=e.headers_only||!1;let i=tt.LastValue;e.include===tt.AllHistory?i=tt.AllHistory:e.include===tt.UpdatesOnly&&(i=tt.UpdatesOnly);let n=!0===e.ignoreDeletes,o=e.initializedFn,a=0,h=this._buildCC(t,i,s),c=h.filter_subject,l=W(h);this.canSetWatcherName()&&l.consumerName(d.next()),l.bindStream(this.stream),e.resumeFromRevision&&e.resumeFromRevision>0&&l.startSequence(e.resumeFromRevision),l.orderedConsumer(),l.callback((e,t)=>{if(e){r.stop(e);return}if(t){let e=this.jmToEntry(t);if(n&&"DEL"===e.operation)return;r.push(e),r.received++,o&&(a>0&&r.received>=a||0===t.info.pending)&&(r.push(o),o=void 0)}});let u=await this.js.subscribe(c,l);if(o){let{info:{last:e}}=u,t=e.num_pending+e.delivered.consumer_seq;if(0===t||r.received>=t)try{o()}catch(e){r.stop(e)}finally{o=void 0}else a=t}return r._data=u,r.iterClosed.then(()=>{u.unsubscribe()}),u.closed.then(()=>{r.stop()}).catch(e=>{r.stop(e)}),r}async keys(e=">"){let t=new z,r=this._buildCC(e,tt.LastValue,{headers_only:!0}),s=Array.isArray(e)?">":r.filter_subject,i=W(r);i.bindStream(this.stream),i.orderedConsumer();let n=await this.js.subscribe(s,i);return(async()=>{for await(let e of n){let r=e.headers?.get(rl);if("DEL"!==r&&"PURGE"!==r){let r=this.decodeKey(e.subject.substring(this.prefixLen));t.push(r)}0===e.info.pending&&n.unsubscribe()}})().then(()=>{t.stop()}).catch(e=>{t.stop(e)}),0===n.info.last.num_pending&&n.unsubscribe(),t}purgeBucket(e){return this.jsm.streams.purge(this.bucketName(),e)}destroy(){return this.jsm.streams.delete(this.bucketName())}async status(){let e=this.js.nc,t=e.info?.cluster??"",r=this.bucketName();return new ry(await this.jsm.streams.info(r),t)}}class ry{si;cluster;constructor(e,t=""){this.si=e,this.cluster=t}get bucket(){return this.si.config.name.startsWith("KV_")?this.si.config.name.substring(3):this.si.config.name}get values(){return this.si.state.messages}get history(){return this.si.config.max_msgs_per_subject}get ttl(){return C(this.si.config.max_age)}get bucket_location(){return this.cluster}get backingStore(){return this.si.config.storage}get storage(){return this.si.config.storage}get replicas(){return this.si.config.num_replicas}get description(){return this.si.config.description??""}get maxBucketSize(){return this.si.config.max_bytes}get maxValueSize(){return this.si.config.max_msg_size}get max_bytes(){return this.si.config.max_bytes}get placement(){return this.si.config.placement||{cluster:"",tags:[]}}get placementCluster(){return this.si.config.placement?.cluster??""}get republish(){return this.si.config.republish??{src:"",dest:""}}get streamInfo(){return this.si}get size(){return this.si.state.bytes}get metadata(){return this.si.config.metadata??{}}get compression(){return!!this.si.config.compression&&this.si.config.compression!==e8.None}}let rw="OBJ_",rS="SHA-256=";class rv{si;backingStore;constructor(e){this.si=e,this.backingStore="JetStream"}get bucket(){var e;return(e=this.si.config.name).startsWith(rw)?e.substring(4):e}get description(){return this.si.config.description??""}get ttl(){return this.si.config.max_age}get storage(){return this.si.config.storage}get replicas(){return this.si.config.num_replicas}get sealed(){return this.si.config.sealed}get size(){return this.si.state.bytes}get streamInfo(){return this.si}get metadata(){return this.si.config.metadata}get compression(){return!!this.si.config.compression&&this.si.config.compression!==e8.None}}function rE(e){if(void 0===e)return;let{domain:t}=e;if(void 0===t)return e;let r=Object.assign({},e);if(delete r.domain,""===t)return r;if(r.external)throw Error("domain and external are both set");return r.external={api:`$JS.${t}.API`},r}(eh=eF||(eF={}))[eh.Unset=-1]="Unset",eh[eh.Consume=0]="Consume",eh[eh.Fetch=1]="Fetch",(ec=eL||(eL={})).HeartbeatsMissed="heartbeats_missed",ec.ConsumerNotFound="consumer_not_found",ec.StreamNotFound="stream_not_found",ec.ConsumerDeleted="consumer_deleted",ec.OrderedConsumerRecreated="ordered_consumer_recreated",ec.NoResponders="no_responders",(el=eB||(eB={})).DebugEvent="debug",el.Discard="discard",el.Reset="reset",el.Next="next";let rx=Uint8Array.of(43,65,67,75),rP=Uint8Array.of(45,78,65,75),rA=Uint8Array.of(43,87,80,73),rk=Uint8Array.of(43,78,88,84),rO=Uint8Array.of(43,84,69,82,77),rC=Uint8Array.of(32);function rj(e,t=5e3){return new r2(e,t)}class rI extends z{consumer;opts;sub;monitor;pending;inbox;refilling;pong;callback;timeout;cleanupHandler;listeners;statusIterator;forOrderedConsumer;resetHandler;abortOnMissingResource;bind;inBackOff;constructor(e,t,r=!1){super(),this.consumer=e,this.opts=this.parseOptions(t,r),this.callback=t.callback||null,this.noIterator="function"==typeof this.callback,this.monitor=null,this.pong=null,this.pending={msgs:0,bytes:0,requests:0},this.refilling=r,this.timeout=null,this.inbox=y(e.api.nc.options.inboxPrefix),this.listeners=[],this.forOrderedConsumer=!1,this.abortOnMissingResource=!0===t.abort_on_missing_resource,this.bind=!0===t.bind,this.inBackOff=!1,this.start()}start(){let{max_messages:e,max_bytes:t,idle_heartbeat:r,threshold_bytes:s,threshold_messages:i}=this.opts;this.closed().then(e=>{if(this.cleanupHandler)try{this.cleanupHandler(e)}catch(e){}});let{sub:n}=this;n&&n.unsubscribe(),this.sub=this.consumer.api.nc.subscribe(this.inbox,{callback:(r,n)=>{if(r){this.stop(r);return}if(this.monitor?.work(),n.subject===this.inbox){if(H(n))return;let e=n.headers?.code,t=n.headers?.description?.toLowerCase()||"unknown",{msgsLeft:r,bytesLeft:s}=this.parseDiscard(n.headers);if(r>0||s>0)this.pending.msgs-=r,this.pending.bytes-=s,this.pending.requests--,this.notify(eB.Discard,{msgsLeft:r,bytesLeft:s});else{if(400===e){this.stop(new m(t,`${e}`));return}if(409===e&&"consumer deleted"===t){if(this.notify(eL.ConsumerDeleted,`${e} ${t}`),!this.refilling||this.abortOnMissingResource){let r=new m(t,`${e}`);this.stop(r);return}}else if(503===e){if(this.notify(eL.NoResponders,`${e} No Responders`),!this.refilling||this.abortOnMissingResource){let t=new m("no responders",`${e}`);this.stop(t);return}}else this.notify(eB.DebugEvent,`${e} ${t}`)}}else this._push(rj(n,this.consumer.api.timeout)),this.received++,this.pending.msgs&&this.pending.msgs--,this.pending.bytes&&(this.pending.bytes-=n.size());if(0===this.pending.msgs&&0===this.pending.bytes&&(this.pending.requests=0),this.refilling){if(e&&this.pending.msgs<=i||t&&this.pending.bytes<=s){let e=this.pullOptions();this.pull(e)}}else 0===this.pending.requests&&this._push(()=>{this.stop()})}}),this.sub.closed.then(()=>{this.sub.draining&&this._push(()=>{this.stop()})}),r&&(this.monitor=new G(r,e=>(this.notify(eL.HeartbeatsMissed,e),this.resetPending().then(()=>{}).catch(()=>{}),!1),{maxOut:2})),(async()=>{let e=this.consumer.api.nc.status();for await(let t of(this.statusIterator=e,e))switch(t.type){case eG.Disconnect:this.monitor?.cancel();break;case eG.Reconnect:this.resetPending().then(e=>{e&&this.monitor?.restart()}).catch(()=>{})}})(),this.pull(this.pullOptions())}_push(e){if(this.callback){let t="function"==typeof e?e:null;try{t?t():this.callback(e)}catch(e){this.stop(e)}}else super.push(e)}notify(e,t){this.listeners.length>0&&(()=>{this.listeners.forEach(r=>{r.done||r.push({type:e,data:t})})})()}resetPending(){return this.bind?this.resetPendingNoInfo():this.resetPendingWithInfo()}resetPendingNoInfo(){return this.pending.msgs=0,this.pending.bytes=0,this.pending.requests=0,this.pull(this.pullOptions()),Promise.resolve(!0)}async resetPendingWithInfo(){if(this.inBackOff)return!1;let e=0,t=0,r=k([this.opts.expires]),s=0;for(;;){if(this.done)return!1;if(this.consumer.api.nc.isClosed())return console.error("aborting resetPending - connection is closed"),!1;try{return await this.consumer.info(),this.inBackOff=!1,e=0,this.pending.msgs=0,this.pending.bytes=0,this.pending.requests=0,this.pull(this.pullOptions()),!0}catch(n){if("stream not found"===n.message){if(t++,this.notify(eL.StreamNotFound,t),!this.refilling||this.abortOnMissingResource)return this.stop(n),!1}else if("consumer not found"===n.message){if(e++,this.notify(eL.ConsumerNotFound,e),this.resetHandler)try{this.resetHandler()}catch(e){}if(!this.refilling||this.abortOnMissingResource)return this.stop(n),!1;if(this.forOrderedConsumer)return!1}else e=0,t=0;this.inBackOff=!0;let i=x(r.backoff(s));await Promise.race([i,this.consumer.api.nc.closed()]),i.cancel(),s++}}}pull(e){this.pending.bytes+=e.max_bytes??0,this.pending.msgs+=e.batch??0,this.pending.requests++;let t=this.consumer.api.nc;this._push(()=>{t.publish(`${this.consumer.api.prefix}.CONSUMER.MSG.NEXT.${this.consumer.stream}.${this.consumer.name}`,this.consumer.api.jc.encode(e),{reply:this.inbox}),this.notify(eB.Next,e)})}pullOptions(){let e=this.opts.max_messages-this.pending.msgs;return{batch:e,max_bytes:this.opts.max_bytes-this.pending.bytes,idle_heartbeat:O(this.opts.idle_heartbeat),expires:O(this.opts.expires)}}parseDiscard(e){let t={msgsLeft:0,bytesLeft:0},r=e?.get(te.PendingMessagesHdr);r&&(t.msgsLeft=parseInt(r));let s=e?.get(te.PendingBytesHdr);return s&&(t.bytesLeft=parseInt(s)),t}trackTimeout(e){this.timeout=e}close(){return this.stop(),this.iterClosed}closed(){return this.iterClosed}clearTimers(){this.monitor?.cancel(),this.monitor=null,this.timeout?.cancel(),this.timeout=null}setCleanupHandler(e){this.cleanupHandler=e}stop(e){this.done||(this.sub?.unsubscribe(),this.clearTimers(),this.statusIterator?.stop(),this._push(()=>{super.stop(e),this.listeners.forEach(e=>{e.stop()})}))}parseOptions(e,t=!1){let r=e||{};if(r.max_messages=r.max_messages||0,r.max_bytes=r.max_bytes||0,0!==r.max_messages&&0!==r.max_bytes)throw Error("only specify one of max_messages or max_bytes");if(0===r.max_messages&&(r.max_messages=100),r.expires=r.expires||3e4,r.expires<1e3)throw Error("expires should be at least 1000ms");if(r.idle_heartbeat=r.idle_heartbeat||r.expires/2,r.idle_heartbeat=r.idle_heartbeat>3e4?3e4:r.idle_heartbeat,t){let e=Math.round(.75*r.max_messages)||1;r.threshold_messages=r.threshold_messages||e;let t=Math.round(.75*r.max_bytes)||1;r.threshold_bytes=r.threshold_bytes||t}return r}status(){let e=new z;return this.listeners.push(e),Promise.resolve(e)}}class rN extends z{src;listeners;constructor(){super(),this.listeners=[]}setSource(e){this.src&&(this.src.resetHandler=void 0,this.src.setCleanupHandler(),this.src.stop()),this.src=e,this.src.setCleanupHandler(e=>{this.stop(e||void 0)}),(async()=>{for await(let e of(await this.src.status()))this.notify(e.type,e.data)})().catch(()=>{})}notify(e,t){this.listeners.length>0&&(()=>{this.listeners.forEach(r=>{r.done||r.push({type:e,data:t})})})()}stop(e){this.done||(this.src?.stop(e),super.stop(e),this.listeners.forEach(e=>{e.stop()}))}close(){return this.stop(),this.iterClosed}closed(){return this.iterClosed}status(){let e=new z;return this.listeners.push(e),Promise.resolve(e)}}class rM{api;_info;stream;name;constructor(e,t){this.api=e,this._info=t,this.stream=t.stream_name,this.name=t.name}consume(e={max_messages:100,expires:3e4}){return Promise.resolve(new rI(this,e,!0))}fetch(e={max_messages:100,expires:3e4}){let t=new rI(this,e,!1),r=E(Math.round(1.05*t.opts.expires));return t.closed().catch(()=>{}).finally(()=>{r.cancel()}),r.catch(()=>{t.close().catch()}),t.trackTimeout(r),Promise.resolve(t)}next(e={expires:3e4}){let t=P();e.max_messages=1;let r=new rI(this,e,!1),s=Math.round(1.05*r.opts.expires);s>=6e4&&(async()=>{for await(let e of(await r.status()))if(e.type===eL.HeartbeatsMissed&&e.data>=2){t.reject(Error("consumer missed heartbeats"));break}})().catch(),(async()=>{for await(let e of r){t.resolve(e);break}})().catch(()=>{});let i=E(s);return r.closed().then(e=>{e?t.reject(e):t.resolve(null)}).catch(e=>{t.reject(e)}).finally(()=>{i.cancel()}),i.catch(e=>{t.resolve(null),r.close().catch()}),r.trackTimeout(i),t}delete(){let{stream_name:e,name:t}=this._info;return this.api.delete(e,t)}info(e=!1){if(e)return Promise.resolve(this._info);let{stream_name:t,name:r}=this._info;return this.api.info(t,r).then(e=>(this._info=e,this._info))}}class rR{api;consumerOpts;consumer;opts;cursor;stream;namePrefix;serial;currentConsumer;userCallback;iter;type;startSeq;maxInitialReset;constructor(e,t,r={}){this.api=e,this.stream=t,this.cursor={stream_seq:1,deliver_seq:0},this.namePrefix=d.next(),"string"==typeof r.name_prefix&&(L("name_prefix",r.name_prefix),this.namePrefix=r.name_prefix+this.namePrefix),this.serial=0,this.currentConsumer=null,this.userCallback=null,this.iter=null,this.type=eF.Unset,this.consumerOpts=r,this.maxInitialReset=30,this.startSeq=this.consumerOpts.opt_start_seq||0,this.cursor.stream_seq=this.startSeq>0?this.startSeq-1:0}getConsumerOpts(e){this.serial++;let t=`${this.namePrefix}_${this.serial}`;e=0===e?1:e;let r={name:t,deliver_policy:e5.StartSequence,opt_start_seq:e,ack_policy:e4.None,inactive_threshold:O(3e5),num_replicas:1};return!0===this.consumerOpts.headers_only&&(r.headers_only=!0),Array.isArray(this.consumerOpts.filterSubjects)&&(r.filter_subjects=this.consumerOpts.filterSubjects),"string"==typeof this.consumerOpts.filterSubjects&&(r.filter_subject=this.consumerOpts.filterSubjects),this.consumerOpts.replay_policy&&(r.replay_policy=this.consumerOpts.replay_policy),e===this.startSeq+1&&(r.deliver_policy=this.consumerOpts.deliver_policy||e5.StartSequence,(this.consumerOpts.deliver_policy===e5.LastPerSubject||this.consumerOpts.deliver_policy===e5.New||this.consumerOpts.deliver_policy===e5.Last)&&(delete r.opt_start_seq,r.deliver_policy=this.consumerOpts.deliver_policy),r.deliver_policy===e5.LastPerSubject&&void 0===r.filter_subjects&&void 0===r.filter_subject&&(r.filter_subject=">"),this.consumerOpts.opt_start_time&&(delete r.opt_start_seq,r.deliver_policy=e5.StartTime,r.opt_start_time=this.consumerOpts.opt_start_time),this.consumerOpts.inactive_threshold&&(r.inactive_threshold=O(this.consumerOpts.inactive_threshold))),r}async resetConsumer(e=0){let t;d.next();let r=0===this.serial;this.consumer?.delete().catch(()=>{}),e=0===e?1:e,this.cursor.deliver_seq=0;let s=this.getConsumerOpts(e);s.max_deliver=1,s.mem_storage=!0;let i=k([this.opts?.expires||3e4]);for(let e=0;;e++)try{t=await this.api.add(this.stream,s),this.iter?.notify(eL.OrderedConsumerRecreated,t.name);break}catch(t){if("stream not found"===t.message&&(this.iter?.notify(eL.StreamNotFound,e),this.type===eF.Fetch||!0===this.opts.abort_on_missing_resource))return this.iter?.stop(t),Promise.reject(t);if(r&&e>=this.maxInitialReset)throw t;await x(i.backoff(e+1))}return t}internalHandler(e){return t=>{if(this.serial!==e)return;let r=t.info.deliverySequence;if(r!==this.cursor.deliver_seq+1){this.notifyOrderedResetAndReset();return}this.cursor.deliver_seq=r,this.cursor.stream_seq=t.info.streamSequence,this.userCallback?this.userCallback(t):this.iter?.push(t)}}async reset(e={max_messages:100,expires:3e4},t){let r=(t=t||{}).fromFetch||!1,s=t.orderedReset||!1;if(this.type===eF.Fetch&&s){this.iter?.src.stop(),await this.iter?.closed(),this.currentConsumer=null;return}(null===this.currentConsumer||s)&&(this.currentConsumer=await this.resetConsumer(this.cursor.stream_seq+1)),(null===this.iter||r)&&(this.iter=new rN),this.consumer=new rM(this.api,this.currentConsumer),e.callback=this.internalHandler(this.serial);let i=null;this.type===eF.Fetch&&r?i=await this.consumer.fetch(e):this.type===eF.Consume&&(i=await this.consumer.consume(e));let n=i;n.forOrderedConsumer=!0,n.resetHandler=()=>{this.notifyOrderedResetAndReset()},this.iter.setSource(n)}notifyOrderedResetAndReset(){this.iter?.notify(eB.Reset,""),this.reset(this.opts,{orderedReset:!0})}async consume(e={max_messages:100,expires:3e4}){if(e.bind)return Promise.reject(Error("bind is not supported"));if(this.type===eF.Fetch)return Promise.reject(Error("ordered consumer initialized as fetch"));if(this.type===eF.Consume)return Promise.reject(Error("ordered consumer doesn't support concurrent consume"));let{callback:t}=e;return t&&(this.userCallback=t),this.type=eF.Consume,this.opts=e,await this.reset(e),this.iter}async fetch(e={max_messages:100,expires:3e4}){if(e.bind)return Promise.reject(Error("bind is not supported"));if(this.type===eF.Consume)return Promise.reject(Error("ordered consumer already initialized as consume"));if(this.iter?.done===!1)return Promise.reject(Error("ordered consumer doesn't support concurrent fetch"));let{callback:t}=e;return t&&(this.userCallback=t),this.type=eF.Fetch,this.opts=e,await this.reset(e,{fromFetch:!0}),this.iter}async next(e={expires:3e4}){if(e.bind)return Promise.reject(Error("bind is not supported"));e.max_messages=1;let t=P();return e.callback=e=>{this.userCallback=null,t.resolve(e)},(await this.fetch(e)).iterClosed.then(e=>{e&&t.reject(e),t.resolve(null)}).catch(e=>{t.reject(e)}),t}delete(){return this.currentConsumer?this.api.delete(this.stream,this.currentConsumer.name).then(e=>Promise.resolve(e)).catch(e=>Promise.reject(e)).finally(()=>{this.currentConsumer=null}):Promise.resolve(!1)}async info(e){return null==this.currentConsumer?(this.currentConsumer=await this.resetConsumer(this.startSeq),Promise.resolve(this.currentConsumer)):e&&this.currentConsumer?Promise.resolve(this.currentConsumer):this.api.info(this.stream,this.currentConsumer.name)}}class rT{api;notified;constructor(e){this.api=e,this.notified=!1}checkVersion(){let e=this.api.nc.features.get(eN.JS_SIMPLIFICATION);return e.ok?Promise.resolve():Promise.reject(Error(`consumers framework is only supported on servers ${e.min} or better`))}getPullConsumerFor(e){if(void 0!==e.config.deliver_subject)throw Error("push consumer not supported");return new rM(this.api,e)}async get(e,t={}){return"object"==typeof t?this.ordered(e,t):(await this.checkVersion(),this.api.info(e,t).then(e=>void 0!==e.config.deliver_subject?Promise.reject(Error("push consumer not supported")):new rM(this.api,e)).catch(e=>Promise.reject(e)))}async ordered(e,t){await this.checkVersion();let r=this.api;return new rU(r.nc,r.opts).info(e).then(r=>Promise.resolve(new rR(this.api,e,t))).catch(e=>Promise.reject(e))}}class r${api;_info;constructor(e,t){this.api=e,this._info=t}get name(){return this._info.config.name}alternates(){return this.info().then(e=>e.alternates?e.alternates:[])}async best(){if(await this.info(),!this._info.alternates)return this;{let e=await this.api.info(this._info.alternates[0].name);return new r$(this.api,e)}}info(e=!1,t){return e?Promise.resolve(this._info):this.api.info(this.name,t).then(e=>(this._info=e,this._info))}getConsumerFromInfo(e){return new rT(new tP(this.api.nc,this.api.opts)).getPullConsumerFor(e)}getConsumer(e){return new rT(new tP(this.api.nc,this.api.opts)).get(this.name,e)}getMessage(e){return this.api.getMessage(this.name,e)}deleteMessage(e,t){return this.api.deleteMessage(this.name,e,t)}}class rU extends tw{constructor(e,t){super(e,t)}checkStreamConfigVersions(e){let t=this.nc;if(e.metadata){let{min:e,ok:r}=t.features.get(eN.JS_STREAM_CONSUMER_METADATA);if(!r)throw Error(`stream 'metadata' requires server ${e}`)}if(e.first_seq){let{min:e,ok:r}=t.features.get(eN.JS_STREAM_FIRST_SEQ);if(!r)throw Error(`stream 'first_seq' requires server ${e}`)}if(e.subject_transform){let{min:e,ok:r}=t.features.get(eN.JS_STREAM_SUBJECT_TRANSFORM);if(!r)throw Error(`stream 'subject_transform' requires server ${e}`)}if(e.compression){let{min:e,ok:r}=t.features.get(eN.JS_STREAM_COMPRESSION);if(!r)throw Error(`stream 'compression' requires server ${e}`)}if(e.consumer_limits){let{min:e,ok:r}=t.features.get(eN.JS_DEFAULT_CONSUMER_LIMITS);if(!r)throw Error(`stream 'consumer_limits' requires server ${e}`)}function r(e,r){if((r?.subject_transforms?.length||0)>0){let{min:r,ok:s}=t.features.get(eN.JS_STREAM_SOURCE_SUBJECT_TRANSFORM);if(!s)throw Error(`${e} 'subject_transforms' requires server ${r}`)}}e.sources&&e.sources.forEach(e=>{r("stream sources",e)}),e.mirror&&r("stream mirror",e.mirror)}async add(e={}){this.checkStreamConfigVersions(e),F(e.name),e.mirror=rE(e.mirror),e.sources=e.sources?.map(rE);let t=await this._request(`${this.prefix}.STREAM.CREATE.${e.name}`,e);return this._fixInfo(t),t}async delete(e){return F(e),(await this._request(`${this.prefix}.STREAM.DELETE.${e}`)).success}async update(e,t={}){if("object"==typeof e){let r=e;e=r.name,t=r,console.trace(`\u001B[33m >> streams.update(config: StreamConfig) api changed to streams.update(name: string, config: StreamUpdateConfig) - this shim will be removed - update your code.  \u001B[0m`)}this.checkStreamConfigVersions(t),F(e);let r=Object.assign((await this.info(e)).config,t);r.mirror=rE(r.mirror),r.sources=r.sources?.map(rE);let s=await this._request(`${this.prefix}.STREAM.UPDATE.${e}`,r);return this._fixInfo(s),s}async info(e,t){F(e);let r=`${this.prefix}.STREAM.INFO.${e}`,s=await this._request(r,t),{total:i,limit:n}=s,o=s.state.subjects?Object.getOwnPropertyNames(s.state.subjects).length:1;if(i&&i>o){let e=[s],a=t||{},h=0;for(;i>o;){h++,a.offset=n*h;let t=await this._request(r,a);i=t.total,e.push(t);let s=Object.getOwnPropertyNames(t.state.subjects).length;if(o+=s,s<n)break}let c={};for(let t=0;t<e.length;t++)(s=e[t]).state.subjects&&(c=Object.assign(c,s.state.subjects));s.offset=0,s.total=0,s.limit=0,s.state.subjects=c}return this._fixInfo(s),s}list(e=""){let t=e?.length?{subject:e}:{};return new tS(`${this.prefix}.STREAM.LIST`,e=>(e.streams.forEach(e=>{this._fixInfo(e)}),e.streams),this,t)}_fixInfo(e){e.config.sealed=e.config.sealed||!1,e.config.deny_delete=e.config.deny_delete||!1,e.config.deny_purge=e.config.deny_purge||!1,e.config.allow_rollup_hdrs=e.config.allow_rollup_hdrs||!1}async purge(e,t){if(t){let{keep:e,seq:r}=t;if("number"==typeof e&&"number"==typeof r)throw Error("can specify one of keep or seq")}return F(e),await this._request(`${this.prefix}.STREAM.PURGE.${e}`,t)}async deleteMessage(e,t,r=!0){F(e);let s={seq:t};return r||(s.no_erase=!0),(await this._request(`${this.prefix}.STREAM.MSG.DELETE.${e}`,s)).success}async getMessage(e,t){return F(e),new rB(await this._request(`${this.prefix}.STREAM.MSG.GET.${e}`,t))}find(e){return this.findStream(e)}listKvs(){return new tS(`${this.prefix}.STREAM.LIST`,e=>{let t=e.streams.filter(e=>e.config.name.startsWith("KV_"));t.forEach(e=>{this._fixInfo(e)});let r="";return t.length&&(r=this.nc.info?.cluster??""),t.map(e=>new ry(e,r))},this)}listObjectStores(){return new tS(`${this.prefix}.STREAM.LIST`,e=>{let t=e.streams.filter(e=>e.config.name.startsWith(rw));return t.forEach(e=>{this._fixInfo(e)}),t.map(e=>new rv(e))},this)}names(e=""){let t=e?.length?{subject:e}:{};return new tS(`${this.prefix}.STREAM.NAMES`,e=>e.streams,this,t)}async get(e){return Promise.resolve(new r$(this,await this.info(e)))}}class rq extends tw{constructor(e,t){super(e,t)}async getMessage(e,t){F(e);let r=t,{last_by_subj:s}=r;s&&(r=null);let i=r?this.jc.encode(r):n,o=this.opts.apiPrefix||"$JS.API",a=s?`${o}.DIRECT.GET.${e}.${s}`:`${o}.DIRECT.GET.${e}`,h=await this.nc.request(a,i,{timeout:this.timeout}),c=J(h);return c?Promise.reject(c):Promise.resolve(new rF(h))}async getBatch(e,t){F(e);let r=this.opts.apiPrefix||"$JS.API",s=`${r}.DIRECT.GET.${e}`;if(!Array.isArray(t.multi_last)||0===t.multi_last.length)return Promise.reject("multi_last is required");let i=JSON.stringify(t,(e,t)=>"up_to_time"===e&&t instanceof Date?t.toISOString():t),n=new z,o=await this.nc.requestMany(s,i,{strategy:eX.SentinelMsg});return(async()=>{let e,t=!1,r=!1;for await(let s of o){if(!t){t=!0;let i=s.headers?.code||0;if(0!==i&&i<200||i>299){e=s.headers?.description.toLowerCase();break}if(""===s.headers?.get("Nats-Num-Pending")){r=!0;break}}if(0===s.data.length)break;n.push(new rF(s))}n.push(()=>{if(r)throw Error("batch direct get not supported by the server");if(e)throw Error(`bad request: ${e}`);n.stop()})})(),Promise.resolve(n)}}class rF{data;header;static jc;constructor(e){if(!e.headers)throw Error("headers expected");this.data=e.data,this.header=e.headers}get subject(){return this.header.last(tr.Subject)}get seq(){let e=this.header.last(tr.Sequence);return"string"==typeof e?parseInt(e):0}get time(){return new Date(Date.parse(this.timestamp))}get timestamp(){return this.header.last(tr.TimeStamp)}get stream(){return this.header.last(tr.Stream)}json(e){return T(e).decode(this.data)}string(){return a.decode(this.data)}}class rL extends tw{streams;consumers;direct;constructor(e,t){super(e,t),this.streams=new rU(e,t),this.consumers=new tP(e,t),this.direct=new rq(e,t)}async getAccountInfo(){return await this._request(`${this.prefix}.INFO`)}jetstream(){return this.nc.jetstream(this.getOptions())}advisories(){let e=new z;return this.nc.subscribe("$JS.EVENT.ADVISORY.>",{callback:(t,r)=>{if(t)throw t;try{let t=this.parseJsResponse(r),s=t.type.split("."),i=s[s.length-1];e.push({kind:i,data:t})}catch(t){e.stop(t)}}}),e}}class rB{_header;smr;static jc;constructor(e){this.smr=e}get subject(){return this.smr.message.subject}get seq(){return this.smr.message.seq}get timestamp(){return this.smr.message.time}get time(){return new Date(Date.parse(this.timestamp))}get data(){return this.smr.message.data?this._parse(this.smr.message.data):n}get header(){if(!this._header){if(this.smr.message.hdrs){let e=this._parse(this.smr.message.hdrs);this._header=M.decode(e)}else this._header=I()}return this._header}_parse(e){let t=atob(e),r=t.length,s=new Uint8Array(r);for(let e=0;e<r;e++)s[e]=t.charCodeAt(e);return s}json(e){return T(e).decode(this.data)}string(){return a.decode(this.data)}}class rD{api;constructor(e){this.api=e}get(e){return this.api.info(e).then(e=>new r$(this.api,e))}}class rH{info;hdrs;constructor(e){this.info=e}get name(){return this.info.name}get description(){return this.info.description??""}get headers(){return this.hdrs||(this.hdrs=M.fromRecord(this.info.headers||{})),this.hdrs}get options(){return this.info.options}get bucket(){return this.info.bucket}get chunks(){return this.info.chunks}get deleted(){return this.info.deleted??!1}get digest(){return this.info.digest}get mtime(){return this.info.mtime}get nuid(){return this.info.nuid}get size(){return this.info.size}get revision(){return this.info.revision}get metadata(){return this.info.metadata||{}}isLink(){return this.info.options?.link!==void 0&&this.info.options?.link!==null}}function rJ(e){let t={name:e.name,description:e.description??"",options:e.options,metadata:e.metadata};if(e.headers){let r=e.headers;t.headers=r.toRecord()}return t}class rK{jsm;js;stream;name;constructor(e,t,r){this.name=e,this.jsm=t,this.js=r}_checkNotEmpty(e){return e&&0!==e.length?{name:e}:{name:e,error:Error("name cannot be empty")}}async info(e){let t=await this.rawInfo(e);return t?new rH(t):null}async list(){let e=[];for await(let t of(await this.watch({ignoreDeletes:!0,includeHistory:!0}))){if(null===t)break;e.push(t)}return Promise.resolve(e)}async rawInfo(e){let{name:t,error:r}=this._checkNotEmpty(e);if(r)return Promise.reject(r);let s=this._metaSubject(t);try{let e=await this.jsm.streams.getMessage(this.stream,{last_by_subj:s}),t=T().decode(e.data);return t.revision=e.seq,t}catch(e){if("404"===e.code)return null;return Promise.reject(e)}}async _si(e){try{return await this.jsm.streams.info(this.stream,e)}catch(e){if("404"===e.code)return null;return Promise.reject(e)}}async seal(){let e=await this._si();return null===e?Promise.reject(Error("object store not found")):(e.config.sealed=!0,Promise.resolve(new rv(e=await this.jsm.streams.update(this.stream,e.config))))}async status(e){let t=await this._si(e);return null===t?Promise.reject(Error("object store not found")):Promise.resolve(new rv(t))}destroy(){return this.jsm.streams.delete(this.stream)}async _put(e,t,r){let s=this.js.getOptions();(r=r||{timeout:s.timeout}).timeout=r.timeout||s.timeout,r.previousRevision=r.previousRevision??void 0;let{timeout:i,previousRevision:n}=r,o=this.js.nc.info,a=o?.max_payload||1024;(e=e||{}).options=e.options||{};let h=e.options?.max_chunk_size||131072;h=h>a?a:h,e.options.max_chunk_size=h;let c=await this.info(e.name),{name:l,error:u}=this._checkNotEmpty(e.name);if(u)return Promise.reject(u);let f=d.next(),p=this._chunkSubject(f),m=this._metaSubject(l),g=Object.assign({bucket:this.name,nuid:f,size:0,chunks:0},rJ(e)),b=P(),_=[],y=new Q;try{let r=t?t.getReader():null,s=tm.create();for(;;){let{done:t,value:o}=r?await r.read():{done:!0,value:void 0};if(t){if(y.size()>0){let e=y.drain();s.update(e),g.chunks++,g.size+=e.length,_.push(this.js.publish(p,e,{timeout:i}))}await Promise.all(_),_.length=0,g.mtime=new Date().toISOString();let e=Z.encode(s.digest());g.digest=`${rS}${e}`,g.deleted=!1;let t=I();"number"==typeof n&&t.set(eq.ExpectedLastSubjectSequenceHdr,`${n}`),t.set(te.RollupHdr,te.RollupValueSubject);let r=await this.js.publish(m,T().encode(g),{headers:t,timeout:i});if(g.revision=r.seq,c)try{await this.jsm.streams.purge(this.stream,{filter:`$O.${this.name}.C.${c.nuid}`})}catch(e){}b.resolve(new rH(g));break}if(o)for(y.fill(o);y.size()>h;){g.chunks++,g.size+=h;let t=y.drain(e.options.max_chunk_size);s.update(t),_.push(this.js.publish(p,t,{timeout:i}))}}}catch(e){await this.jsm.streams.purge(this.stream,{filter:p}),b.reject(e)}return b}putBlob(e,t,r){var s;return null===t&&(t=new Uint8Array(0)),this.put(e,(s=t,new ReadableStream({pull(e){e.enqueue(s),e.close()}})),r)}put(e,t,r){return e?.options?.link?Promise.reject(Error("link cannot be set when putting the object in bucket")):this._put(e,t,r)}async getBlob(e){async function t(e){let t=new Q,r=e.getReader();for(;;){let{done:e,value:s}=await r.read();if(e)return t.drain();s&&s.length&&t.fill(s)}}let r=await this.get(e);if(null===r)return Promise.resolve(null);let s=await Promise.all([r.error,t(r.data)]);return s[0]?Promise.reject(s[0]):Promise.resolve(s[1])}async get(e){let t;let r=await this.rawInfo(e);if(null===r||r.deleted)return Promise.resolve(null);if(r.options&&r.options.link){let e=r.options.link.name||"";if(""===e)throw Error("link is a bucket");return(r.options.link.bucket!==this.name?await rK.create(this.js,r.options.link.bucket):this).get(e)}if(!r.digest.startsWith(rS))return Promise.reject(Error(`unknown digest type: ${r.digest}`));let s=tg(r.digest.substring(8));if(null===s)return Promise.reject(Error(`unable to parse digest: ${r.digest}`));let i=P(),n={info:new rH(r),error:i};if(0===r.size)return n.data=new ReadableStream({pull(e){e.enqueue(new Uint8Array(0)),e.close()}}),i.resolve(null),Promise.resolve(n);let o=W();o.orderedConsumer();let a=tm.create(),h=`$O.${this.name}.C.${r.nuid}`,c=await this.js.subscribe(h,o);return(async()=>{for await(let e of c)e.data.length>0&&(a.update(e.data),t.enqueue(e.data)),0===e.info.pending&&(function(e,t){let r="string"==typeof e?tg(e):e,s="string"==typeof t?tg(t):t;if(null===r||null===s||r.length!==s.length)return!1;for(let e=0;e<r.length;e++)if(r[e]!==s[e])return!1;return!0}(s,a.digest())?t.close():t.error(Error(`received a corrupt object, digests do not match received: ${r.digest} calculated ${s}`)),c.unsubscribe())})().then(()=>{i.resolve()}).catch(e=>{t.error(e),i.reject(e)}),n.data=new ReadableStream({start(e){t=e},cancel(){c.unsubscribe()}}),n}linkStore(e,t){if(!(t instanceof rK))return Promise.reject("bucket required");let{name:r,error:s}=this._checkNotEmpty(e);if(s)return Promise.reject(s);let i={name:r,options:{link:{bucket:t.name}}};return this._put(i,null)}async link(e,t){let{name:r,error:s}=this._checkNotEmpty(e);if(s)return Promise.reject(s);if(t.deleted)return Promise.reject(Error("src object is deleted"));if(t.isLink())return Promise.reject(Error("src object is a link"));let i=await this.rawInfo(e);if(null!==i&&!i.deleted)return Promise.reject(Error("an object already exists with that name"));let n={bucket:t.bucket,name:t.name},o={name:r,bucket:t.bucket,options:{link:n}};return await this.js.publish(this._metaSubject(e),JSON.stringify(o)),Promise.resolve(await this.info(e))}async delete(e){let t=await this.rawInfo(e);if(null===t)return Promise.resolve({purged:0,success:!1});t.deleted=!0,t.size=0,t.chunks=0,t.digest="";let r=T(),s=I();return s.set(te.RollupHdr,te.RollupValueSubject),await this.js.publish(this._metaSubject(t.name),r.encode(t),{headers:s}),this.jsm.streams.purge(this.stream,{filter:this._chunkSubject(t.nuid)})}async update(e,t={}){let r=await this.rawInfo(e);if(null===r)return Promise.reject(Error("object not found"));if(r.deleted)return Promise.reject(Error("cannot update meta for a deleted object"));t.name=t.name??r.name;let{name:s,error:i}=this._checkNotEmpty(t.name);if(i)return Promise.reject(i);if(e!==t.name){let e=await this.info(t.name);if(e&&!e.deleted)return Promise.reject(Error("an object already exists with that name"))}t.name=s;let n=Object.assign({},r,rJ(t)),o=await this.js.publish(this._metaSubject(n.name),JSON.stringify(n));return e!==t.name&&await this.jsm.streams.purge(this.stream,{filter:this._metaSubject(e)}),Promise.resolve(o)}async watch(e={}){e.includeHistory=e.includeHistory??!1,e.ignoreDeletes=e.ignoreDeletes??!1;let t=!1,r=new z,s=this._metaSubjectAll();try{await this.jsm.streams.getMessage(this.stream,{last_by_subj:s})}catch(e){"404"===e.code?(r.push(null),t=!0):r.stop(e)}let i=T(),n=W();n.orderedConsumer(),e.includeHistory?n.deliverLastPerSubject():(t=!0,n.deliverNew()),n.callback((s,n)=>{if(s){r.stop(s);return}if(null!==n){let s=i.decode(n.data);s.deleted&&!0===e.ignoreDeletes||r.push(s),n.info?.pending!==0||t||(t=!0,r.push(null))}});let o=await this.js.subscribe(s,n);return r._data=o,r.iterClosed.then(()=>{o.unsubscribe()}),o.closed.then(()=>{r.stop()}).catch(e=>{r.stop(e)}),r}_chunkSubject(e){return`$O.${this.name}.C.${e}`}_metaSubject(e){return`$O.${this.name}.M.${Z.encode(e)}`}_metaSubjectAll(){return`$O.${this.name}.M.>`}async init(e={}){try{var t;this.stream=(t=this.name,rb(t),`${rw}${t}`)}catch(e){return Promise.reject(e)}let r=e?.ttl||0;delete e.ttl;let s=Object.assign({max_age:r},e);s.name=this.stream,s.num_replicas=e.replicas??1,s.allow_direct=!0,s.allow_rollup_hdrs=!0,s.discard=e2.New,s.subjects=[`$O.${this.name}.C.>`,`$O.${this.name}.M.>`],e.placement&&(s.placement=e.placement),e.metadata&&(s.metadata=e.metadata),"boolean"==typeof e.compression&&(s.compression=e.compression?e8.S2:e8.None);try{await this.jsm.streams.info(s.name)}catch(e){"stream not found"===e.message&&await this.jsm.streams.add(s)}}static async create(e,t,r={}){let s=new rK(t,await e.jetstreamManager(),e);return await s.init(r),Promise.resolve(s)}}class rz{js;constructor(e){this.js=e}kv(e,t={}){let{ok:r,min:s}=this.js.nc.features.get(eN.JS_KV);return r?t.bindOnly?r_.bind(this.js,e,t):r_.create(this.js,e,t):Promise.reject(Error(`kv is only supported on servers ${s} or better`))}os(e,t={}){if("function"!=typeof crypto?.subtle?.digest)return Promise.reject(Error("objectstore: unable to calculate hashes - crypto.subtle.digest with sha256 support is required"));let{ok:r,min:s}=this.js.nc.features.get(eN.JS_OBJECTSTORE);return r?rK.create(this.js,e,t):Promise.reject(Error(`objectstore is only supported on servers ${s} or better`))}}class rG extends tw{consumers;streams;consumerAPI;streamAPI;constructor(e,t){super(e,t),this.consumerAPI=new tP(e,t),this.streamAPI=new rU(e,t),this.consumers=new rT(this.consumerAPI),this.streams=new rD(this.streamAPI)}jetstreamManager(e){void 0===e&&(e=this.opts.checkAPI);let t=Object.assign({},this.opts,{checkAPI:e});return this.nc.jetstreamManager(t)}get apiPrefix(){return this.prefix}get views(){return new rz(this)}async publish(e,t=n,r){let s;(r=r||{}).expect=r.expect||{};let i=r?.headers||I();r&&(r.msgID&&i.set(eq.MsgIdHdr,r.msgID),r.expect.lastMsgID&&i.set(eq.ExpectedLastMsgIdHdr,r.expect.lastMsgID),r.expect.streamName&&i.set(eq.ExpectedStreamHdr,r.expect.streamName),"number"==typeof r.expect.lastSequence&&i.set(eq.ExpectedLastSeqHdr,`${r.expect.lastSequence}`),"number"==typeof r.expect.lastSubjectSequence&&i.set(eq.ExpectedLastSubjectSequenceHdr,`${r.expect.lastSubjectSequence}`));let o=r.timeout||this.timeout,a={};o&&(a.timeout=o),r&&(a.headers=i);let{retries:h,retry_delay:c}=r;h=h||1,c=c||250;for(let r=0;r<h;r++)try{s=await this.nc.request(e,t,a);break}catch(e){if("503"===e.code&&r+1<h)await x(c);else throw e}let l=this.parseJsResponse(s);if(""===l.stream)throw m.errorForCode(eW.JetStreamInvalidAck);return l.duplicate=!!l.duplicate&&l.duplicate,l}async pull(e,t,r=0){F(e),q(t);let s=this.timeout;r>s&&(s=r);let i={batch:1,no_wait:0===(r=r<0?0:O(r)),expires:r},n=await this.nc.request(`${this.prefix}.CONSUMER.MSG.NEXT.${e}.${t}`,this.jc.encode(i),{noMux:!0,timeout:s}),o=J(n);if(o)throw o;return rj(n,this.timeout)}fetch(e,t,r={}){F(e),q(t);let s=null,i=(r.max_bytes??0)>0,n=0,o=i?r.max_bytes:0,a=null,h={};if(h.batch=r.batch||1,o){let e=this.nc.features.get(eN.JS_PULL_MAX_BYTES);if(!e.ok)throw Error(`max_bytes is only supported on servers ${e.min} or better`);h.max_bytes=o}h.no_wait=r.no_wait||!1,h.no_wait&&h.expires&&(h.expires=0);let c=r.expires||0;if(c&&(h.expires=O(c)),0===c&&!1===h.no_wait)throw Error("expires or no_wait is required");let l=r.idle_heartbeat||0;l&&(h.idle_heartbeat=O(l),!0===r.delay_heartbeat&&(h.idle_heartbeat=O(4*l)));let u=new z,d=h.batch,f=0;u.protocolFilterFn=(e,t=!1)=>!H(e.msg)||(a?.work(),!1),u.dispatchedFn=e=>{e&&(i&&(n+=e.data.length),f++,(!s||0!==e.info.pending)&&(1===u.getPending()&&0===e.info.pending||d===f||o>0&&n>=o)&&u.stop())};let p=y(this.nc.options.inboxPrefix),g=this.nc.subscribe(p,{max:r.batch,callback:(e,t)=>{(null===e&&(e=J(t)),null!==e)?(s&&(s.cancel(),s=null),"string"==typeof e.code)?u.stop(null===r0(e)?void 0:e):u.stop(e):(a?.work(),u.received++,u.push(rj(t,this.timeout)))}});return c&&(s=E(c)).catch(()=>{g.isClosed()||(g.drain().catch(()=>{}),s=null),a&&a.cancel()}),(async()=>{try{l&&(a=new G(l,e=>(u.push(()=>{u.err=new m(`${e0.IdleHeartbeatMissed}: ${e}`,eW.JetStreamIdleHeartBeat)}),!0)))}catch(e){}await g.closed,null!==s&&(s.cancel(),s=null),a&&a.cancel(),u.stop()})().catch(),this.nc.publish(`${this.prefix}.CONSUMER.MSG.NEXT.${e}.${t}`,this.jc.encode(h),{reply:p}),u}async pullSubscribe(e,t=W()){let r=await this._processOptions(e,t);if(r.ordered)throw Error("pull subscribers cannot be be ordered");if(r.config.deliver_subject)throw Error("consumer info specifies deliver_subject - pull consumers cannot have deliver_subject set");let s=r.config.ack_policy;if(s===e4.None||s===e4.All)throw Error("ack policy for pull consumers must be explicit");let i=this._buildTypedSubscriptionOpts(r),n=new rQ(this,r.deliver,i);n.info=r;try{await this._maybeCreateConsumer(r)}catch(e){throw n.unsubscribe(),e}return n}async subscribe(e,t=W()){let r=await this._processOptions(e,t);if(!r.isBind&&!r.config.deliver_subject)throw Error("push consumer requires deliver_subject");let s=this._buildTypedSubscriptionOpts(r),i=new rZ(this,r.deliver,s);i.info=r;try{await this._maybeCreateConsumer(r)}catch(e){throw i.unsubscribe(),e}return i._maybeSetupHbMonitoring(),i}async _processOptions(e,t=W()){let r=Y(t)?t.getOpts():t;if(r.isBind=!!Y(t)&&t.isBind,r.flow_control={heartbeat_count:0,fc_count:0,consumer_restarts:0},r.ordered){if(r.ordered_consumer_sequence={stream_seq:0,delivery_seq:0},r.config.ack_policy!==e4.NotSet&&r.config.ack_policy!==e4.None)throw new m("ordered consumer: ack_policy can only be set to 'none'",eW.ApiError);if(r.config.durable_name&&r.config.durable_name.length>0)throw new m("ordered consumer: durable_name cannot be set",eW.ApiError);if(r.config.deliver_subject&&r.config.deliver_subject.length>0)throw new m("ordered consumer: deliver_subject cannot be set",eW.ApiError);if(void 0!==r.config.max_deliver&&r.config.max_deliver>1)throw new m("ordered consumer: max_deliver cannot be set",eW.ApiError);if(r.config.deliver_group&&r.config.deliver_group.length>0)throw new m("ordered consumer: deliver_group cannot be set",eW.ApiError);r.config.deliver_subject=y(this.nc.options.inboxPrefix),r.config.ack_policy=e4.None,r.config.max_deliver=1,r.config.flow_control=!0,r.config.idle_heartbeat=r.config.idle_heartbeat||O(5e3),r.config.ack_wait=O(792e5),r.config.mem_storage=!0,r.config.num_replicas=1}if(r.config.ack_policy===e4.NotSet&&(r.config.ack_policy=e4.All),r.api=this,r.config=r.config||{},r.stream=r.stream?r.stream:await this.findStream(e),r.attached=!1,r.config.durable_name)try{let t=await this.consumerAPI.info(r.stream,r.config.durable_name);if(t){if(t.config.filter_subject&&t.config.filter_subject!==e)throw Error("subject does not match consumer");let s=r.config.deliver_group??"";if(""===s&&!0===t.push_bound)throw Error("duplicate subscription");let i=t.config.deliver_group??"";if(s!==i){if(""===i)throw Error("durable requires no queue group");throw Error(`durable requires queue group '${i}'`)}r.last=t,r.config=t.config,r.attached=!0,r.config.durable_name||(r.name=t.name)}}catch(e){if("404"!==e.code)throw e}return r.attached||void 0!==r.config.filter_subject||void 0!==r.config.filter_subjects||(r.config.filter_subject=e),r.deliver=r.config.deliver_subject||y(this.nc.options.inboxPrefix),r}_buildTypedSubscriptionOpts(e){var t,r;let s={};return s.adapter=(t=void 0===e.callbackFn,r=this.timeout,t?(e,t)=>{if(e)return[e,null];let s=J(t);return null!==s?[r0(s),null]:[null,rj(t,r)]}:(e,t)=>e||(e=J(t))?[e,null]:[null,rj(t,r)]),s.ingestionFilterFn=rG.ingestionFn(e.ordered),s.protocolFilterFn=(e,t=!1)=>!D(e.msg)||(t||e.msg.respond(),!1),e.mack||e.config.ack_policy===e4.None||(s.dispatchedFn=r1),e.callbackFn&&(s.callback=e.callbackFn),s.max=e.max||0,s.queue=e.queue,s}async _maybeCreateConsumer(e){if(e.attached)return;if(e.isBind)throw Error(`unable to bind - durable consumer ${e.config.durable_name} doesn't exist in ${e.stream}`);e.config=Object.assign({deliver_policy:e5.All,ack_policy:e4.Explicit,ack_wait:O(3e4),replay_policy:e6.Instant},e.config);let t=await this.consumerAPI.add(e.stream,e.config);if(Array.isArray(e.config.filter_subjects&&!Array.isArray(t.config.filter_subjects)))throw Error("jetstream server doesn't support consumers with multiple filter subjects");e.name=t.name,e.config=t.config,e.last=t}static ingestionFn(e){return(t,r)=>{if(!t)return{ingest:!1,protocol:!1};if(J(t.msg)||r.monitor?.work(),H(t.msg)){let s=!e||r._checkHbOrderConsumer(t.msg);return!e&&r.info.flow_control.heartbeat_count++,{ingest:s,protocol:!0}}return D(t.msg)?(r.info.flow_control.fc_count++,{ingest:!0,protocol:!0}):{ingest:!e||r._checkOrderedConsumer(t),protocol:!1}}}}class rV{options;protocol;draining;listeners;_services;constructor(e){this.draining=!1,this.options=function(e){let t=`${w}:${tO()}`;if((e=e||{servers:[t]}).servers=e.servers||[],"string"==typeof e.servers&&(e.servers=[e.servers]),e.servers.length>0&&e.port)throw new m("port and servers options are mutually exclusive",eW.InvalidOption);0===e.servers.length&&e.port&&(e.servers=[`${w}:${e.port}`]),e.servers&&0===e.servers.length&&(e.servers=[t]);let r=S({maxPingOut:2,maxReconnectAttempts:10,noRandomize:!1,pedantic:!1,pingInterval:12e4,reconnect:!0,reconnectJitter:100,reconnectJitterTLS:1e3,reconnectTimeWait:2e3,tls:void 0,verbose:!1,waitOnFirstConnect:!1,ignoreAuthErrorAbort:!1},e);if(r.authenticator=function(e){var t,r,s;let i=[];return"function"==typeof e.authenticator&&i.push(e.authenticator),Array.isArray(e.authenticator)&&i.push(...e.authenticator),e.token&&i.push((t=e.token,()=>({auth_token:"function"==typeof t?t():t}))),e.user&&i.push((r=e.user,s=e.pass,()=>({user:"function"==typeof r?r():r,pass:"function"==typeof s?s():s}))),0===i.length?()=>{}:e=>{let t={};return i.forEach(r=>{let s=r(e)||{};t=Object.assign(t,s)}),t}}(r),["reconnectDelayHandler","authenticator"].forEach(e=>{if(r[e]&&"function"!=typeof r[e])throw new m(`${e} option should be a function`,eW.NotFunction)}),r.reconnectDelayHandler||(r.reconnectDelayHandler=()=>{let e=r.tls?r.reconnectJitterTLS:r.reconnectJitter;return e&&(e=Math.floor(Math.random()*++e)),r.reconnectTimeWait+e}),r.inboxPrefix)try{y(r.inboxPrefix)}catch(e){throw new m(e.message,eW.ApiError)}if(void 0===r.resolve&&(r.resolve="function"==typeof tj()),r.resolve&&"function"!=typeof tj())throw new m("'resolve' is not supported on this client",eW.InvalidOption);return r}(e),this.listeners=[]}static connect(e={}){return new Promise((t,r)=>{let s=new rV(e);rs.connect(s.options,s).then(e=>{s.protocol=e,async function(){for await(let t of e.status())s.listeners.forEach(e=>{e.push(t)})}(),t(s)}).catch(e=>{r(e)})})}closed(){return this.protocol.closed}async close(){await this.protocol.close()}_check(e,t,r){if(this.isClosed())throw m.errorForCode(eW.ConnectionClosed);if(t&&this.isDraining()||r&&this.protocol.noMorePublishing)throw m.errorForCode(eW.ConnectionDraining);if(0===(e=e||"").length)throw m.errorForCode(eW.BadSubject)}publish(e,t,r){this._check(e,!1,!0),this.protocol.publish(e,t,r)}publishMessage(e){return this.publish(e.subject,e.data,{reply:e.reply,headers:e.headers})}respondMessage(e){return!!e.reply&&(this.publish(e.reply,e.data,{reply:e.reply,headers:e.headers}),!0)}subscribe(e,t={}){this._check(e,!0,!1);let r=new rt(this.protocol,e,t);return this.protocol.subscribe(r),r}_resub(e,t,r){this._check(t,!0,!1),e.max=r,r&&(e.max=r+e.received),this.protocol.resub(e,t)}requestMany(e,t=n,r={maxWait:1e3,maxMessages:-1}){let s=!this.protocol.options.noAsyncTraces;try{this._check(e,!0,!0)}catch(e){return Promise.reject(e)}if(r.strategy=r.strategy||eX.Timer,r.maxWait=r.maxWait||1e3,r.maxWait<1)return Promise.reject(new m("timeout",eW.InvalidOption));let i=new z;function o(e){i.push(()=>{i.stop(e)})}function a(e,t){e||null===t?o(null===e?void 0:e):i.push(t)}if(r.noMux){let n=s?Error().stack:null,h="number"==typeof r.maxMessages&&r.maxMessages>0?r.maxMessages:-1,c=this.subscribe(y(this.options.inboxPrefix),{callback:(e,t)=>{if(t?.data?.length===0&&t?.headers?.status===eW.NoResponders&&(e=m.errorForCode(eW.NoResponders)),e){n&&(e.stack+=`

${n}`),l(e);return}a(null,t),r.strategy===eX.Count&&0==--h&&l(),r.strategy===eX.JitterTimer&&(d(),u=setTimeout(()=>{l()},300)),r.strategy===eX.SentinelMsg&&t&&0===t.data.length&&l()}});c.requestSubject=e,c.closed.then(()=>{o()}).catch(e=>{i.stop(e)});let l=e=>{e&&i.push(()=>{throw e}),d(),c.drain().then(()=>{o()}).catch(e=>{o()})};i.iterClosed.then(()=>{d(),c?.unsubscribe()}).catch(e=>{d(),c?.unsubscribe()});try{this.publish(e,t,{reply:c.getSubject()})}catch(e){l(e)}let u=setTimeout(()=>{l()},r.maxWait),d=()=>{u&&clearTimeout(u)}}else{r.callback=a,i.iterClosed.then(()=>{s.cancel()}).catch(e=>{s.cancel(e)});let s=new t_(this.protocol.muxSubscriptions,e,r);this.protocol.request(s);try{this.publish(e,t,{reply:`${this.protocol.muxSubscriptions.baseInbox}${s.token}`,headers:r.headers})}catch(e){s.cancel(e)}}return Promise.resolve(i)}request(e,t,r={timeout:1e3,noMux:!1}){try{this._check(e,!0,!0)}catch(e){return Promise.reject(e)}let s=!this.protocol.options.noAsyncTraces;if(r.timeout=r.timeout||1e3,r.timeout<1)return Promise.reject(new m("timeout",eW.InvalidOption));if(!r.noMux&&r.reply)return Promise.reject(new m("reply can only be used with noMux",eW.InvalidOption));if(r.noMux){let i=r.reply?r.reply:y(this.options.inboxPrefix),n=P(),o=s?Error():null,a=this.subscribe(i,{max:1,timeout:r.timeout,callback:(e,t)=>{e?(o&&e.code!==eW.Timeout&&(e.stack+=`

${o.stack}`),a.unsubscribe(),n.reject(e)):(e=$(t))?(o&&(e.stack+=`

${o.stack}`),n.reject(e)):n.resolve(t)}});return a.requestSubject=e,this.protocol.publish(e,t,{reply:i,headers:r.headers}),n}{let i=new ty(this.protocol.muxSubscriptions,e,r,s);this.protocol.request(i);try{this.publish(e,t,{reply:`${this.protocol.muxSubscriptions.baseInbox}${i.token}`,headers:r.headers})}catch(e){i.cancel(e)}let n=Promise.race([i.timer,i.deferred]);return n.catch(()=>{i.cancel()}),n}}flush(){return this.isClosed()?Promise.reject(m.errorForCode(eW.ConnectionClosed)):this.protocol.flush()}drain(){return this.isClosed()?Promise.reject(m.errorForCode(eW.ConnectionClosed)):this.isDraining()?Promise.reject(m.errorForCode(eW.ConnectionDraining)):(this.draining=!0,this.protocol.drain())}isClosed(){return this.protocol.isClosed()}isDraining(){return this.draining}getServer(){let e=this.protocol.getServer();return e?e.listen:""}status(){let e=new z;return e.iterClosed.then(()=>{let t=this.listeners.indexOf(e);this.listeners.splice(t,1)}),this.listeners.push(e),e}get info(){return this.protocol.isClosed()?void 0:this.protocol.info}async context(){return(await this.request("$SYS.REQ.USER.INFO")).json((e,t)=>"time"===e?new Date(Date.parse(t)):t)}stats(){return{inBytes:this.protocol.inBytes,outBytes:this.protocol.outBytes,inMsgs:this.protocol.inMsgs,outMsgs:this.protocol.outMsgs}}async jetstreamManager(e={}){let t=new rL(this,e);if(!1!==e.checkAPI)try{await t.getAccountInfo()}catch(e){throw e.code===eW.NoResponders&&(e.code=eW.JetStreamNotEnabled),e}return t}jetstream(e={}){return new rG(this,e)}getServerVersion(){let e=this.info;return e?tv(e.version):void 0}async rtt(){if(!this.protocol._closed&&!this.protocol.connected)throw m.errorForCode(eW.Disconnect);let e=Date.now();return await this.flush(),Date.now()-e}get features(){return this.protocol.features}get services(){return this._services||(this._services=new rW(this)),this._services}reconnect(){return this.isClosed()?Promise.reject(m.errorForCode(eW.ConnectionClosed)):this.isDraining()?Promise.reject(m.errorForCode(eW.ConnectionDraining)):this.protocol.reconnect()}}class rW{nc;constructor(e){this.nc=e}add(e){try{return new ro(this.nc,e).start()}catch(e){return Promise.reject(e)}}client(e,t){return new rh(this.nc,e,t)}}class rY{bucket;sm;prefixLen;constructor(e,t,r){this.bucket=e,this.prefixLen=t,this.sm=r}get key(){return this.sm.subject.substring(this.prefixLen)}get value(){return this.sm.data}get delta(){return 0}get created(){return this.sm.time}get revision(){return this.sm.seq}get operation(){return this.sm.header.get(rl)||"PUT"}get length(){let e=this.sm.header.get(te.MessageSizeHdr)||"";return""!==e?parseInt(e,10):this.sm.data.length}json(){return this.sm.json()}string(){return this.sm.string()}}class rX{bucket;key;sm;constructor(e,t,r){this.bucket=e,this.key=t,this.sm=r}get value(){return this.sm.data}get created(){return new Date(C(this.sm.info.timestampNanos))}get revision(){return this.sm.seq}get operation(){return this.sm.headers?.get(rl)||"PUT"}get delta(){return this.sm.info.pending}get length(){let e=this.sm.headers?.get(te.MessageSizeHdr)||"";return""!==e?parseInt(e,10):this.sm.data.length}json(){return this.sm.json()}string(){return this.sm.string()}}class rZ extends tk{js;monitor;constructor(e,t,r){super(e.nc,t,r),this.js=e,this.monitor=null,this.sub.closed.then(()=>{this.monitor&&this.monitor.cancel()})}set info(e){this.sub.info=e}get info(){return this.sub.info}_resetOrderedConsumer(e){if(null===this.info||this.sub.isClosed())return;let t=y(this.js.nc.options.inboxPrefix);this.js.nc._resub(this.sub,t);let r=this.info;r.config.name=d.next(),r.ordered_consumer_sequence.delivery_seq=0,r.flow_control.heartbeat_count=0,r.flow_control.fc_count=0,r.flow_control.consumer_restarts++,r.deliver=t,r.config.deliver_subject=t,r.config.deliver_policy=e5.StartSequence,r.config.opt_start_seq=e;let s={};s.stream_name=this.info.stream,s.config=r.config;let i=`${r.api.prefix}.CONSUMER.CREATE.${r.stream}`;this.js._request(i,s,{retries:-1}).then(e=>{this.sub.info.last=e,this.info.config=e.config,this.info.name=e.name}).catch(t=>{let s=new m(`unable to recreate ordered consumer ${r.stream} at seq ${e}`,eW.RequestError,t);this.sub.callback(s,{})})}_maybeSetupHbMonitoring(){let e=this.info?.config?.idle_heartbeat||0;e&&this._setupHbMonitoring(C(e))}_setupHbMonitoring(e,t=0){let r={cancelAfter:0,maxOut:2};t&&(r.cancelAfter=t);let s=this.sub;this.monitor=new G(e,e=>{let t=function(e,t,r){let s=I(409,t),i=new U({hdr:1,sid:0,size:0},n,{});return i._headers=s,i._subject=r,i}(0,`${e0.IdleHeartbeatMissed}: ${e}`,this.sub.subject);if(this.info?.ordered){if(!this.js.nc.protocol.connected)return!1;let e=this.info?.ordered_consumer_sequence?.stream_seq||0;return this._resetOrderedConsumer(e+1),this.monitor?.restart(),!1}return this.sub.callback(null,t),!s.noIterator},r)}_checkHbOrderConsumer(e){let t=e.headers.get(te.ConsumerStalledHdr);""!==t&&this.js.nc.publish(t);let r=parseInt(e.headers.get(te.LastConsumerSeqHdr),10),s=this.info.ordered_consumer_sequence;return this.info.flow_control.heartbeat_count++,r!==s.delivery_seq&&this._resetOrderedConsumer(s.stream_seq+1),!1}_checkOrderedConsumer(e){let t=this.info.ordered_consumer_sequence,r=e.info.streamSequence,s=e.info.deliverySequence;return s!=t.delivery_seq+1?(this._resetOrderedConsumer(t.stream_seq+1),!1):(t.delivery_seq=s,t.stream_seq=r,!0)}async destroy(){this.isClosed()||await this.drain();let e=this.sub.info,t=e.config.durable_name||e.name,r=`${e.api.prefix}.CONSUMER.DELETE.${e.stream}.${t}`;await e.api._request(r)}async consumerInfo(){let e=this.sub.info,t=e.config.durable_name||e.name,r=`${e.api.prefix}.CONSUMER.INFO.${e.stream}.${t}`,s=await e.api._request(r);return e.last=s,s}}class rQ extends rZ{constructor(e,t,r){super(e,t,r)}pull(e={batch:1}){let{stream:t,config:r,name:s}=this.sub.info,i=r.durable_name??s,n={};if(n.batch=e.batch||1,n.no_wait=e.no_wait||!1,(e.max_bytes??0)>0){let t=this.js.nc.features.get(eN.JS_PULL_MAX_BYTES);if(!t.ok)throw Error(`max_bytes is only supported on servers ${t.min} or better`);n.max_bytes=e.max_bytes}let o=0;e.expires&&e.expires>0&&(o=e.expires,n.expires=O(o));let a=0;if(e.idle_heartbeat&&e.idle_heartbeat>0&&(a=e.idle_heartbeat,n.idle_heartbeat=O(a)),a&&0===o)throw Error("idle_heartbeat requires expires");if(a>o)throw Error("expires must be greater than idle_heartbeat");if(this.info){this.monitor&&this.monitor.cancel(),o&&a&&(this.monitor?this.monitor._change(a,o):this._setupHbMonitoring(a,o));let e=this.info.api,r=`${e.prefix}.CONSUMER.MSG.NEXT.${t}.${i}`,s=this.sub.subject;e.nc.publish(r,e.jc.encode(n),{reply:s})}}}function r0(e){if(null!==e)switch(e.code){case eW.JetStream404NoMessages:case eW.JetStream408RequestTimeout:break;case eW.JetStream409:if(e.code===eW.JetStream409&&void 0!==[e0.MaxBatchExceeded,e0.MaxExpiresExceeded,e0.MaxBytesExceeded,e0.MaxMessageSizeExceeded,e0.PushConsumer,e0.IdleHeartbeatMissed,e0.ConsumerDeleted].find(t=>-1!==e.message.indexOf(t)))return e;break;default:return e}return null}function r1(e){e&&e.ack()}class r2{msg;di;didAck;timeout;constructor(e,t){this.msg=e,this.didAck=!1,this.timeout=t}get subject(){return this.msg.subject}get sid(){return this.msg.sid}get data(){return this.msg.data}get headers(){return this.msg.headers}get info(){return this.di||(this.di=function(e){let t=e.split(".");if(9===t.length&&t.splice(2,0,"_",""),t.length<11||"$JS"!==t[0]||"ACK"!==t[1])throw Error("not js message");let r={};return r.domain="_"===t[2]?"":t[2],r.account_hash=t[3],r.stream=t[4],r.consumer=t[5],r.deliveryCount=parseInt(t[6],10),r.redeliveryCount=r.deliveryCount,r.redelivered=r.deliveryCount>1,r.streamSequence=parseInt(t[7],10),r.deliverySequence=parseInt(t[8],10),r.timestampNanos=parseInt(t[9],10),r.pending=parseInt(t[10],10),r}(this.reply)),this.di}get redelivered(){return this.info.deliveryCount>1}get reply(){return this.msg.reply||""}get seq(){return this.info.streamSequence}doAck(e){this.didAck||(this.didAck=!this.isWIP(e),this.msg.respond(e))}isWIP(e){return 4===e.length&&e[0]===rA[0]&&e[1]===rA[1]&&e[2]===rA[2]&&e[3]===rA[3]}async ackAck(e){(e=e||{}).timeout=e.timeout||this.timeout;let t=P();if(this.didAck)t.resolve(!1);else if(this.didAck=!0,this.msg.reply){let r=this.msg.publisher,s=!r.options?.noAsyncTraces,i=new ty(r.muxSubscriptions,this.msg.reply,{timeout:e.timeout},s);r.request(i);try{r.publish(this.msg.reply,rx,{reply:`${r.muxSubscriptions.baseInbox}${i.token}`})}catch(e){i.cancel(e)}try{await Promise.race([i.timer,i.deferred]),t.resolve(!0)}catch(e){i.cancel(e),t.reject(e)}}else t.resolve(!1);return t}ack(){this.doAck(rx)}nak(e){let t=rP;e&&(t=R().encode(`-NAK ${JSON.stringify({delay:O(e)})}`)),this.doAck(t)}working(){this.doAck(rA)}next(e,t={batch:1}){let r={};r.batch=t.batch||1,r.no_wait=t.no_wait||!1,t.expires&&t.expires>0&&(r.expires=O(t.expires));let s=T().encode(r),i=Q.concat(rk,rC,s);this.msg.respond(i,e?{reply:e}:void 0)}term(e=""){let t=rO;e?.length>0&&(t=R().encode(`+TERM ${e}`)),this.doAck(t)}json(){return this.msg.json()}string(){return this.msg.string()}}class r3{version;lang;closeError;connected;done;socket;options;socketClosed;encrypted;peeked;yields;signal;closedNotification;constructor(){this.version="1.30.3",this.lang="nats.ws",this.connected=!1,this.done=!1,this.socketClosed=!1,this.encrypted=!1,this.peeked=!1,this.yields=[],this.signal=P(),this.closedNotification=P()}async connect(e,t){let r=P();if(t.tls)return r.reject(new m("tls",eW.InvalidOption)),r;this.options=t;let s=e.src;if(t.wsFactory){let{socket:r,encrypted:s}=await t.wsFactory(e.src,t);this.socket=r,this.encrypted=s}else this.encrypted=0===s.indexOf("wss://"),this.socket=new WebSocket(s);return this.socket.binaryType="arraybuffer",this.socket.onopen=()=>{if(this.isDiscarded())return},this.socket.onmessage=e=>{if(this.isDiscarded())return;if(this.yields.push(new Uint8Array(e.data)),this.peeked){this.signal.resolve();return}let s=Q.concat(...this.yields),i=function(e){let t=function(e){for(let t=0;t<e.length;t++){let r=t+1;if(e.byteLength>r&&e[t]===tN&&e[r]===tM)return r+1}return 0}(e);if(t>0){let r=new Uint8Array(e).slice(0,t);return a.decode(r)}return""}(s);if(""!==i){let e=t8.exec(i);if(!e){t.debug&&console.error("!!!",v(s)),r.reject(Error("unexpected response from server"));return}try{let t=JSON.parse(e[1]);(function(e,t){let{proto:r,tls_required:s,tls_available:i}=e;if((void 0===r||r<1)&&t.noEcho)throw new m("noEcho",eW.ServerOptionNotAvailable);if(t.tls&&!(s||i))throw new m("tls",eW.ServerOptionNotAvailable)})(t,this.options),this.peeked=!0,this.connected=!0,this.signal.resolve(),r.resolve()}catch(e){r.reject(e);return}}},this.socket.onclose=e=>{let t;!this.isDiscarded()&&(this.socketClosed=!0,this.done||(e.wasClean||(t=Error(e.reason)),this._closed(t)))},this.socket.onerror=e=>{if(this.isDiscarded())return;let t=new m(e.message,eW.Unknown,Error(e.error));r.reject(t)},r}disconnect(){this._closed(void 0,!0)}async _closed(e,t=!0){if(!this.isDiscarded()&&this.connected&&!this.done){if(this.closeError=e,!e)for(;!this.socketClosed&&this.socket.bufferedAmount>0;)await x(100);this.done=!0;try{this.socket.close(e?1002:1e3,e?e.message:void 0)}catch(e){}t&&this.closedNotification.resolve(e)}}get isClosed(){return this.done}[Symbol.asyncIterator](){return this.iterate()}async *iterate(){for(;;){if(this.isDiscarded())return;0===this.yields.length&&await this.signal;let e=this.yields;this.yields=[];for(let t=0;t<e.length;t++)this.options.debug&&console.info(`> ${v(e[t])}`),yield e[t];if(this.done)break;0===this.yields.length&&(e.length=0,this.yields=e,this.signal=P())}}isEncrypted(){return this.connected&&this.encrypted}send(e){if(!this.isDiscarded())try{this.socket.send(e.buffer),this.options.debug&&console.info(`< ${v(e)}`);return}catch(t){this.options.debug&&console.error(`!!! ${v(e)}: ${t}`)}}close(e){return this._closed(e,!1)}closed(){return this.closedNotification}isDiscarded(){return!!this.done&&(this.discard(),!0)}discard(){this.done=!0;try{this.socket?.close()}catch(e){}}}function r5(e,t){let r,s;/^(.*:\/\/)(.*)/.test(e)||(e="boolean"==typeof t?`${!0===t?"https":"http"}://${e}`:`https://${e}`);let i=new URL(e),n=i.protocol.toLowerCase();"ws:"===n&&(t=!1),"wss:"===n&&(t=!0),"https:"!==n&&"http"!==n&&(e=e.replace(/^(.*:\/\/)(.*)/gm,"$2"),i=new URL(`http://${e}`));let o=i.hostname,a=i.pathname,h=i.search||"";switch(n){case"http:":case"ws:":case"nats:":s=i.port||"80",r="ws:";break;case"https:":case"wss:":case"tls:":s=i.port||"443",r="wss:";break;default:s=i.port||!0===t?"443":"80",r=!0===t?"wss:":"ws:"}return`${r}//${o}:${s}${a}${h}`}function r4(e={}){return s={defaultPort:443,urlParseFn:r5,factory:()=>new r3},rV.connect(e)}}}]);