# NATS Server Configuration for Home Automation (Cloud-Connected)
# This configuration supports both local operation and Synadia Cloud connection

# Server identification
server_name: $NATS_SERVER_NAME
port: 4222

# HTTP monitoring
http_port: 8222

# WebSocket configuration
websocket {
  port: 9222
  no_tls: true  # Will enable TLS in production
  compression: true
}

# Authorization - Transition phase supports both basic auth and JWT
authorization {
  # Basic auth for backward compatibility during migration
  users = [
    {
      user: "home"
      password: "changeme"
      permissions: {
        publish: {
          allow: ["home.>", "_INBOX.>", "$JS.>", "$KV.>"]
        }
        subscribe: {
          allow: ["home.>", "_INBOX.>", "$JS.>", "$KV.>"]
        }
      }
    },
    {
      user: "admin"
      password: "admin"
      permissions: {
        publish: ">"
        subscribe: ">"
      }
    }
  ]
  
  # JWT resolver will be enabled when credentials are available
  # resolver: {
  #   type: full
  #   dir: "/data/jwt"
  # }
}

# Leaf node configuration for Synadia Cloud connection
leafnodes {
  # Reconnect interval
  reconnect: 10s
  
  # TLS configuration for leaf connections
  # tls {
  #   cert_file: "/certs/leaf-cert.pem"
  #   key_file: "/certs/leaf-key.pem"
  #   ca_file: "/certs/ca.pem"
  # }
  
  # Synadia Cloud connection (will be enabled when credentials are available)
  # remotes = [
  #   {
  #     url: "tls://connect.ngs.global"
  #     credentials: "/creds/leaf.creds"
  #     account: $LEAF_ACCOUNT
  #   }
  # ]
}

# JetStream configuration
jetstream {
  enabled: true
  store_dir: "/data/jetstream"
  max_memory_store: 512MB
  max_file_store: 2GB
  
  # Domain for JetStream - will help with cloud federation
  domain: $JETSTREAM_DOMAIN
}

# Cluster configuration (for future HA setup)
# cluster {
#   name: "home-automation-cluster"
#   port: 6222
#   
#   routes = [
#     nats://nats-2:6222
#     nats://nats-3:6222
#   ]
# }

# System account for internal operations
system_account: $SYS

# Accounts configuration for multi-tenancy
accounts {
  # System account
  $SYS: {
    users: [
      {user: "sys", password: "syspwd"}
    ]
  }
  
  # Home account (will be replaced with JWT)
  HOME: {
    jetstream: enabled
    users: [
      {user: "home", password: "changeme"}
    ]
  }
}

# Logging configuration
debug: false
trace: false
logtime: true
log_file: "/data/logs/nats.log"

# Connection limits
max_connections: 2048
max_control_line: 4KB
max_payload: 1MB
max_pending: 64MB

# Timeouts
ping_interval: "2m"
ping_max: 2
write_deadline: "10s"

# Enable monitoring endpoints
# monitor_port: 8222